<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amretha's AI Job Hunt Command Centre</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Fraunces:ital,wght@0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #0d1b3e;
  --blue: #1a56db;
  --blue-light: #3b82f6;
  --blue-pale: #eff6ff;
  --blue-mid: #dbeafe;
  --accent: #0ea5e9;
  --accent2: #06b6d4;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --purple: #8b5cf6;
  --white: #ffffff;
  --gray-50: #f8fafc;
  --gray-100: #f1f5f9;
  --gray-200: #e2e8f0;
  --gray-300: #cbd5e1;
  --gray-400: #94a3b8;
  --gray-500: #64748b;
  --gray-600: #475569;
  --gray-700: #334155;
  --gray-800: #1e293b;
  --shadow: 0 4px 24px rgba(13,27,62,0.10);
  --shadow-lg: 0 8px 40px rgba(13,27,62,0.16);
  --radius: 14px;
  --radius-sm: 8px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: linear-gradient(180deg, var(--gray-50) 0%, #eef2ff 100%);
  color: var(--gray-800);
  min-height: 100vh;
  font-size: 14px;
}

/* HEADER */
.app-header {
  background: linear-gradient(135deg, var(--navy) 0%, #1a3a6e 60%, #1a56db 100%);
  padding: 0 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 64px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 20px rgba(13,27,62,0.3);
}
.header-brand { display: flex; align-items: center; gap: 12px; }
.header-logo {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--accent), var(--blue-light));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 800; color: white;
  font-family: 'Fraunces', serif;
}
.header-title { color: white; font-size: 16px; font-weight: 700; }
.header-sub { color: rgba(255,255,255,0.6); font-size: 11px; margin-top: 1px; }

/* DAILY GOAL BAR */
.daily-goal-bar {
  background: linear-gradient(90deg, #1e3a8a, #1a56db);
  padding: 8px 28px;
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}
.goal-label { color: rgba(255,255,255,0.8); font-size: 12px; font-weight: 500; white-space: nowrap; }
.goal-progress-wrap { flex: 1; min-width: 150px; display: flex; align-items: center; gap: 10px; }
.goal-bar-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.2); border-radius: 99px; overflow: hidden; }
.goal-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 99px; transition: width 0.5s ease; }
.goal-text { color: white; font-size: 12px; font-weight: 600; white-space: nowrap; }
.streak-badge { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); border-radius: 99px; padding: 3px 12px; color: white; font-size: 11px; font-weight: 600; white-space: nowrap; }
.goal-input-wrap { display: flex; align-items: center; gap: 6px; }
.goal-input-wrap label { color: rgba(255,255,255,0.7); font-size: 11px; }
.goal-num-input { width: 44px; padding: 3px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 12px; font-weight: 600; text-align: center; outline: none; }

/* TABS */
.tab-nav {
  background: var(--white);
  border-bottom: 2px solid var(--gray-100);
  display: flex;
  gap: 0;
  padding: 0 28px;
  overflow-x: auto;
  scrollbar-width: none;
}
.tab-nav::-webkit-scrollbar { display: none; }
.tab-btn {
  padding: 14px 20px;
  border: none;
  background: none;
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-500);
  white-space: nowrap;
  border-bottom: 3px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 7px;
}
.tab-btn:hover { color: var(--blue); }
.tab-btn.active { color: var(--blue); border-bottom-color: var(--blue); }
.tab-icon { font-size: 15px; }

/* MAIN CONTENT */
.tab-content { display: none; padding: 28px; max-width: 1400px; margin: 0 auto; }
.tab-content.active { display: block; }

/* CARDS & PANELS */
.card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--gray-100);
}
.card-title {
  font-family: 'Fraunces', serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--navy);
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.section-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--gray-400);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 8px;
}

/* FORM ELEMENTS */
.form-group { margin-bottom: 16px; }
.form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--gray-600); margin-bottom: 6px; }
.form-control {
  width: 100%;
  padding: 10px 14px;
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 13px;
  color: var(--gray-800);
  background: var(--gray-50);
  transition: all 0.2s;
  outline: none;
}
.form-control:focus { border-color: var(--blue); background: white; box-shadow: 0 0 0 3px rgba(26,86,219,0.1); }
textarea.form-control { resize: vertical; min-height: 120px; line-height: 1.5; }
select.form-control { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; cursor: pointer; }

/* BUTTONS */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn-primary { background: linear-gradient(135deg, var(--blue), var(--accent)); color: white; box-shadow: 0 4px 12px rgba(26,86,219,0.3); }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(26,86,219,0.4); }
.btn-primary:active { transform: translateY(0); }
.btn-secondary { background: var(--blue-pale); color: var(--blue); border: 1.5px solid var(--blue-mid); }
.btn-secondary:hover { background: var(--blue-mid); }
.btn-success { background: linear-gradient(135deg, #059669, var(--success)); color: white; box-shadow: 0 4px 12px rgba(16,185,129,0.25); }
.btn-success:hover { transform: translateY(-1px); }
.btn-warning { background: linear-gradient(135deg, #d97706, var(--warning)); color: white; }
.btn-danger { background: linear-gradient(135deg, #dc2626, var(--danger)); color: white; }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-xs { padding: 4px 9px; font-size: 11px; border-radius: 6px; }
.btn-ghost { background: transparent; color: var(--gray-600); border: 1.5px solid var(--gray-200); }
.btn-ghost:hover { background: var(--gray-100); }
.btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }

/* OUTPUT AREAS */
.output-area {
  background: var(--gray-50);
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius-sm);
  padding: 16px;
  min-height: 80px;
  font-size: 13px;
  line-height: 1.7;
  color: var(--gray-700);
  white-space: pre-wrap;
  word-break: break-word;
}
.output-placeholder { color: var(--gray-400); font-style: italic; }

/* SCORE BADGE */
.score-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 99px;
  font-size: 13px;
  font-weight: 700;
}
.score-high { background: #dcfce7; color: #166534; }
.score-mid { background: #fef9c3; color: #854d0e; }
.score-low { background: #fee2e2; color: #991b1b; }

/* KEYWORD CHIPS */
.keyword-chip {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 600;
  margin: 3px;
}
.chip-found { background: #dcfce7; color: #166534; }
.chip-missing { background: #fee2e2; color: #991b1b; }

/* LOADING SPINNER */
.spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2.5px solid rgba(255,255,255,0.4);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
.spinner-blue {
  border-color: rgba(26,86,219,0.2);
  border-top-color: var(--blue);
}
@keyframes spin { to { transform: rotate(360deg); } }

/* GRID LAYOUTS */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
.grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; }
.grid-half { display: grid; grid-template-columns: 1fr 1.5fr; gap: 24px; }
.flex-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.flex-between { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }

/* STAT CARDS */
.stat-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 18px 20px;
  box-shadow: var(--shadow);
  border: 1px solid var(--gray-100);
  position: relative;
  overflow: hidden;
}
.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}
.stat-card.blue::before { background: linear-gradient(90deg, var(--blue), var(--accent)); }
.stat-card.green::before { background: linear-gradient(90deg, #059669, var(--success)); }
.stat-card.amber::before { background: linear-gradient(90deg, #d97706, var(--warning)); }
.stat-card.purple::before { background: linear-gradient(90deg, #7c3aed, var(--purple)); }
.stat-card.red::before { background: linear-gradient(90deg, #dc2626, var(--danger)); }
.stat-value { font-size: 28px; font-weight: 800; color: var(--navy); line-height: 1; margin: 4px 0; }
.stat-label { font-size: 11px; font-weight: 600; color: var(--gray-400); text-transform: uppercase; letter-spacing: 0.06em; }
.stat-icon { font-size: 28px; position: absolute; right: 16px; top: 14px; opacity: 0.15; }

/* ============ TAB 2 ‚Äî AI INTERVIEW PREP ============ */
.star-card {
  background: var(--blue-pale);
  border: 1.5px solid var(--blue-mid);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  margin-bottom: 12px;
}
.star-q { font-weight: 700; color: var(--navy); margin-bottom: 8px; font-size: 13px; }
.star-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-right: 4px; margin-bottom: 6px; }
.tag-s { background: #dbeafe; color: #1e40af; }
.tag-t { background: #dcfce7; color: #166534; }
.tag-a { background: #fef3c7; color: #92400e; }
.tag-r { background: #ede9fe; color: #5b21b6; }
.star-body { font-size: 12.5px; line-height: 1.6; color: var(--gray-700); }

/* Interview Chat Messages */
.chat-msg { display:flex; gap:12px; margin-bottom:16px; animation: msgFadeIn 0.3s ease; }
.chat-msg.ai { flex-direction:row; }
.chat-msg.user { flex-direction:row-reverse; }
.chat-avatar { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
.chat-msg.ai .chat-avatar { background:var(--blue-pale); }
.chat-msg.user .chat-avatar { background:#ede9fe; }
.chat-bubble { max-width:75%; padding:12px 16px; border-radius:14px; font-size:13px; line-height:1.65; }
.chat-msg.ai .chat-bubble { background:white; border:1px solid var(--gray-200); border-top-left-radius:4px; color:var(--gray-700); }
.chat-msg.user .chat-bubble { background:var(--blue); color:white; border-top-right-radius:4px; }
.chat-bubble .score-inline { display:inline-block; padding:2px 8px; border-radius:6px; font-size:11px; font-weight:700; margin-left:6px; }
.score-good { background:#dcfce7; color:#166534; }
.score-ok { background:#fef3c7; color:#92400e; }
.score-weak { background:#fee2e2; color:#991b1b; }
@keyframes msgFadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

/* Voice waveform animation */
.voice-bar { width:4px; border-radius:2px; background:var(--blue); animation: voicePulse 0.6s ease-in-out infinite alternate; }
.voice-bar:nth-child(1) { height:12px; animation-delay:0s; }
.voice-bar:nth-child(2) { height:20px; animation-delay:0.1s; }
.voice-bar:nth-child(3) { height:28px; animation-delay:0.2s; }
.voice-bar:nth-child(4) { height:36px; animation-delay:0.15s; }
.voice-bar:nth-child(5) { height:24px; animation-delay:0.25s; }
.voice-bar:nth-child(6) { height:32px; animation-delay:0.1s; }
.voice-bar:nth-child(7) { height:18px; animation-delay:0.3s; }
.voice-bar:nth-child(8) { height:26px; animation-delay:0.05s; }
.voice-bar:nth-child(9) { height:14px; animation-delay:0.2s; }
@keyframes voicePulse { 0% { transform:scaleY(0.4); opacity:0.5; } 100% { transform:scaleY(1); opacity:1; } }

/* ============ TAB 3 ‚Äî JOB LIST VIEW ============ */
.tracker-layout { display: grid; grid-template-columns: 1fr 220px; gap: 20px; }

/* Stage group header */
.stage-group { margin-bottom: 20px; }
.stage-group-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 14px;
  border-radius: var(--radius-sm);
  margin-bottom: 6px;
  cursor: pointer;
  user-select: none;
}
.stage-group-header:hover { filter: brightness(0.96); }
.stage-group-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; }
.stage-group-count {
  background: rgba(0,0,0,0.12);
  border-radius: 99px;
  padding: 1px 8px;
  font-size: 11px;
  font-weight: 700;
  color: inherit;
}
.stage-group-toggle { margin-left: auto; font-size: 13px; transition: transform 0.2s; }
.stage-group.collapsed .stage-group-toggle { transform: rotate(-90deg); }
.stage-group.collapsed .stage-rows { display: none; }

/* List rows */
.stage-rows { border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); overflow: hidden; }
.job-row {
  display: grid;
  grid-template-columns: 2fr 2fr 90px 110px auto;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  background: var(--white);
  border-bottom: 1px solid var(--gray-100);
  transition: background 0.15s;
  font-size: 13px;
}
.job-row:last-child { border-bottom: none; }
.job-row:hover { background: var(--gray-50); }
.job-row.demo-row { background: #fffbeb; }

.job-row-company { font-weight: 700; color: var(--navy); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.job-row-role { color: var(--gray-500); font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* Keep badge styles */
.meta-badge {
  padding: 2px 8px;
  border-radius: 99px;
  font-size: 10px;
  font-weight: 700;
}
.badge-high { background: #fee2e2; color: #991b1b; }
.badge-medium { background: #fef9c3; color: #854d0e; }
.badge-low { background: #dcfce7; color: #166534; }
.badge-salary { background: var(--blue-pale); color: var(--blue); }
.badge-days { background: var(--gray-100); color: var(--gray-600); }
.badge-followup { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
.job-row-actions { display: flex; gap: 4px; align-items: center; }

/* Table header row */
.job-list-header {
  display: grid;
  grid-template-columns: 2fr 2fr 90px 110px auto;
  gap: 12px;
  padding: 8px 14px;
  background: var(--gray-50);
  border: 1.5px solid var(--gray-200);
  border-bottom: none;
  border-radius: var(--radius-sm) var(--radius-sm) 0 0;
  font-size: 11px;
  font-weight: 700;
  color: var(--gray-400);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

/* FOLLOWUP SIDEBAR */
.followup-sidebar .card { padding: 16px; }
.followup-item { padding: 10px; background: #fff7ed; border: 1px solid #fed7aa; border-radius: 8px; margin-bottom: 8px; }
.followup-company { font-weight: 700; font-size: 12px; color: var(--navy); }
.followup-role { font-size: 11px; color: var(--gray-500); }
.followup-days { font-size: 11px; font-weight: 700; color: #c2410c; margin-top: 3px; }

/* ANALYTICS */
.analytics-section { margin-top: 24px; }
.funnel-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.funnel-label { font-size: 12px; font-weight: 600; color: var(--gray-600); width: 100px; text-align: right; }
.funnel-track { flex: 1; height: 22px; background: var(--gray-100); border-radius: 99px; overflow: hidden; }
.funnel-fill { height: 100%; border-radius: 99px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 11px; font-weight: 700; color: white; }
.chart-bars { display: flex; align-items: flex-end; gap: 6px; height: 80px; }
.chart-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
.chart-bar { width: 100%; background: linear-gradient(180deg, var(--blue-light), var(--blue)); border-radius: 4px 4px 0 0; min-height: 4px; }
.chart-bar-label { font-size: 10px; color: var(--gray-400); }

/* MODALS */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(13,27,62,0.5);
  backdrop-filter: blur(4px);
  z-index: 999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal {
  background: white;
  border-radius: var(--radius);
  padding: 28px;
  width: 100%;
  max-width: 560px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  position: relative;
}
.modal-lg { max-width: 900px; }
.modal-title { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 700; color: var(--navy); margin-bottom: 20px; }
.modal-close {
  position: absolute; top: 16px; right: 16px;
  background: var(--gray-100); border: none; border-radius: 50%;
  width: 30px; height: 30px; cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center; color: var(--gray-500);
}
.modal-close:hover { background: var(--gray-200); }

/* CHECKLIST */
.checklist-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--gray-100); }
.checklist-item:last-child { border-bottom: none; }
.checklist-item input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--blue); cursor: pointer; }
.checklist-item label { font-size: 13px; color: var(--gray-700); cursor: pointer; }
.checklist-item.done label { text-decoration: line-through; color: var(--gray-400); }

/* TAB 4 ‚Äî AUTO APPLY / COMMAND CENTRE */
.company-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
.company-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 99px;
  background: var(--blue-pale);
  border: 1.5px solid var(--blue-mid);
  color: var(--blue);
  font-size: 12px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s;
  cursor: pointer;
}
.company-chip:hover { background: var(--blue); color: white; border-color: var(--blue); }
.job-board-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  border: 1.5px solid var(--gray-200);
  background: var(--white);
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-700);
  transition: all 0.2s;
  text-decoration: none;
}
.job-board-btn:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-pale); }
.boards-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap: 10px; margin-top: 12px; }
.three-panels { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.panel-box { border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); display: flex; flex-direction: column; }
.panel-header { padding: 12px 14px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); border-radius: var(--radius-sm) var(--radius-sm) 0 0; font-weight: 700; font-size: 13px; color: var(--navy); }
.panel-body { padding: 14px; flex: 1; font-size: 12px; line-height: 1.6; color: var(--gray-700); white-space: pre-wrap; }
.panel-footer { padding: 10px 14px; border-top: 1px solid var(--gray-200); display: flex; gap: 8px; }

/* TAB 6 ‚Äî JOB DISCOVERY */
.discovery-card { background: var(--white); border-radius: var(--radius); padding: 20px; border: 1.5px solid var(--gray-200); transition: all 0.25s ease; position: relative; overflow: hidden; }
.discovery-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--blue-light)); opacity: 0; transition: opacity 0.25s; }
.discovery-card:hover { border-color: var(--blue-light); box-shadow: var(--shadow); transform: translateY(-2px); }
.discovery-card:hover::before { opacity: 1; }
.discovery-platform { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; }
.platform-indeed { background: #e0f2fe; color: #0369a1; }
.platform-jobstreet { background: #fce7f3; color: #be185d; }
.platform-workable { background: #ecfdf5; color: #047857; }

/* FADE-IN ANIMATION */
@keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
.tab-content.active { animation: fadeInUp 0.3s ease-out; }

/* CARD HOVER ENHANCEMENT */
.card { transition: box-shadow 0.25s ease, transform 0.25s ease; }
.card:hover { box-shadow: var(--shadow-lg); }

/* BUTTON PULSE (for primary actions) */
@keyframes subtlePulse { 0%, 100% { box-shadow: 0 4px 12px rgba(26,86,219,0.3); } 50% { box-shadow: 0 4px 20px rgba(26,86,219,0.45); } }
.btn-primary:not(:disabled) { animation: subtlePulse 3s ease-in-out infinite; }
.btn-primary:hover { animation: none; }

/* PROGRESS LOG STYLING */
.progress-log { font-family: 'Fira Code', 'Consolas', monospace; font-size: 12px; background: var(--gray-800); color: #a5f3fc; border-radius: var(--radius-sm); padding: 14px; max-height: 200px; overflow-y: auto; line-height: 1.8; }

/* BULK APPLY MODAL ENHANCEMENT */
.bulk-job-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: var(--radius-sm); border: 1px solid var(--gray-200); margin-bottom: 6px; transition: background 0.15s; }
.bulk-job-item:hover { background: var(--blue-pale); }
.bulk-job-item input[type=checkbox] { accent-color: var(--blue); width: 16px; height: 16px; }

/* RESPONSIVE */
@media (max-width: 900px) {
  .t1-layout, .grid-2, .grid-3, .grid-4, .three-panels { grid-template-columns: 1fr; }
  .tracker-layout { grid-template-columns: 1fr; }
  .tab-content { padding: 16px; }
  .app-header { padding: 0 16px; }
}

/* TOAST */
.toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast {
  background: var(--navy);
  color: white;
  padding: 12px 18px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s ease;
  max-width: 300px;
}
.toast.success { background: #064e3b; }
.toast.error { background: #7f1d1d; }
@keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* DIVIDER */
.divider { height: 1px; background: var(--gray-200); margin: 20px 0; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--gray-100); }
::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 99px; }
::-webkit-scrollbar-thumb:hover { background: var(--gray-400); }
</style>
</head>
<body>

<!-- HEADER -->


<div class="app-header">
  <div class="header-brand">
    <div class="header-logo">AK</div>
    <div>
      <div class="header-title">AI Job Hunt Command Centre</div>
      <div class="header-sub">Amretha Karthikeyan ¬∑ Lead BA ¬∑ Singapore ¬∑ Powered by Claude AI ‚ú®</div>
    </div>
  </div>
  <div style="color:rgba(255,255,255,0.7);font-size:12px;" id="headerDate"></div>
</div>

<!-- DAILY GOAL BAR -->
<div class="daily-goal-bar">
  <div class="goal-label">üìÖ Daily Goal:</div>
  <div class="goal-input-wrap">
    <label>Target</label>
    <input type="number" class="goal-num-input" id="dailyGoalTarget" value="5" min="1" max="20" onchange="updateGoalDisplay()">
    <label>apps/day</label>
  </div>
  <div class="goal-progress-wrap">
    <div class="goal-bar-bg"><div class="goal-bar-fill" id="goalBarFill" style="width:0%"></div></div>
    <div class="goal-text" id="goalText">0 / 5 today</div>
  </div>
  <div class="streak-badge" id="streakBadge">üî• 0 day streak</div>
  <button class="btn btn-sm" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3);" onclick="incrementGoal()">+ Add App</button>
</div>

<!-- TABS -->
<div class="tab-nav">
  <button class="tab-btn active" onclick="switchTab('tab3',this)"><span class="tab-icon">üìã</span>Job Tracker</button>
  <button class="tab-btn" onclick="switchTab('tab2',this)"><span class="tab-icon">üéØ</span>Interview Prep AI</button>
  <button class="tab-btn" onclick="switchTab('tab6',this)"><span class="tab-icon">üåê</span>Job Discovery</button>
  <button class="tab-btn" onclick="switchTab('tab4',this)"><span class="tab-icon">üöÄ</span>Auto-Apply Centre</button>
</div>

<!-- ========== TAB 2: AI INTERVIEW PREP ========== -->
<div id="tab2" class="tab-content">
  <!-- Onboarding / Setup Phase -->
  <div id="interviewSetup">
    <div style="text-align:center;margin-bottom:24px;">
      <div style="font-size:42px;margin-bottom:8px;">üéØ</div>
      <h2 style="font-weight:800;font-size:22px;color:var(--navy);margin:0 0 6px;">AI Interview Coach</h2>
      <p style="color:var(--gray-500);font-size:13px;margin:0;">I'm here to help you ace your next interview. Let's get started!</p>
    </div>

    <div class="grid-2" style="max-width:800px;margin:0 auto;gap:20px;">
      <div class="card">
        <div class="card-title">üìù Tell Me About Your Interview</div>
        <div class="form-group">
          <label>Job Role *</label>
          <input type="text" class="form-control" id="ipRole" placeholder="e.g. Product Manager, Business Analyst...">
        </div>
        <div class="form-group">
          <label>Company Name *</label>
          <input type="text" class="form-control" id="ipCompany" placeholder="e.g. Google, DBS, Grab...">
        </div>
        <div class="form-group">
          <label>Interview Type</label>
          <select class="form-control" id="ipType">
            <option value="behavioral">Behavioral / Situational</option>
            <option value="technical">Technical / Case Study</option>
            <option value="product">Product Sense / Strategy</option>
            <option value="mixed">Full Mock Interview (Mixed)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Job Description (optional ‚Äî improves accuracy)</label>
          <textarea class="form-control" id="ipJD" placeholder="Paste the JD for highly tailored questions..." style="min-height:100px;"></textarea>
        </div>
        <div class="form-group">
          <label>Resume / Key Experience (optional)</label>
          <textarea class="form-control" id="ipResume" placeholder="Paste your resume or key bullet points. The AI will reference your real experience in follow-up questions..." style="min-height:80px;"></textarea>
        </div>
      </div>

      <div class="card">
        <div class="card-title">‚öôÔ∏è Choose Your Mode</div>
        <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;">
          <label class="mode-option" id="modeChatLabel" style="display:flex;align-items:center;gap:12px;padding:14px 16px;border:2px solid var(--blue);border-radius:10px;cursor:pointer;background:var(--blue-pale);">
            <input type="radio" name="ipMode" value="chat" id="modeChat" checked style="accent-color:var(--blue);width:18px;height:18px;">
            <div>
              <div style="font-weight:700;font-size:14px;">üí¨ Chat Mode</div>
              <div style="font-size:11px;color:var(--gray-500);margin-top:2px;">Type your answers. AI responds with follow-ups, feedback & scoring.</div>
            </div>
          </label>
          <label class="mode-option" id="modeVoiceLabel" style="display:flex;align-items:center;gap:12px;padding:14px 16px;border:2px solid var(--gray-200);border-radius:10px;cursor:pointer;">
            <input type="radio" name="ipMode" value="voice" id="modeVoice" style="accent-color:var(--blue);width:18px;height:18px;">
            <div>
              <div style="font-weight:700;font-size:14px;">üéôÔ∏è Voice Mode</div>
              <div style="font-size:11px;color:var(--gray-500);margin-top:2px;">Speak your answers using your microphone. AI listens, transcribes & coaches.</div>
            </div>
          </label>
        </div>

        <div class="divider"></div>

        <div style="font-weight:700;font-size:13px;margin-bottom:8px;">üß† Interview Intelligence</div>
        <div style="font-size:12px;color:var(--gray-500);line-height:1.6;">
          Powered by techniques from top interview prep platforms:
          <ul style="margin:8px 0 0 16px;padding:0;">
            <li><strong>Behavioral STAR method</strong> ‚Äî structured Situation, Task, Action, Result</li>
            <li><strong>Company-specific research</strong> ‚Äî Glassdoor questions, culture, process</li>
            <li><strong>Product/Case frameworks</strong> ‚Äî Exponent, PrepLounge style</li>
            <li><strong>Real-time feedback</strong> ‚Äî filler words, confidence, structure scoring</li>
            <li><strong>Adaptive follow-ups</strong> ‚Äî AI digs deeper like a real interviewer</li>
          </ul>
        </div>

        <button class="btn btn-primary" onclick="startInterviewSession()" id="startInterviewBtn" style="width:100%;margin-top:16px;padding:14px;font-size:15px;">
          üöÄ Start Interview Session
        </button>
      </div>
    </div>
  </div>

  <!-- Active Interview Session -->
  <div id="interviewSession" style="display:none;">
    <!-- Top bar -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div>
        <span style="font-weight:800;font-size:16px;color:var(--navy);" id="sessionTitle">Mock Interview</span>
        <span style="font-size:12px;color:var(--gray-400);margin-left:8px;" id="sessionMeta"></span>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-sm btn-secondary" onclick="endInterviewSession()">‚èπ End Session</button>
        <button class="btn btn-sm btn-ghost" onclick="downloadInterviewTranscript()">‚¨á Download Transcript</button>
      </div>
    </div>

    <!-- Score cards -->
    <div class="grid-4" style="margin-bottom:16px;" id="interviewScoreCards">
      <div class="stat-card blue"><div class="stat-icon">‚ùì</div><div class="stat-label">Questions Asked</div><div class="stat-value" id="ipQCount">0</div></div>
      <div class="stat-card green"><div class="stat-icon">‚úÖ</div><div class="stat-label">Answered</div><div class="stat-value" id="ipACount">0</div></div>
      <div class="stat-card amber"><div class="stat-icon">‚≠ê</div><div class="stat-label">Avg Score</div><div class="stat-value" id="ipAvgScore">‚Äî</div></div>
      <div class="stat-card purple"><div class="stat-icon">‚è±Ô∏è</div><div class="stat-label">Session Time</div><div class="stat-value" id="ipTimer">0:00</div></div>
    </div>

    <!-- Chat area -->
    <div class="card" style="padding:0;overflow:hidden;">
      <div id="interviewChat" style="height:420px;overflow-y:auto;padding:20px;background:#fafbfc;">
        <!-- Messages rendered here -->
      </div>

      <!-- Input area -->
      <div style="border-top:1.5px solid var(--gray-200);padding:14px 16px;background:white;">
        <!-- Voice indicator (hidden by default) -->
        <div id="voiceIndicator" style="display:none;text-align:center;margin-bottom:10px;">
          <div id="voiceWaveform" style="display:flex;align-items:center;justify-content:center;gap:3px;height:40px;">
            <div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div>
            <div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div>
            <div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div>
          </div>
          <div style="font-size:11px;color:var(--blue);margin-top:4px;" id="voiceStatus">üéôÔ∏è Listening...</div>
        </div>

        <div style="display:flex;gap:8px;align-items:flex-end;">
          <textarea class="form-control" id="interviewInput" placeholder="Type your answer here... (Press Enter to send, Shift+Enter for new line)" style="min-height:44px;max-height:120px;resize:vertical;flex:1;margin:0;" onkeydown="handleInterviewKeydown(event)"></textarea>
          <button class="btn btn-primary" onclick="sendInterviewAnswer()" id="sendAnswerBtn" style="height:44px;min-width:44px;padding:0 14px;">
            ‚û§
          </button>
          <button class="btn btn-secondary" onclick="toggleVoiceInput()" id="voiceToggleBtn" style="height:44px;min-width:44px;padding:0 12px;" title="Toggle voice input">
            üéôÔ∏è
          </button>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;">
          <span style="font-size:10px;color:var(--gray-400);">üí° Tip: Answer in STAR format (Situation ‚Üí Task ‚Üí Action ‚Üí Result) for behavioral questions</span>
          <span style="font-size:10px;color:var(--gray-400);" id="typingIndicator"></span>
        </div>
      </div>
    </div>

    <!-- Company Intel Panel (collapsible) -->
    <div class="card" style="margin-top:16px;" id="companyIntelCard">
      <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;" onclick="toggleCompanyIntel()">
        <div class="card-title" style="margin:0;">üè¢ Company Intelligence</div>
        <span id="companyIntelToggle" style="font-size:18px;color:var(--gray-400);">‚ñº</span>
      </div>
      <div id="companyIntelContent" style="display:none;margin-top:12px;">
        <div style="text-align:center;padding:20px;color:var(--gray-400);font-size:12px;" id="companyIntelLoading">
          Loading company intelligence...
        </div>
      </div>
    </div>

    <!-- Session Summary (shown at end) -->
    <div class="card" style="margin-top:16px;display:none;" id="sessionSummaryCard">
      <div class="card-title">üìä Session Summary & Feedback</div>
      <div id="sessionSummaryContent"></div>
    </div>
  </div>
</div>

<!-- ========== TAB 3: JOB TRACKER (now default) ========== -->
<div id="tab3" class="tab-content active">
  <!-- Bookmarklet Banner (always visible) -->
  <!-- Bookmarklet Setup Banner -->
  <div id="bookmarkletBanner" style="background:linear-gradient(135deg,#4f46e5,#7c3aed);border-radius:12px;padding:18px 20px;margin-bottom:16px;color:white;">
    <div style="font-weight:700;font-size:14px;margin-bottom:4px;">üîñ LinkedIn Bookmarklet ‚Äî Import Jobs in 1 Click</div>
    <div style="font-size:12px;opacity:0.9;margin-bottom:14px;">Click it on any LinkedIn job page to instantly add to your tracker. Works on saved jobs page too.</div>

    <!-- Step-by-step -->
    <div style="background:rgba(255,255,255,0.15);border-radius:8px;padding:12px 14px;margin-bottom:12px;font-size:12px;line-height:2;">
      <strong>One-time setup (30 seconds):</strong><br>
      1Ô∏è‚É£ &nbsp;Press <kbd style="background:rgba(0,0,0,0.3);padding:1px 6px;border-radius:4px;">Ctrl+Shift+B</kbd> (Windows) or <kbd style="background:rgba(0,0,0,0.3);padding:1px 6px;border-radius:4px;">Cmd+Shift+B</kbd> (Mac) to show bookmarks bar<br>
      2Ô∏è‚É£ &nbsp;Click the <strong>üìã Copy Bookmarklet</strong> button below<br>
      3Ô∏è‚É£ &nbsp;Right-click your bookmarks bar ‚Üí <strong>"Add page‚Ä¶"</strong> or <strong>"New bookmark"</strong><br>
      4Ô∏è‚É£ &nbsp;Name it <strong>"Job Tracker"</strong>, then <strong>delete the URL field</strong> and paste (<kbd style="background:rgba(0,0,0,0.3);padding:1px 6px;border-radius:4px;">Ctrl+V</kbd>) ‚Üí Save<br>
      5Ô∏è‚É£ &nbsp;Done! Click it on <strong>linkedin.com/jobs/view/‚Ä¶</strong> or <strong>linkedin.com/my-items/saved-jobs/</strong>
    </div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <button id="copyBmBtn" onclick="copyBookmarkletToClipboard()" style="background:white;color:#4f46e5;border:none;padding:10px 22px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;">
        üìã Copy Bookmarklet
      </button>
      <span id="copyBmStatus" style="font-size:12px;opacity:0.9;"></span>
    </div>
  </div>

  <!-- Dashboard Stats -->
  <div class="grid-4" style="margin-bottom:20px;" id="statsGrid">
    <div class="stat-card blue"><div class="stat-icon">üì®</div><div class="stat-label">Total Applications</div><div class="stat-value" id="statTotal">0</div></div>
    <div class="stat-card green"><div class="stat-icon">üéôÔ∏è</div><div class="stat-label">Active Interviews</div><div class="stat-value" id="statInterviews">0</div></div>
    <div class="stat-card amber"><div class="stat-icon">üèÜ</div><div class="stat-label">Offers Received</div><div class="stat-value" id="statOffers">0</div></div>
    <div class="stat-card purple"><div class="stat-icon">üìà</div><div class="stat-label">Interview Rate %</div><div class="stat-value" id="statRate">0%</div></div>
  </div>

  <div class="flex-between" style="margin-bottom:16px;">
    <div>
      <div class="card-title" style="margin-bottom:2px;">üìã Job Application Tracker</div>
      <div id="dbStatusLine" style="font-size:11px;color:var(--gray-400);"></div>
    </div>
    <div class="flex-row">
      <button class="btn btn-primary btn-sm" onclick="openAddJobModal()">+ Add New Job</button>
      <button class="btn btn-sm" style="background:#0ea5e9;color:white;border:none;" onclick="openImportModal()">üì• Import from LinkedIn</button>
      <button id="extractJobsBtn" class="btn btn-sm" style="background:#7c3aed;color:white;border:none;" onclick="extractLatestJobs()">üöÄ Extract Latest Jobs</button>
      <button class="btn btn-sm" style="background:#faf5ff;color:#7c3aed;border:1.5px solid #ddd6fe;" onclick="openRankModal()">üèÜ AI Rank</button>
      <button class="btn btn-sm" style="background:#dcfce7;color:#166534;border:1.5px solid #86efac;" onclick="bulkAutoApply()">‚ö° Bulk Auto-Apply</button>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">‚¨á CSV</button>
      <button class="btn btn-sm" style="background:#fff7ed;color:#c2410c;border:1.5px solid #fed7aa;" onclick="confirmClearAll()">üóë Clear All</button>
    </div>
  </div>

  <!-- Extract Jobs Progress (hidden until running) -->
  <div id="extractProgressWrap" style="display:none;background:#1e1b4b;border-radius:10px;padding:14px 16px;margin-bottom:16px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
      <span style="color:#a5b4fc;font-weight:600;font-size:13px;">üöÄ Extract Latest Jobs</span>
      <button onclick="document.getElementById('extractProgressWrap').style.display='none'" style="background:none;border:none;color:#6b7280;cursor:pointer;font-size:16px;">‚úï</button>
    </div>
    <pre id="extractLog" style="color:#e0e7ff;font-size:12px;font-family:monospace;margin:0;white-space:pre-wrap;max-height:180px;overflow-y:auto;line-height:1.7;"></pre>
  </div>

  <div class="tracker-layout">
    <div>
      <div id="jobListView"></div>

      <!-- Analytics Section -->
      <div class="analytics-section">
        <div class="card" style="margin-top:20px;">
          <div class="card-title">üìä Application Analytics</div>
          <div class="grid-2">
            <div>
              <div class="section-label">Application Funnel</div>
              <div id="funnelChart" style="margin-top:10px;"></div>
            </div>
            <div>
              <div class="section-label">Weekly Applications</div>
              <div class="chart-bars" id="weeklyChart" style="margin-top:10px;"></div>
              <div style="font-size:11px;color:var(--gray-400);margin-top:6px;text-align:center;">Last 6 weeks</div>
              <div class="divider"></div>
              <div class="section-label">Source Breakdown</div>
              <div id="sourceBreakdown" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Follow-up Sidebar -->
    <div class="followup-sidebar">
      <div class="card">
        <div class="card-title" style="font-size:14px;">‚è∞ Follow Up Today</div>
        <div id="followupList"><div style="color:var(--gray-400);font-size:12px;text-align:center;padding:20px;">No follow-ups due today</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ========== TAB 4: AUTO-APPLY COMMAND CENTRE ========== -->
<div id="tab4" class="tab-content">
  <div class="grid-2" style="margin-bottom:24px;">
    <!-- Section A: Job Search Launcher -->
    <div class="card">
      <div class="card-title">üîç Job Search Launcher</div>
      <div class="grid-2">
        <div class="form-group">
          <label>Role Type</label>
          <select class="form-control" id="searchRoleType">
            <option>Business Analyst</option>
            <option>Product Owner</option>
            <option>Product Manager</option>
            <option>Business Development</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <input type="text" class="form-control" id="searchLocation" value="Singapore">
        </div>
        <div class="form-group">
          <label>Experience Level</label>
          <select class="form-control" id="searchExp">
            <option>Mid</option>
            <option>Senior</option>
            <option>Lead</option>
          </select>
        </div>
        <div class="form-group">
          <label>Salary Min (SGD)</label>
          <input type="number" class="form-control" id="searchSalMin" placeholder="7000" value="7000">
        </div>
      </div>
      <div class="form-group">
        <label>Extra Keywords (optional)</label>
        <input type="text" class="form-control" id="searchKeywords" placeholder="e.g. Agile, FinTech, Loan IQ">
      </div>
      <button class="btn btn-primary" onclick="launchJobSearch()" style="width:100%;margin-bottom:16px;">üöÄ Search Now (Opens All Job Boards)</button>
      
      <div class="section-label">Quick Launch by Board</div>
      <div class="boards-grid">
        <button class="job-board-btn" onclick="openBoard('linkedin')">üíº LinkedIn</button>
        <button class="job-board-btn" onclick="openBoard('indeed')">üîé Indeed SG</button>
        <button class="job-board-btn" onclick="openBoard('glassdoor')">üè¢ Glassdoor</button>
        <button class="job-board-btn" onclick="openBoard('nodeflair')">‚ö° NodeFlair</button>
        <button class="job-board-btn" onclick="openBoard('jobstreet')">üìã Jobstreet</button>
      </div>

      <div class="divider"></div>
      <div class="section-label">üéØ Today's Target Companies</div>
      <div class="company-grid" id="targetCompanies"></div>
    </div>

    <!-- Section B: Application Kit Generator -->
    <div class="card">
      <div class="card-title">‚ö° Application Kit Generator</div>
      <div class="form-group">
        <label>Company Name</label>
        <input type="text" class="form-control" id="kitCompany" placeholder="e.g. Grab">
      </div>
      <div class="form-group">
        <label>Role Title</label>
        <input type="text" class="form-control" id="kitRole" placeholder="e.g. Lead Business Analyst">
      </div>
      <div class="form-group">
        <label>Role Type</label>
        <select class="form-control" id="kitRoleType">
          <option>Business Analyst</option>
          <option>Product Owner</option>
          <option>Product Manager</option>
          <option>Business Development</option>
        </select>
      </div>
      <div class="form-group">
        <label>Paste Job Description</label>
        <textarea class="form-control" id="kitJD" placeholder="Paste the full JD here..." style="min-height:120px;"></textarea>
      </div>
      <button class="btn btn-success" onclick="generateFullKit()" id="kitBtn" style="width:100%;margin-bottom:10px;">‚ö° Generate Full Application Kit</button>
      <button class="btn btn-secondary" onclick="openSpeedKit()" style="width:100%;margin-bottom:10px;">üèÉ Quick Apply Speed Kit (pre-filled answers)</button>
      <button class="btn btn-ghost" onclick="logApplicationFromKit()" id="logKitBtn" style="width:100%;">üìã Log This Application to Tracker</button>
    </div>
  </div>

  <!-- Three-panel output -->
  <div id="kitOutputSection" style="display:none;">
    <div class="card-title">üì¶ Your Application Kit</div>
    <div class="three-panels" id="kitPanels">
      <div class="panel-box">
        <div class="panel-header">üìÑ ATS-Optimised Resume <span id="kitKwScore" class="score-badge" style="font-size:10px;margin-left:6px;"></span></div>
        <div class="panel-body" id="kitResume">Generating...</div>
        <div class="panel-footer">
          <button class="btn btn-sm btn-secondary" onclick="copyPanel('kitResume')">üìã Copy</button>
          <button class="btn btn-sm btn-ghost" onclick="downloadOutput('kitResume','resume_'+Date.now()+'.txt')">‚¨á Download</button>
        </div>
      </div>
      <div class="panel-box">
        <div class="panel-header">‚úâÔ∏è Cover Letter</div>
        <div class="panel-body" id="kitCover">Generating...</div>
        <div class="panel-footer">
          <button class="btn btn-sm btn-secondary" onclick="copyPanel('kitCover')">üìã Copy</button>
          <button class="btn btn-sm btn-ghost" onclick="downloadOutput('kitCover','cover_'+Date.now()+'.txt')">‚¨á Download</button>
        </div>
      </div>
      <div class="panel-box">
        <div class="panel-header">üéØ Quick Interview Prep</div>
        <div class="panel-body" id="kitPrep">Generating...</div>
        <div class="panel-footer">
          <button class="btn btn-sm btn-secondary" onclick="copyPanel('kitPrep')">üìã Copy</button>
          <button class="btn btn-sm btn-ghost" onclick="downloadOutput('kitPrep','prep_'+Date.now()+'.txt')">‚¨á Download</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- PROFILE MANAGEMENT & AUTONOMOUS AGENT -->
  <div class="grid-2" style="margin-bottom:24px;">
    <!-- Profile Manager -->
    <div class="card">
      <div class="card-title">üë§ Profile Manager</div>
      <div id="profileStatus" style="padding:8px 12px;border-radius:8px;background:var(--blue-pale);font-size:12px;color:var(--blue);margin-bottom:12px;">
        Loading profile...
      </div>
      <div class="form-group">
        <label>Paste Your Resume or Profile</label>
        <textarea class="form-control" id="profileResumeText" placeholder="Paste your full resume text here. AI will parse it into a structured profile automatically..." style="min-height:160px;font-size:12px;"></textarea>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="parseAndSaveProfile()" id="profileParseBtn">ü§ñ AI Parse & Save Profile</button>
        <button class="btn btn-ghost" onclick="resetProfile()">‚Ü© Reset to Default</button>
      </div>
      <div id="profilePreview" style="display:none;margin-top:16px;">
        <div class="divider"></div>
        <div style="font-weight:700;font-size:13px;margin-bottom:8px;">üìã Active Profile Preview</div>
        <div id="profilePreviewContent" style="background:var(--gray-50);border-radius:8px;padding:12px;font-size:12px;line-height:1.6;max-height:240px;overflow-y:auto;"></div>
        <button class="btn btn-sm btn-secondary" onclick="editProfileManually()" style="margin-top:8px;">‚úèÔ∏è Edit Manually</button>
      </div>
      <!-- Manual edit form (hidden by default) -->
      <div id="profileEditForm" style="display:none;margin-top:16px;">
        <div class="divider"></div>
        <div style="font-weight:700;font-size:13px;margin-bottom:8px;">‚úèÔ∏è Edit Profile</div>
        <div class="grid-2" style="gap:10px;">
          <div class="form-group"><label>Full Name</label><input type="text" class="form-control" id="profName"></div>
          <div class="form-group"><label>Email</label><input type="text" class="form-control" id="profEmail"></div>
          <div class="form-group"><label>Phone</label><input type="text" class="form-control" id="profMobile"></div>
          <div class="form-group"><label>LinkedIn URL</label><input type="text" class="form-control" id="profLinkedin"></div>
        </div>
        <div class="form-group"><label>Headline</label><input type="text" class="form-control" id="profHeadline" placeholder="e.g. Product Manager | Fintech | Singapore"></div>
        <div class="form-group"><label>Summary</label><textarea class="form-control" id="profSummary" style="min-height:80px;"></textarea></div>
        <div class="form-group"><label>Skills (comma-separated)</label><input type="text" class="form-control" id="profSkills"></div>
        <div class="form-group"><label>Certification</label><input type="text" class="form-control" id="profCert"></div>
        <button class="btn btn-success" onclick="saveProfileManually()" style="width:100%;">üíæ Save Profile</button>
      </div>
    </div>

    <!-- Autonomous Agent -->
    <div class="card">
      <div class="card-title">ü§ñ Autonomous Agent</div>
      <div style="font-size:12px;color:var(--gray-500);margin-bottom:16px;">
        One-click fully autonomous pipeline: Discover Jobs ‚Üí Score ‚Üí Generate Docs ‚Üí Notify. The agent runs everything end-to-end.
      </div>
      <div class="form-group">
        <label>Search Keywords (auto-filled from profile)</label>
        <input type="text" class="form-control" id="autoAgentKw" placeholder="Product Owner, Business Analyst">
      </div>
      <div class="grid-2" style="gap:10px;">
        <div class="form-group">
          <label>Location</label>
          <input type="text" class="form-control" id="autoAgentLoc" value="Singapore">
        </div>
        <div class="form-group">
          <label>Max Job Age</label>
          <select class="form-control" id="autoAgentDays">
            <option value="7">7 days</option>
            <option value="14">14 days</option>
            <option value="30" selected>30 days</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Platforms</label>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:4px;">
          <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;"><input type="checkbox" id="autoPlatIndeed" checked> Indeed</label>
          <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;"><input type="checkbox" id="autoPlatJobStreet" checked> JobStreet</label>
          <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;"><input type="checkbox" id="autoPlatWorkable" checked> Workable</label>
          <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;"><input type="checkbox" id="autoPlatLinkedIn" checked> LinkedIn</label>
        </div>
      </div>
      <button class="btn btn-primary" onclick="runAutonomousAgent()" id="autoAgentBtn" style="width:100%;padding:14px;font-size:14px;">
        üöÄ Run Full Autonomous Pipeline
      </button>
      <div id="autoAgentLog" style="display:none;margin-top:16px;">
        <div style="font-weight:600;font-size:13px;margin-bottom:6px;">üìã Pipeline Log</div>
        <pre id="autoAgentLogContent" class="progress-log" style="min-height:100px;"></pre>
      </div>
    </div>
  </div>

<!-- ========== TAB 6: JOB DISCOVERY ========== -->
<div id="tab6" class="tab-content">
  <div class="card" style="margin-bottom:20px;">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
      <div>
        <div class="card-title" style="margin-bottom:2px;">üåê Discover Jobs from Multiple Platforms</div>
        <div style="font-size:12px;color:var(--gray-400);">Search Indeed, JobStreet & Workable for roles matching your profile. Results sorted by AI job fit score.</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom:20px;">
    <div class="grid-2" style="gap:16px;">
      <div>
        <div class="form-group">
          <label>Job Title / Keywords</label>
          <input type="text" class="form-control" id="discoverKeywords" placeholder="e.g. Product Owner, Business Analyst" value="Product Owner">
        </div>
        <div class="form-group">
          <label>Location</label>
          <input type="text" class="form-control" id="discoverLocation" placeholder="e.g. Singapore" value="Singapore">
        </div>
      </div>
      <div>
        <div class="form-group">
          <label>Platforms</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;">
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;">
              <input type="checkbox" id="discPlatIndeed" checked> Indeed
            </label>
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;">
              <input type="checkbox" id="discPlatJobStreet" checked> JobStreet
            </label>
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;">
              <input type="checkbox" id="discPlatWorkable" checked> Workable
            </label>
          </div>
        </div>
        <div class="form-group">
          <label>Max Age</label>
          <select class="form-control" id="discoverMaxDays">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
          </select>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="discoverJobs()" id="discoverBtn" style="width:100%;">üîç Search All Platforms</button>
  </div>

  <!-- Discovery Results -->
  <div id="discoveryProgress" style="display:none;background:#1e1b4b;border-radius:10px;padding:14px 16px;margin-bottom:16px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
      <span style="color:#a5b4fc;font-weight:600;font-size:13px;">üîç Searching platforms...</span>
      <button onclick="document.getElementById('discoveryProgress').style.display='none'" style="background:none;border:none;color:#6b7280;cursor:pointer;font-size:16px;">‚úï</button>
    </div>
    <pre id="discoveryLog" style="color:#e0e7ff;font-size:12px;font-family:monospace;margin:0;white-space:pre-wrap;max-height:180px;overflow-y:auto;line-height:1.7;"></pre>
  </div>

  <div id="discoveryResults" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <div class="card-title" style="margin-bottom:0;">üèÜ Discovered Jobs <span id="discoveryCount" style="font-size:12px;color:var(--gray-400);font-weight:400;"></span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-sm btn-primary" onclick="importSelectedDiscoveries()" id="importDiscBtn">üì• Import Selected to Tracker</button>
        <button class="btn btn-sm btn-secondary" onclick="importAllDiscoveries()">üì• Import All</button>
      </div>
    </div>
    <div id="discoveryList"></div>
  </div>

  <div id="discoveryEmpty" style="text-align:center;padding:60px 20px;color:var(--gray-400);">
    <div style="font-size:48px;margin-bottom:12px;">üåê</div>
    <div style="font-size:14px;">Search for jobs across Indeed, JobStreet & Workable</div>
    <div style="font-size:12px;margin-top:6px;">Results will be AI-scored and sorted by fit</div>
  </div>
</div>

<!-- ========== MODALS ========== -->

<!-- AI Job Ranking Modal -->
<!-- ‚îÄ‚îÄ AGENT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="modal-overlay" id="agentModal" style="display:none;">
  <div class="modal" style="max-width:620px;max-height:88vh;overflow-y:auto;">
    <div class="modal-header" style="background:linear-gradient(135deg,#4f46e5,#7c3aed);color:white;border-radius:12px 12px 0 0;">
      <div style="font-size:18px;font-weight:700;">ü§ñ Job Agent</div>
      <button class="modal-close" onclick="closeModal('agentModal')" style="color:white;opacity:.8;">‚úï</button>
    </div>
    <div style="padding:24px;">

      <!-- Status cards -->
      <div id="agentStatusCards" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px;">
        <div style="background:#eff6ff;border-radius:8px;padding:12px;text-align:center;">
          <div id="agStat_total" style="font-size:24px;font-weight:700;color:#1d4ed8;">‚Äî</div>
          <div style="font-size:11px;color:#6b7280;">Total Jobs</div>
        </div>
        <div style="background:#fefce8;border-radius:8px;padding:12px;text-align:center;">
          <div id="agStat_jd" style="font-size:24px;font-weight:700;color:#ca8a04;">‚Äî</div>
          <div style="font-size:11px;color:#6b7280;">With JD</div>
        </div>
        <div style="background:#f0fdf4;border-radius:8px;padding:12px;text-align:center;">
          <div id="agStat_scored" style="font-size:24px;font-weight:700;color:#16a34a;">‚Äî</div>
          <div style="font-size:11px;color:#6b7280;">Scored</div>
        </div>
        <div style="background:#faf5ff;border-radius:8px;padding:12px;text-align:center;">
          <div id="agStat_docs" style="font-size:24px;font-weight:700;color:#7c3aed;">‚Äî</div>
          <div style="font-size:11px;color:#6b7280;">Docs Ready</div>
        </div>
      </div>

      <!-- What agent does -->
      <div style="background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:10px;padding:16px;margin-bottom:20px;font-size:13px;">
        <div style="font-weight:700;margin-bottom:8px;">What the agent does autonomously:</div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <div>0Ô∏è‚É£  <b>Scrape LinkedIn</b> saved jobs automatically ‚Äî logs in and imports all jobs + JDs daily</div>
          <div>1Ô∏è‚É£  <b>AI Score</b> every job with a JD ‚Äî ranks 1‚Äì10, labels fit, flags consulting roles</div>
          <div>2Ô∏è‚É£  <b>Generate Resume + Cover Letter</b> for all jobs scored ‚â• 5 (right CV template auto-selected)</div>
          <div>3Ô∏è‚É£  <b>Save everything to Supabase</b> ‚Äî scores, docs, JDs ‚Äî nothing gets lost</div>
          <div>4Ô∏è‚É£  <b>Notify you</b> via Email to WhatsApp +6590256503 with top matches & download links</div>
        </div>
      </div>

      <!-- Credentials config -->
      <div style="background:#fffbeb;border:1.5px solid #fcd34d;border-radius:10px;padding:16px;margin-bottom:20px;font-size:12px;">
        <div style="font-weight:700;margin-bottom:10px;font-size:13px;">‚öôÔ∏è Setup ‚Äî Enter Once</div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <div>
            <label style="font-weight:600;display:block;margin-bottom:3px;">LinkedIn Email</label>
            <input id="cfgLinkedInEmail" type="email" placeholder="your@linkedin-email.com"
              style="width:100%;padding:7px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;box-sizing:border-box;">
          </div>
          <div>
            <label style="font-weight:600;display:block;margin-bottom:3px;">LinkedIn Password</label>
            <input id="cfgLinkedInPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              style="width:100%;padding:7px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;box-sizing:border-box;">
          </div>
          <div>
            <label style="font-weight:600;display:block;margin-bottom:3px;">Twilio Account SID <a href="https://console.twilio.com" target="_blank" style="font-weight:400;font-size:10px;color:#6b7280;">(get free at twilio.com)</a></label>
            <input id="cfgTwilioSid" type="text" placeholder="ACxxxxxxxxxxxxxxxx"
              style="width:100%;padding:7px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;box-sizing:border-box;">
          </div>
          <div>
            <label style="font-weight:600;display:block;margin-bottom:3px;">Twilio Auth Token</label>
            <input id="cfgTwilioToken" type="password" placeholder="your auth token"
              style="width:100%;padding:7px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;box-sizing:border-box;">
          </div>
          <div style="grid-column:1/-1;">
            <label style="font-weight:600;display:block;margin-bottom:3px;">Your WhatsApp Number <span style="font-weight:400;font-size:10px;color:#6b7280;">(include country code, e.g. +6590256503)</span></label>
            <input id="cfgWhatsappPhone" type="text" placeholder="+6590256503"
              style="width:100%;padding:7px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:12px;box-sizing:border-box;">
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <button onclick="saveAgentConfig()" style="background:#1d4ed8;color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">
            üíæ Save Credentials
          </button>
          <button class="btn btn-sm btn-ghost" onclick="testNotifications()">üîî Test WhatsApp</button>
          <span id="notifTestResult" style="font-size:11px;color:#374151;"></span>
          <span id="cfgSaveResult" style="font-size:11px;color:#374151;"></span>
        </div>
        <div style="margin-top:8px;font-size:11px;color:#92400e;">
          üìß Notifications ‚Üí <strong>WhatsApp +6590256503</strong> &nbsp;|&nbsp;
          üîí Credentials stored securely on server &nbsp;|&nbsp;
          ‚è∞ LinkedIn auto-scraped daily at 9am SGT
        </div>
      </div>

      <!-- Action buttons -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;">
        <button id="liScrapeBtn" onclick="runLinkedInScrape()" style="background:linear-gradient(135deg,#0a66c2,#0d8fe6);border:none;color:white;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;flex:1;">
          üîó Scrape LinkedIn Now
        </button>
        <button id="agentRunBtn" class="btn btn-primary" onclick="runAgent(false)" style="background:linear-gradient(135deg,#4f46e5,#7c3aed);border:none;flex:1;">
          ü§ñ Run Agent Now
        </button>
        <button class="btn btn-secondary" onclick="runAgent(true)" style="flex:1;">
          üîÑ Re-process All Jobs
        </button>
      </div>

      <!-- Cron info -->
      <div style="background:#f0fdf4;border:1.5px solid #bbf7d0;border-radius:10px;padding:14px;font-size:12px;">
        <div style="font-weight:700;margin-bottom:4px;">‚è∞ Daily Scheduled Run</div>
        <div style="color:#374151;margin-bottom:6px;">Add this cron job in Render ‚Üí your service ‚Üí Cron Jobs:</div>
        <code id="cronUrlDisplay" style="display:block;background:white;padding:6px 10px;border-radius:6px;font-size:11px;word-break:break-all;"></code>
        <div style="color:#6b7280;margin-top:4px;">Schedule: <code>0 9 * * *</code> (runs daily at 9am UTC = 5pm SGT)</div>
      </div>

      <!-- Live log -->
      <div id="agentLogWrap" style="display:none;margin-top:16px;">
        <div style="font-weight:600;font-size:13px;margin-bottom:6px;">üìã Agent Log</div>
        <div id="agentLog" style="background:#0f172a;color:#94a3b8;font-family:monospace;font-size:11px;padding:12px;border-radius:8px;max-height:180px;overflow-y:auto;line-height:1.6;"></div>
      </div>

    </div>
  </div>
</div>

<div class="modal-overlay" id="rankModal" style="display:none;">
  <div class="modal" style="max-width:700px;max-height:85vh;overflow-y:auto;">
    <button class="modal-close" onclick="closeModal('rankModal')">‚úï</button>
    <div class="modal-header">
      <div class="modal-title">üèÜ AI Job Fit Ranking</div>
      <div class="modal-subtitle">Claude analyses every job in your tracker against your profile and ranks them</div>
    </div>

    <div id="rankLoading" style="text-align:center;padding:40px;display:none;">
      <span class="spinner spinner-blue" style="width:32px;height:32px;border-width:3px;"></span>
      <div style="margin-top:16px;color:var(--gray-400);">Analysing your jobs against your profile...</div>
      <div style="margin-top:8px;font-size:12px;color:var(--gray-400);">This may take 15‚Äì30 seconds for large lists</div>
    </div>

    <div id="rankFetchPrompt" style="display:none;margin-bottom:16px;padding:12px;background:#fffbeb;border:1.5px solid #fcd34d;border-radius:8px;font-size:13px;">
      <strong>‚ö†Ô∏è Some jobs are missing JDs</strong> ‚Äî AI ranking works best with job descriptions. 
      <button class="btn btn-sm" style="background:#fef3c7;color:#92400e;border:1px solid #fcd34d;margin-left:8px;" onclick="fetchMissingJDs();closeModal('rankModal');">üì• Fetch All JDs first</button>
      <span style="margin-left:8px;color:var(--gray-400);">or rank with what's available ‚Üí</span>
    </div>

    <div id="rankResults" style="display:none;">
      <div id="rankSummary" style="margin-bottom:16px;padding:12px;background:#f8fafc;border-radius:8px;font-size:13px;color:var(--gray-500);"></div>
      <div id="rankList"></div>
      <div style="margin-top:16px;text-align:center;">
        <button class="btn btn-ghost btn-sm" onclick="closeModal('rankModal')">Close</button>
        <button class="btn btn-sm" style="background:#faf5ff;color:#7c3aed;border:1.5px solid #ddd6fe;margin-left:8px;" onclick="openRankModal()">üîÑ Re-run Analysis</button>
      </div>
    </div>

    <div id="rankEmpty" style="display:none;text-align:center;padding:40px;color:var(--gray-400);">
      <div style="font-size:32px;margin-bottom:12px;">üìã</div>
      <div>No jobs in your tracker yet. Add some jobs first, then rank them!</div>
    </div>

    <div id="rankError" style="display:none;padding:16px;background:#fff1f2;border-radius:8px;color:#dc2626;font-size:14px;"></div>
  </div>
</div>

<!-- Import Job Modal -->
<div class="modal-overlay" id="importJobModal" style="display:none;">
  <div class="modal" style="max-width:560px;">
    <button class="modal-close" onclick="closeModal('importJobModal')">‚úï</button>
    <div class="modal-header">
      <div class="modal-title">üîó Import Job from URL</div>
      <div class="modal-subtitle">Paste a LinkedIn or Indeed job URL to auto-fill details</div>
    </div>

    <!-- Bookmarklet Section -->
    <div style="background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;padding:14px;margin-bottom:16px;color:white;">
      <div style="font-weight:600;margin-bottom:6px;">üîñ 1-Click Bookmarklet ‚Äî Import from LinkedIn</div>
      <div style="font-size:12px;opacity:0.9;margin-bottom:10px;">
        ‚ë† On any <strong>LinkedIn job page</strong> ‚Üí saves that job instantly<br>
        ‚ë° On <strong>linkedin.com/my-items/saved-jobs/</strong> ‚Üí imports ALL saved jobs at once üöÄ<br>
        <span style="opacity:0.8;">‚ú® <strong>New:</strong> Jobs import directly ‚Äî no server needed, works instantly!</span>
      </div>
      <div style="font-size:12px;font-weight:600;margin-bottom:6px;">One-time setup:</div>
      <div style="font-size:12px;opacity:0.9;margin-bottom:10px;line-height:1.9;">
        1. Show bookmarks bar: <strong>Cmd+Shift+B</strong> (Mac) / <strong>Ctrl+Shift+B</strong> (Windows)<br>
        2. <strong>Click the box below</strong> to select all, then <strong>Cmd+C / Ctrl+C</strong> to copy<br>
        3. Right-click bookmarks bar ‚Üí <strong>Add page</strong> (Chrome) / <strong>New Bookmark</strong> (Safari)<br>
        4. Name: <strong>Send to Job Tracker</strong> ¬∑ paste as the URL ‚Üí Save<br>
        5. ‚ö†Ô∏è <strong>Re-copy this bookmarklet</strong> if you ever redeploy the app (URL is baked in)
      </div>
      <!-- Draggable link (best method) -->
      <div style="margin-bottom:10px;text-align:center;">
        <a id="bookmarkletLink" href="#"
          style="display:inline-block;background:#fff;color:#4f46e5;font-weight:700;font-size:13px;padding:10px 22px;border-radius:8px;text-decoration:none;border:2px dashed #a5b4fc;cursor:grab;"
          title="Drag this to your bookmarks bar!">
          üìå Drag me to Bookmarks Bar
        </a>
      </div>
      <div style="font-size:11px;opacity:0.85;margin-bottom:8px;text-align:center;">
        ‚òùÔ∏è <strong>Drag the button above</strong> to your bookmarks bar ‚Äî easiest method!<br>
        Or copy the code below manually:
      </div>
      <textarea id="bookmarkletBox" readonly
        style="width:100%;height:50px;font-size:9px;font-family:monospace;border-radius:6px;padding:8px;box-sizing:border-box;background:#1e1b4b;color:#a5b4fc;border:none;resize:none;cursor:text;"
        onclick="this.select();" onfocus="this.select();"
        placeholder="Loading...">Loading bookmarklet code...</textarea>
      <div style="font-size:11px;opacity:0.75;margin-top:4px;text-align:center;">üëÜ Click box ‚Üí Cmd+C / Ctrl+C to copy, then paste as bookmark URL</div>
    </div>

    <div style="margin-bottom:16px;">
      <label class="form-label">Job URL</label>
      <div style="display:flex;gap:8px;">
        <input id="importUrl" type="url" class="form-input" placeholder="https://www.linkedin.com/jobs/view/... or https://sg.indeed.com/..." style="flex:1;" />
        <button class="btn btn-primary" onclick="importJobFromUrl()" id="importBtn" style="white-space:nowrap;">üîç Parse URL</button>
      </div>
      <div id="importStatus" style="margin-top:8px;font-size:13px;color:var(--gray-400);"></div>
    </div>

    <div id="importFormFields" style="display:none;">
      <div class="form-row">
        <div>
          <label class="form-label">Job Title *</label>
          <input id="importTitle" class="form-input" placeholder="e.g. Product Owner" />
        </div>
        <div>
          <label class="form-label">Company *</label>
          <input id="importCompany" class="form-input" placeholder="e.g. Grab" />
        </div>
      </div>
      <div class="form-row">
        <div>
          <label class="form-label">Role Type</label>
          <select id="importRoleType" class="form-input">
            <option>Product Owner</option>
            <option>Product Manager</option>
            <option>Business Analyst</option>
            <option>AI Product Manager</option>
            <option>AI Business Analyst</option>
            <option>Senior Business Analyst</option>
          </select>
        </div>
        <div>
          <label class="form-label">Location</label>
          <input id="importLocation" class="form-input" value="Singapore" />
        </div>
      </div>
      <div>
        <label class="form-label">Job Description (paste if not auto-filled)</label>
        <textarea id="importDescription" class="form-input" rows="5" placeholder="Paste job description here..."></textarea>
      </div>
      <div style="display:flex;gap:10px;margin-top:16px;">
        <button class="btn btn-primary" onclick="saveImportedJob()" style="flex:1;">‚úÖ Add to Tracker</button>
        <button class="btn btn-ghost" onclick="closeModal('importJobModal')">Cancel</button>
      </div>
    </div>

    <div style="margin-top:16px;padding:12px;background:#f8fafc;border-radius:8px;font-size:12px;color:var(--gray-400);">
      <strong>üí° How to use:</strong> Paste the job URL ‚Üí click Parse URL ‚Üí the form fills what it can from the URL. Then <strong>copy the job description from LinkedIn/Indeed</strong> (while logged in on that page) and paste it below. Or use the <strong>üîñ Bookmarklet</strong> to send jobs in 1 click!
    </div>
  </div>
</div>

<!-- Add Job Modal -->
<div class="modal-overlay" id="addJobModal" style="display:none;">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addJobModal')">‚úï</button>
    <div class="modal-title">‚ûï Add New Job Application</div>
    <div class="grid-2">
      <div class="form-group"><label>Company Name *</label><input type="text" class="form-control" id="mCompany" placeholder="e.g. Grab"></div>
      <div class="form-group"><label>Role Title *</label><input type="text" class="form-control" id="mRole" placeholder="e.g. Lead Business Analyst"></div>
      <div class="form-group"><label>Role Type</label><select class="form-control" id="mRoleType"><option>Business Analyst</option><option>Product Owner</option><option>Product Manager</option><option>Business Development</option></select></div>
      <div class="form-group"><label>Status</label><select class="form-control" id="mStatus"><option value="saved">Saved</option><option value="applied">Applied</option><option value="screen">Recruiter Screen</option><option value="interview">Interviewing</option><option value="offer">Offer</option><option value="rejected">Rejected</option></select></div>
      <div class="form-group"><label>JD URL</label><input type="url" class="form-control" id="mUrl" placeholder="https://..."></div>
      <div class="form-group"><label>Salary (SGD/month)</label><input type="text" class="form-control" id="mSalary" placeholder="e.g. 9000 - 12000"></div>
      <div class="form-group"><label>Source</label><select class="form-control" id="mSource"><option>LinkedIn</option><option>Referral</option><option>Direct</option><option>Recruiter</option><option>JobStreet</option><option>Indeed</option><option>NodeFlair</option></select></div>
      <div class="form-group"><label>Priority</label><select class="form-control" id="mPriority"><option>High</option><option>Medium</option><option>Low</option></select></div>
    </div>
    <div class="form-group"><label>Notes</label><textarea class="form-control" id="mNotes" placeholder="Any notes about this role..." style="min-height:70px;"></textarea></div>
    <div class="flex-row" style="margin-top:16px;">
      <button class="btn btn-primary" onclick="saveJob()">üíæ Save Job</button>
      <button class="btn btn-ghost" onclick="closeModal('addJobModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Checklist Modal -->
<div class="modal-overlay" id="checklistModal" style="display:none;">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('checklistModal')">‚úï</button>
    <div class="modal-title" id="checklistTitle">‚úÖ Application Checklist</div>
    <div id="checklistItems"></div>
    <button class="btn btn-primary" onclick="saveChecklist()" style="margin-top:16px;">üíæ Save Progress</button>
  </div>
</div>

<!-- Apply Kit Popup -->
<div class="modal-overlay" id="applyKitModal" style="display:none;">
  <div class="modal modal-lg">
    <button class="modal-close" onclick="closeModal('applyKitModal')">‚úï</button>
    <div class="modal-title" id="applyKitTitle">‚ö° Apply Kit</div>
    <div id="applyKitContent" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;"></div>
  </div>
</div>

<!-- Job Detail Modal -->
<div class="modal-overlay" id="jobDetailModal" style="display:none;">
  <div class="modal" style="max-width:640px;">
    <button class="modal-close" onclick="closeModal('jobDetailModal')">‚úï</button>
    <div class="modal-title" id="jdModalTitle">üìã Job Details</div>

    <!-- Header info row -->
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:18px;">
      <div>
        <div style="font-size:18px;font-weight:800;color:var(--navy);" id="jdModalCompany"></div>
        <div style="font-size:14px;color:var(--gray-500);margin-top:3px;" id="jdModalRole"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;" id="jdModalBadges"></div>
      </div>
      <a id="jdModalApplyBtn" href="#" target="_blank" rel="noopener"
         style="display:none;flex-shrink:0;padding:10px 20px;background:var(--blue);color:white;border-radius:8px;font-weight:700;font-size:13px;text-decoration:none;white-space:nowrap;box-shadow:0 2px 8px rgba(26,86,219,0.25);">
        üîó Apply Now
      </a>
    </div>

    <!-- Apply URL display -->
    <div id="jdModalUrlRow" style="display:none;margin-bottom:14px;">
      <div style="font-size:11px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">Apply Link</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <input id="jdModalUrlText" readonly type="text"
               style="flex:1;font-size:12px;font-family:monospace;padding:7px 10px;border-radius:6px;border:1.5px solid var(--gray-200);background:var(--gray-50);color:var(--gray-700);outline:none;cursor:text;"
               onclick="this.select();" />
        <button class="btn btn-xs btn-secondary" onclick="copyJobUrl()">üìã Copy</button>
      </div>
    </div>

    <!-- No URL notice -->
    <div id="jdModalNoUrl" style="display:none;margin-bottom:14px;padding:10px 14px;background:#fff7ed;border:1.5px solid #fed7aa;border-radius:8px;font-size:12px;color:#92400e;">
      ‚ö†Ô∏è No apply link saved for this job. Add one by editing the card.
    </div>

    <!-- AI Reason -->
    <div id="jdModalAIReason" style="display:none;background:#f0fdf4;border:1.5px solid #bbf7d0;border-radius:8px;padding:10px 14px;font-size:12px;color:#166534;margin-bottom:14px;line-height:1.6;"></div>

    <!-- JD section -->
    <div style="font-size:11px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">Job Description</div>
    <div id="jdModalJD"
         style="background:var(--gray-50);border:1.5px solid var(--gray-200);border-radius:8px;padding:14px;font-size:13px;line-height:1.7;color:var(--gray-700);max-height:340px;overflow-y:auto;white-space:pre-wrap;word-break:break-word;">
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px;">
      <button class="btn btn-xs btn-secondary" onclick="copyJobJD()">üìã Copy JD</button>
    </div>

    <div style="display:flex;gap:8px;margin-top:18px;flex-wrap:wrap;">
      <button class="btn btn-primary" id="jdModalKitBtn" onclick="">‚ö° Generate Apply Kit</button>
      <button class="btn btn-ghost" onclick="closeModal('jobDetailModal')">Close</button>
    </div>
  </div>
</div>


<div class="modal-overlay" id="speedKitModal" style="display:none;">
  <div class="modal modal-lg" style="max-width:700px;">
    <button class="modal-close" onclick="closeModal('speedKitModal')">‚úï</button>
    <div class="modal-title">üèÉ Quick Apply Speed Kit</div>
    <div style="background:var(--blue-pale);border:1.5px solid var(--blue-mid);border-radius:10px;padding:12px 14px;margin-bottom:20px;font-size:13px;color:var(--navy);">
      <strong>How to use:</strong> Copy each answer ‚Üí paste directly into the application form. Under 3 minutes per job. Answers are framed for <strong>in-house product roles</strong>, not consulting.
    </div>
    <div id="speedKitContent"></div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ========== PROFILE DATA ==========
const PROFILE = {
  name: "Amretha Karthikeyan",
  address: "#02-321 153 Gangsa Road, Singapore-670153",
  mobile: "+65-90256503",
  email: "WhatsApp +6590256503",
  linkedin: "https://www.linkedin.com/in/amretha-nishanth-534b39101/",
  headline: "Product Owner | Lead BA | Fintech & Digital Products ¬∑ Singapore",
  aiProjectUrl: "https://stock-monitor-8ak6.onrender.com",
  summary: "SAFe 6.0 certified Product Owner and Lead Business Analyst with 5+ years owning product backlogs and driving digital product delivery in fintech and banking. At KPMG Singapore, served as de-facto Product Owner for Loan IQ ‚Äî a core banking platform ‚Äî leading cross-functional squads (engineering, UX, QA) to ship features and deliver measurable business outcomes. Seeking in-house product roles to own roadmaps end-to-end, from discovery through to scale.",
  skills: ["Tableau", "Power BI", "PSQL", "Python", "Agile", "JIRA", "Excel", "Microsoft Project", "Product Vision", "Roadmapping", "Business Analysis", "Risk Mitigation", "Change Management", "Budget Forecasting", "Variance Analysis", "KPI Tracking", "Dashboard Reporting", "Event Facilitation", "SAFe 6.0", "API integrations", "Loan IQ", "SQL", "Stakeholder Management", "Generative AI", "LLM", "Claude API", "AI product development", "prompt engineering", "AI-powered applications"],
  certification: "Scaled Agile Framework 6.0 Product Owner/Product Management",
  experience: [
    {
      company: "KPMG, Singapore",
      role: "Lead Business Analyst ‚Äì Functional Consultant ‚Äì Loan IQ",
      period: "Feb 2021 ‚Äì Present",
      bullets: [
        "Partnered with Enterprise Singapore on large-scale digital transformation projects",
        "Supported executive decision-making through As-Is/To-Be analysis and streamlined documentation of strategic processes across finance teams",
        "Collaborated with cross-regional stakeholders (UX, architecture, finance) to drive alignment across engineering and operations functions",
        "Managed internal reporting cycles, change requests, and approval workflows contributing to 5% increase in project profitability",
        "Owned and prioritised product backlog, ensuring alignment with business objectives, regulatory requirements and customer experience goals",
        "Trained vendors and managed go-live execution plans, ensuring process continuity across business units",
        "Conducted internal workshops to drive operational readiness and team-wide coordination",
        "Analysed complex problems, carried out root cause analysis creating innovative solutions with UX, architecture and software solutioning teams",
        "Experience in API integrations; designed, documented and executed end-to-end test scenarios on Loan IQ Product Applications (M&A, Trade, WCL, FA)",
        "Led Testers, Interns and Junior Business Analysts for Scrum activities (Planning, Closure, Retro)"
      ],
      achievements: [
        "Performed accurate Impact Analysis and persuaded clients to approve Change Request items, generating additional profit of ~5% of Project Cost",
        "Analysed and provided solutioning for Automated Interest Computation (financial services), saving 30 man-days of work",
        "Led the team during a critical transition phase from Sprint end to SIT, maintaining project delivery timeline"
      ]
    },
    {
      company: "J.P. Morgan",
      role: "Asset Management Virtual Internship",
      period: "Oct 2023 ‚Äì Jan 2024",
      bullets: [
        "Helped traders and clients build stronger investment portfolios with market-leading solutions",
        "Gathered business requirements from trading/execution teams; built robust investor profiles through structured questionnaires",
        "Performed quantitative fundamental analysis of 5 stocks and recommended to 2 clients based on risk appetite metrics",
        "Measured investment success via KPIs: Annual Portfolio Return, Portfolio Variance, Portfolio Standard Deviation"
      ]
    },
    {
      company: "Amazon Inc, India",
      role: "Business Analyst",
      period: "Mar 2018 ‚Äì Mar 2019",
      bullets: [
        "Analysed and translated business requirements into functional and non-functional specifications",
        "Worked closely with stakeholders to understand needs, scope problems, and develop business cases from data",
        "Developed real-time monitoring quality metrics using Power BI from SQL Server and MS Excel",
        "Analysed and visualised data using Tableau/Power BI model building"
      ]
    }
  ],
  education: [
    { degree: "Master of Science ‚Äì Engineering Business Management", school: "Coventry University, UK", period: "Jul 2019 ‚Äì Nov 2020" },
    { degree: "Bachelor of Engineering ‚Äì Electronics & Communication", school: "Anna University, India", period: "Jul 2012 ‚Äì Jun 2016" }
  ],
  projects: [
    {
      title: "AI-Powered Trade Analysis Platform",
      type: "Personal Project",
      period: "2025",
      url: "https://stock-monitor-8ak6.onrender.com",
      tech: "Claude Opus 4.6 (Anthropic), Python, Web Development",
      bullets: [
        "Designed and built a LIVE web-based Trade Analysis platform leveraging Claude Opus 4.6 (Anthropic's LLM) ‚Äî deployed at https://stock-monitor-8ak6.onrender.com ‚Äî performing combined financial trade data and international trade flow analysis",
        "Integrated generative AI to automate interpretation of complex market data, surfacing actionable insights from multi-dimensional financial and macroeconomic datasets",
        "Demonstrated hands-on AI product development capability ‚Äî from prompt engineering and LLM integration through to end-user web interface delivery",
        "Showcases ability to identify a real analytical problem, define product requirements, and ship an AI-powered solution independently"
      ]
    }
  ]
};

// ========== CLAUDE API CALL ==========
// ‚îÄ‚îÄ‚îÄ BACKEND API CALLS (no API key needed in browser) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function callBackend(endpoint, payload) {
  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || `Server error ${res.status}`);
  }
  return res.json();
}

// Kept for compatibility ‚Äî routes through backend now
async function callClaude(prompt, systemPrompt = "") {
  const res = await callBackend("/api/generic", { prompt, systemPrompt });
  return res.result;
}

// ========== TOAST ==========
function toast(msg, type = "") {
  const t = document.createElement("div");
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.getElementById("toastContainer").appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// ========== TAB SWITCHING ==========


// ‚îÄ‚îÄ‚îÄ AI JOB RANKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function openRankModal() {
  // Reset state
  document.getElementById('rankLoading').style.display = 'none';
  document.getElementById('rankResults').style.display = 'none';
  document.getElementById('rankEmpty').style.display = 'none';
  document.getElementById('rankError').style.display = 'none';
  document.getElementById('rankFetchPrompt').style.display = 'none';
  openModal('rankModal');

  const jobs = getJobs();
  const realJobs = jobs.filter(j => !j.isDemo);
  if (realJobs.length === 0) {
    document.getElementById('rankEmpty').style.display = 'block';
    return;
  }

  // Show warning if many jobs lack JDs
  const missingJD = realJobs.filter(j => !j.jd).length;
  if (missingJD > 0) {
    document.getElementById('rankFetchPrompt').style.display = 'block';
  }

  document.getElementById('rankLoading').style.display = 'block';

  try {
    // Send jobs to backend for ranking
    const payload = realJobs.map(j => ({
      id: j.id,
      role: j.role,
      company: j.company,
      roleType: j.roleType || '',
      jd: j.jd || ''
    }));

    const data = await callBackend('/api/rank-jobs', { jobs: payload });

    document.getElementById('rankLoading').style.display = 'none';

    if (data.error) {
      document.getElementById('rankError').style.display = 'block';
      document.getElementById('rankError').textContent = 'Error: ' + data.error;
      return;
    }

    // Sort rankings by score descending
    const rankings = data.rankings.sort((a, b) => b.score - a.score);

    // Save scores back to job objects in localStorage
    const allJobs = getJobs();
    rankings.forEach(r => {
      const job = allJobs.find(j => String(j.id) === String(r.id));
      if (job) {
        job.aiScore = r.score;
        job.aiLabel = r.label;
        job.aiReason = r.reason;
        job.aiPriority = r.priority;
      }
    });
    saveJobs(allJobs);
    renderKanban();

    // Build lookup map
    const jobMap = {};
    realJobs.forEach(j => { jobMap[j.id] = j; });

    // Render summary
    const topJobs = rankings.filter(r => r.score >= 7);
    const skipJobs = rankings.filter(r => r.score <= 4);
    document.getElementById('rankSummary').innerHTML = 
      `Analysed <strong>${rankings.length} jobs</strong> ‚Äî <strong style="color:#15803d">${topJobs.length} strong matches</strong>, ` +
      `<strong style="color:#dc2626">${skipJobs.length} weak fits</strong>. Focus your energy on the top ones first.`;

    // Render ranked list
    const scoreColors = {
      'üî• Strong Match': '#fef3c7',
      '‚úÖ Good Fit': '#f0fdf4',
      'üü° Possible': '#fffbeb',
      '‚ùå Weak Fit': '#fff1f2'
    };
    const scoreBorderColors = {
      'üî• Strong Match': '#fde68a',
      '‚úÖ Good Fit': '#bbf7d0',
      'üü° Possible': '#fed7aa',
      '‚ùå Weak Fit': '#fecdd3'
    };
    const priorityColors = {
      'Apply Today': '#dc2626',
      'Apply This Week': '#d97706',
      'Lower Priority': '#6b7280',
      'Skip': '#9ca3af'
    };

    let html = '';
    rankings.forEach((r, idx) => {
      const job = jobMap[r.id] || {};
      const bg = scoreColors[r.label] || '#f8fafc';
      const border = scoreBorderColors[r.label] || '#e2e8f0';
      const priColor = priorityColors[r.priority] || '#6b7280';

      html += `<div style="margin-bottom:12px;padding:14px;background:${bg};border:1.5px solid ${border};border-radius:10px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:18px;font-weight:700;color:var(--gray-600);">#${idx+1}</span>
            <div>
              <div style="font-weight:600;font-size:15px;">${job.role || r.id}</div>
              <div style="font-size:13px;color:var(--gray-500);">${job.company || ''}</div>
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:13px;font-weight:600;">${r.label}</div>
            <div style="font-size:22px;font-weight:800;color:var(--blue);">${r.score}<span style="font-size:13px;font-weight:400;color:var(--gray-400);">/10</span></div>
          </div>
        </div>
        <div style="font-size:13px;color:var(--gray-600);margin-bottom:8px;">${r.reason}</div>
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <span style="font-size:12px;font-weight:600;color:${priColor};">‚è∞ ${r.priority}</span>
          <button onclick="closeModal('rankModal');openApplyKitForJob('${job.id}');"
            style="font-size:12px;padding:4px 10px;background:white;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;color:#7c3aed;">
            ‚ö° Generate Kit ‚Üí
          </button>
        </div>
      </div>`;
    });

    document.getElementById('rankList').innerHTML = html;
    document.getElementById('rankResults').style.display = 'block';

  } catch(e) {
    document.getElementById('rankLoading').style.display = 'none';
    document.getElementById('rankError').style.display = 'block';
    document.getElementById('rankError').textContent = 'Error: ' + e.message;
  }
}

// ‚îÄ‚îÄ‚îÄ IMPORT JOB FROM URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openImportModal() {
  document.getElementById('importUrl').value = '';
  document.getElementById('importStatus').textContent = '';
  document.getElementById('importFormFields').style.display = 'none';
  document.getElementById('importTitle').value = '';
  document.getElementById('importCompany').value = '';
  document.getElementById('importDescription').value = '';
  document.getElementById('importLocation').value = 'Singapore';
  openModal('importJobModal');
  copyBookmarklet();
}

function importJobFromUrl() {
  const url = document.getElementById('importUrl').value.trim();
  if (!url) { toast('Please paste a URL first', 'error'); return; }

  const status = document.getElementById('importStatus');

  // Parse what we can from the URL itself (no scraping needed)
  let company = '', title = '', platform = '';

  if (url.includes('linkedin.com')) {
    platform = 'LinkedIn';
    // Extract company/title hints from URL slug
    // e.g. /jobs/view/product-owner-at-grab-123456/
    const slugMatch = url.match(/\/jobs\/view\/([^/?]+)/);
    if (slugMatch) {
      const slug = slugMatch[1].replace(/-\d+$/, ''); // remove trailing job ID
      const atIdx = slug.lastIndexOf('-at-');
      if (atIdx > 0) {
        title = slug.substring(0, atIdx).replace(/-/g, ' ').replace(/\w/g, c => c.toUpperCase());
        company = slug.substring(atIdx + 4).replace(/-/g, ' ').replace(/\w/g, c => c.toUpperCase());
      } else {
        title = slug.replace(/-/g, ' ').replace(/\w/g, c => c.toUpperCase());
      }
    }
    status.innerHTML = '‚úÖ LinkedIn URL detected! Title & company extracted from URL. <strong>Please paste the job description below</strong> (copy from the LinkedIn page while you are logged in).';
    status.style.color = '#15803d';
  } else if (url.includes('indeed.com')) {
    platform = 'Indeed';
    status.innerHTML = '‚úÖ Indeed URL detected! <strong>Please paste the job description below</strong> (copy from the Indeed page).';
    status.style.color = '#15803d';
  } else if (url.includes('mycareersfuture.gov.sg')) {
    platform = 'MyCareersFuture';
    status.innerHTML = '‚úÖ MyCareersFuture URL detected! <strong>Paste the job description below</strong>.';
    status.style.color = '#15803d';
  } else {
    status.textContent = '‚úÖ URL saved. Fill in the details below.';
    status.style.color = '#15803d';
  }

  // Pre-fill what we extracted
  if (title) document.getElementById('importTitle').value = title;
  if (company) document.getElementById('importCompany').value = company;

  // Guess role type from title
  const tl = title.toLowerCase();
  const roleSelect = document.getElementById('importRoleType');
  if (tl.includes('product owner') || tl.includes(' po ')) roleSelect.value = 'Product Owner';
  else if (tl.includes('product manager') || tl.includes(' pm')) roleSelect.value = 'Product Manager';
  else if (tl.includes('ai') || tl.includes('machine learning')) roleSelect.value = 'AI Product Manager';
  else if (tl.includes('business analyst')) roleSelect.value = 'Business Analyst';

  document.getElementById('importFormFields').style.display = 'block';
  document.getElementById('importDescription').focus();
}

function saveImportedJob() {
  const title = document.getElementById('importTitle').value.trim();
  const company = document.getElementById('importCompany').value.trim();
  if (!title || !company) { toast('Title and Company are required', 'error'); return; }

  const job = {
    id: Date.now(),
    role: title,
    company: company,
    roleType: document.getElementById('importRoleType').value,
    location: document.getElementById('importLocation').value || 'Singapore',
    url: document.getElementById('importUrl').value.trim(),
    jd: document.getElementById('importDescription').value.trim(),
    status: 'wishlist',
    date: new Date().toLocaleDateString('en-GB'),
    notes: '',
    salary: '',
    isDemo: false
  };

  jobs.push(job);
  saveJobs(jobs);
  renderKanban();
  updateStats();
  renderAnalytics();
  closeModal('importJobModal');
  toast(`‚úÖ "${title}" at ${company} added to tracker!`, 'success');
}

function switchTab(tabId, btn) {
  document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
  btn.classList.add("active");
  if (tabId === 'tab3') { renderKanban(); updateStats(); renderAnalytics(); }
}

// ========== DATE HELPERS ==========
function sgDate(d) {
  const date = d ? new Date(d) : new Date();
  const dd = String(date.getDate()).padStart(2,'0');
  const mm = String(date.getMonth()+1).padStart(2,'0');
  const yyyy = date.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}
function daysSince(dateStr) {
  if (!dateStr) return 0;
  const diff = Date.now() - new Date(dateStr).getTime();
  return Math.floor(diff / (1000*60*60*24));
}

// Set header date
document.getElementById("headerDate").textContent = sgDate();

// ========== DAILY GOAL ==========
function getGoalData() {
  const today = new Date().toDateString();
  let g = JSON.parse(localStorage.getItem("goalData") || "{}");
  if (g.date !== today) { g = { date: today, count: 0 }; localStorage.setItem("goalData", JSON.stringify(g)); }
  return g;
}
function updateGoalDisplay() {
  const target = parseInt(document.getElementById("dailyGoalTarget").value) || 5;
  const g = getGoalData();
  const pct = Math.min(100, Math.round((g.count / target) * 100));
  document.getElementById("goalBarFill").style.width = pct + "%";
  document.getElementById("goalText").textContent = `${g.count} / ${target} today ${pct >= 100 ? "‚úÖ" : ""}`;
  const streak = parseInt(localStorage.getItem("streak") || "0");
  document.getElementById("streakBadge").textContent = `üî• ${streak} day streak`;
}
function incrementGoal() {
  const g = getGoalData();
  g.count++;
  localStorage.setItem("goalData", JSON.stringify(g));
  const target = parseInt(document.getElementById("dailyGoalTarget").value) || 5;
  if (g.count === target) { toast("üéâ Daily goal reached!", "success"); let streak = parseInt(localStorage.getItem("streak")||0); localStorage.setItem("streak", streak+1); }
  updateGoalDisplay();
}
updateGoalDisplay();

// ========== KEYWORD ANALYSIS ==========
function isAIRole(jd, roleType) {
  const aiTerms = ["ai","artificial intelligence","machine learning","ml","llm","generative ai","genai","nlp","gpt","claude","openai","foundation model","large language model","ai product","data science","analytics","ai-powered","intelligent automation","conversational ai"];
  const text = (jd + " " + roleType).toLowerCase();
  return aiTerms.some(t => text.includes(t));
}

function analyzeKeywords(jd, roleType) {
  const jdLower = jd.toLowerCase();
  const coreKws = ["agile","stakeholder","business analysis","requirements","kpi","reporting","jira","product","process","data","documentation","transformation","scrum","risk","management"];
  const roleKws = {
    "Business Analyst": ["as-is","to-be","gap analysis","user stories","uat","functional specification","process mapping","use cases","brd","frd","sql","data migration"],
    "Product Owner": ["backlog","product backlog","sprint","user stories","product vision","roadmap","acceptance criteria","velocity","release planning","mvp","safe","scaled agile"],
    "Product Manager": ["product strategy","go-to-market","product roadmap","market research","competitive analysis","okr","product vision","customer journey","revenue","growth","metrics"],
    "Business Development": ["sales","revenue","pipeline","partnerships","crm","lead generation","negotiation","client acquisition","business growth","b2b","market expansion","deals"]
  };
  // Boost AI keywords if JD is AI-related
  const aiKws = ["generative ai","llm","machine learning","ai","prompt engineering","nlp","foundation model","ai product","claude","openai","data science","intelligent automation","ai-powered","model evaluation","rag","fine-tuning"];
  let allKws = [...coreKws, ...(roleKws[roleType] || [])];
  if (isAIRole(jdLower, roleType)) { allKws.push(...aiKws); }
  const found = allKws.filter(k => jdLower.includes(k));
  const missing = allKws.filter(k => !jdLower.includes(k));
  const score = Math.round((found.length / allKws.length) * 100);
  return { found, missing, score };
}

// ========== TAB 2: AI INTERVIEW PREP ==========
let _interviewSession = null;
let _interviewTimer = null;
let _interviewStartTime = null;
let _voiceMode = false;
let _recognition = null;
let _questionCount = 0;
let _answerCount = 0;
let _scores = [];

// ‚îÄ‚îÄ‚îÄ Mode selection radio toggle ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('input[name="ipMode"]').forEach(radio => {
  radio.addEventListener('change', () => {
    document.getElementById('modeChatLabel').style.borderColor = document.getElementById('modeChat').checked ? 'var(--blue)' : 'var(--gray-200)';
    document.getElementById('modeChatLabel').style.background = document.getElementById('modeChat').checked ? 'var(--blue-pale)' : 'white';
    document.getElementById('modeVoiceLabel').style.borderColor = document.getElementById('modeVoice').checked ? 'var(--blue)' : 'var(--gray-200)';
    document.getElementById('modeVoiceLabel').style.background = document.getElementById('modeVoice').checked ? 'var(--blue-pale)' : 'white';
  });
});

async function startInterviewSession() {
  const role = document.getElementById('ipRole').value.trim();
  const company = document.getElementById('ipCompany').value.trim();
  const type = document.getElementById('ipType').value;
  const jd = document.getElementById('ipJD').value.trim();
  const resume = document.getElementById('ipResume').value.trim();
  _voiceMode = document.getElementById('modeVoice').checked;

  if (!role || !company) {
    toast('Please enter the job role and company name', 'warning');
    return;
  }

  const btn = document.getElementById('startInterviewBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Starting interview...';

  try {
    const r = await fetch('/api/interview/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role, company, type, jd, resume })
    });
    const data = await r.json();
    if (data.error) throw new Error(data.error);

    _interviewSession = data.session_id;
    _questionCount = 1;
    _answerCount = 0;
    _scores = [];

    // Switch to session view
    document.getElementById('interviewSetup').style.display = 'none';
    document.getElementById('interviewSession').style.display = 'block';
    document.getElementById('sessionTitle').textContent = `${role} @ ${company}`;
    document.getElementById('sessionMeta').textContent = `${type} interview`;

    // Start timer
    _interviewStartTime = Date.now();
    _interviewTimer = setInterval(updateInterviewTimer, 1000);

    // Render first message
    const chatEl = document.getElementById('interviewChat');
    chatEl.innerHTML = '';
    appendChatMessage('ai', data.message);
    updateInterviewStats();

    // Load company intel in background
    loadCompanyIntel(company, role);

    // Setup voice if selected
    if (_voiceMode) setupVoiceRecognition();

    toast('Interview session started! Good luck! üçÄ', 'success');
  } catch(e) {
    toast('Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'üöÄ Start Interview Session';
  }
}

function appendChatMessage(type, content) {
  const chatEl = document.getElementById('interviewChat');
  const avatar = type === 'ai' ? 'ü§ñ' : 'üë§';

  // Parse markdown-style formatting
  let html = content
    .replace(/\*\*Score:\s*(\d+)\/10\*\*/g, (m, s) => {
      const num = parseInt(s);
      const cls = num >= 7 ? 'score-good' : num >= 5 ? 'score-ok' : 'score-weak';
      return `<span class="score-inline ${cls}">Score: ${s}/10</span>`;
    })
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');

  const msgDiv = document.createElement('div');
  msgDiv.className = `chat-msg ${type}`;
  msgDiv.innerHTML = `
    <div class="chat-avatar">${avatar}</div>
    <div class="chat-bubble">${html}</div>
  `;
  chatEl.appendChild(msgDiv);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function handleInterviewKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendInterviewAnswer();
  }
}

async function sendInterviewAnswer() {
  const input = document.getElementById('interviewInput');
  const answer = input.value.trim();
  if (!answer || !_interviewSession) return;

  const btn = document.getElementById('sendAnswerBtn');
  btn.disabled = true;
  input.value = '';
  input.style.height = '44px';

  // Show user message
  appendChatMessage('user', answer);
  _answerCount++;

  // Show typing indicator
  document.getElementById('typingIndicator').textContent = 'ü§ñ AI is thinking...';

  try {
    const r = await fetch('/api/interview/respond', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: _interviewSession, answer })
    });
    const data = await r.json();
    if (data.error) throw new Error(data.error);

    appendChatMessage('ai', data.message);
    _questionCount = data.question_count;
    if (data.avg_score) {
      _scores.push(data.avg_score);
    }
    updateInterviewStats();

    // Auto-start voice if in voice mode
    if (_voiceMode && _recognition) {
      setTimeout(() => _recognition.start(), 500);
    }
  } catch(e) {
    appendChatMessage('ai', `‚ö†Ô∏è Error: ${e.message}. Please try again.`);
  } finally {
    btn.disabled = false;
    document.getElementById('typingIndicator').textContent = '';
    input.focus();
  }
}

function updateInterviewStats() {
  document.getElementById('ipQCount').textContent = _questionCount;
  document.getElementById('ipACount').textContent = _answerCount;
  const avgScore = _scores.length > 0 ? (_scores.reduce((a, b) => a + b, 0) / _scores.length).toFixed(1) : '‚Äî';
  document.getElementById('ipAvgScore').textContent = avgScore;
}

function updateInterviewTimer() {
  if (!_interviewStartTime) return;
  const elapsed = Math.floor((Date.now() - _interviewStartTime) / 1000);
  const mins = Math.floor(elapsed / 60);
  const secs = elapsed % 60;
  document.getElementById('ipTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
}

async function endInterviewSession() {
  if (!_interviewSession) return;
  if (!confirm('End this interview session? You\'ll get a detailed performance summary.')) return;

  // Stop timer
  if (_interviewTimer) clearInterval(_interviewTimer);
  if (_recognition) { try { _recognition.stop(); } catch(e) {} }

  const endBtn = document.querySelector('#interviewSession .btn-secondary');
  if (endBtn) { endBtn.disabled = true; endBtn.textContent = '‚è≥ Generating summary...'; }

  try {
    const r = await fetch('/api/interview/end', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: _interviewSession })
    });
    const data = await r.json();

    // Show summary
    const summaryCard = document.getElementById('sessionSummaryCard');
    const summaryContent = document.getElementById('sessionSummaryContent');
    summaryCard.style.display = 'block';

    let summaryHtml = data.summary
      .replace(/## ([^\n]+)/g, '<h3 style="font-weight:700;font-size:14px;color:var(--navy);margin:16px 0 8px;">$1</h3>')
      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
      .replace(/\n/g, '<br>');

    summaryHtml += `<div class="divider"></div>
      <div class="grid-4" style="gap:10px;">
        <div style="text-align:center;"><div style="font-size:24px;font-weight:800;color:var(--blue);">${data.total_questions}</div><div style="font-size:11px;color:var(--gray-400);">Questions</div></div>
        <div style="text-align:center;"><div style="font-size:24px;font-weight:800;color:var(--green,#059669);">${data.total_answers}</div><div style="font-size:11px;color:var(--gray-400);">Answers</div></div>
        <div style="text-align:center;"><div style="font-size:24px;font-weight:800;color:#f59e0b;">${data.avg_score || '‚Äî'}</div><div style="font-size:11px;color:var(--gray-400);">Avg Score</div></div>
        <div style="text-align:center;"><div style="font-size:24px;font-weight:800;color:#8b5cf6;">${Math.floor(data.duration_seconds/60)}m ${data.duration_seconds%60}s</div><div style="font-size:11px;color:var(--gray-400);">Duration</div></div>
      </div>`;

    summaryContent.innerHTML = summaryHtml;

    // Store transcript for download
    _lastTranscript = data.transcript;
    _lastSummary = data.summary;

    toast('Interview session ended. Review your summary below!', 'success');
  } catch(e) {
    toast('Error generating summary: ' + e.message, 'error');
  } finally {
    if (endBtn) { endBtn.disabled = false; endBtn.textContent = '‚èπ End Session'; }
    _interviewSession = null;
  }
}

let _lastTranscript = '';
let _lastSummary = '';

function downloadInterviewTranscript() {
  const content = `INTERVIEW SESSION TRANSCRIPT\n${'='.repeat(50)}\n\n${_lastTranscript || 'No transcript available'}\n\n${'='.repeat(50)}\nSESSION SUMMARY\n${'='.repeat(50)}\n\n${_lastSummary || ''}`;
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `interview_transcript_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ‚îÄ Company Intelligence ‚îÄ‚îÄ‚îÄ
async function loadCompanyIntel(company, role) {
  try {
    const r = await fetch('/api/interview/company-intel', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ company, role })
    });
    const data = await r.json();

    const content = document.getElementById('companyIntelContent');
    let html = '';

    if (data.ai_intel) {
      html += data.ai_intel
        .replace(/## ([^\n]+)/g, '<h3 style="font-weight:700;font-size:13px;color:var(--navy);margin:12px 0 6px;">$1</h3>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }

    if (data.web_snippets && data.web_snippets.length > 0) {
      html += '<div class="divider"></div><h3 style="font-weight:700;font-size:13px;color:var(--navy);margin:12px 0 6px;">üîç Web Research Snippets</h3>';
      html += '<div style="font-size:12px;color:var(--gray-500);line-height:1.6;">';
      data.web_snippets.forEach(s => { html += `<div style="padding:6px 0;border-bottom:1px solid var(--gray-100);">‚Ä¢ ${s}</div>`; });
      html += '</div>';
    }

    content.innerHTML = `<div style="font-size:12px;line-height:1.7;color:var(--gray-700);">${html}</div>`;
  } catch(e) {
    document.getElementById('companyIntelContent').innerHTML = `<div style="color:var(--gray-400);font-size:12px;">Could not load company intel: ${e.message}</div>`;
  }
}

function toggleCompanyIntel() {
  const content = document.getElementById('companyIntelContent');
  const toggle = document.getElementById('companyIntelToggle');
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggle.textContent = '‚ñ≤';
  } else {
    content.style.display = 'none';
    toggle.textContent = '‚ñº';
  }
}

// ‚îÄ‚îÄ‚îÄ Voice Mode (Web Speech API) ‚îÄ‚îÄ‚îÄ
function setupVoiceRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    toast('Voice mode not supported in this browser. Falling back to chat mode.', 'warning');
    _voiceMode = false;
    return;
  }

  _recognition = new SpeechRecognition();
  _recognition.continuous = true;
  _recognition.interimResults = true;
  _recognition.lang = 'en-US';

  let finalTranscript = '';
  let interimTranscript = '';

  _recognition.onresult = (event) => {
    interimTranscript = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript + ' ';
      } else {
        interimTranscript += event.results[i][0].transcript;
      }
    }
    document.getElementById('interviewInput').value = finalTranscript + interimTranscript;
    document.getElementById('voiceStatus').textContent = 'üéôÔ∏è Listening... (speak your answer)';
  };

  _recognition.onend = () => {
    document.getElementById('voiceIndicator').style.display = 'none';
    if (finalTranscript.trim()) {
      document.getElementById('interviewInput').value = finalTranscript.trim();
      // Auto-send after a brief pause
      setTimeout(() => {
        if (document.getElementById('interviewInput').value.trim()) {
          sendInterviewAnswer();
        }
      }, 1000);
    }
    finalTranscript = '';
    interimTranscript = '';
  };

  _recognition.onerror = (e) => {
    document.getElementById('voiceIndicator').style.display = 'none';
    if (e.error !== 'aborted') {
      document.getElementById('voiceStatus').textContent = `‚ö†Ô∏è ${e.error}`;
    }
  };

  // Auto-start
  toggleVoiceInput();
}

function toggleVoiceInput() {
  const indicator = document.getElementById('voiceIndicator');
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!_recognition && SpeechRecognition) {
    _recognition = new SpeechRecognition();
    _recognition.continuous = true;
    _recognition.interimResults = true;
    _recognition.lang = 'en-US';

    let finalTranscript = '';
    _recognition.onresult = (event) => {
      let interim = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        if (event.results[i].isFinal) {
          finalTranscript += event.results[i][0].transcript + ' ';
        } else {
          interim += event.results[i][0].transcript;
        }
      }
      document.getElementById('interviewInput').value = finalTranscript + interim;
    };
    _recognition.onend = () => {
      indicator.style.display = 'none';
      if (finalTranscript.trim()) {
        document.getElementById('interviewInput').value = finalTranscript.trim();
        finalTranscript = '';
      }
    };
    _recognition.onerror = () => { indicator.style.display = 'none'; };
  }

  if (!_recognition) {
    toast('Speech recognition not available in this browser', 'warning');
    return;
  }

  if (indicator.style.display === 'none') {
    indicator.style.display = 'block';
    try { _recognition.start(); } catch(e) {}
    document.getElementById('voiceStatus').textContent = 'üéôÔ∏è Listening...';
    document.getElementById('voiceToggleBtn').style.background = '#fee2e2';
    document.getElementById('voiceToggleBtn').textContent = '‚èπ';
  } else {
    indicator.style.display = 'none';
    try { _recognition.stop(); } catch(e) {}
    document.getElementById('voiceToggleBtn').style.background = '';
    document.getElementById('voiceToggleBtn').textContent = 'üéôÔ∏è';
  }
}

// ‚îÄ‚îÄ‚îÄ Interview from Job Tracker ‚îÄ‚îÄ‚îÄ
function prepareInterviewForJob(id) {
  const jobs = getJobs();
  const j = jobs.find(j => String(j.id) === String(id));
  if (!j) return;

  // Switch to Interview Prep tab
  const tab2btn = document.querySelector('.tab-btn:nth-child(2)');
  switchTab('tab2', tab2btn);

  // Pre-fill fields
  if (j.role) document.getElementById('ipRole').value = j.role;
  if (j.company) document.getElementById('ipCompany').value = j.company;
  if (j.jd) document.getElementById('ipJD').value = j.jd;

  toast(`üéØ Ready to prep for: ${j.role} at ${j.company}`, 'success');
}

// ========== JOB STORAGE ==========
const COLS = ["saved","applied","screen","interview","offer","rejected"];
const COL_LABELS = { saved:"üíæ Saved", applied:"üì® Applied", screen:"üìû Recruiter Screen", interview:"üéôÔ∏è Interviewing", offer:"üèÜ Offer", rejected:"‚ùå Rejected" };
const COL_COLORS = { saved:"#6b7280", applied:"#3b82f6", screen:"#f59e0b", interview:"#8b5cf6", offer:"#10b981", rejected:"#ef4444" };

// ‚îÄ‚îÄ‚îÄ STORAGE ‚Äî localStorage + Supabase sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPABASE_ENABLED = true; // will silently fall back if not configured

function getJobs() { return JSON.parse(localStorage.getItem("jobs") || "[]"); }

function saveJobs(jobs) {
  localStorage.setItem("jobs", JSON.stringify(jobs));
  localStorage.setItem("jobs_initialized", "true");
  // Fire-and-forget sync to Supabase
  syncJobsToSupabase(jobs);
}

async function syncJobsToSupabase(jobs) {
  try {
    const realJobs = jobs.filter(j => !j.isDemo);
    if (!realJobs.length) return;
    await fetch('/api/jobs/upsert', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jobs: realJobs })
    });
  } catch(e) { /* silent ‚Äî localStorage is source of truth */ }
}

async function loadJobsFromSupabase() {
  try {
    const res = await fetch('/api/jobs');
    if (!res.ok) return { count: 0, source: 'error' };
    const data = await res.json();
    if (data.error && !data.jobs) return { count: 0, source: 'not_configured' };

    const sbJobs = data.jobs || [];
    if (sbJobs.length === 0) return { count: 0, source: 'empty' };

    // Supabase is the source of truth ‚Äî overwrite localStorage entirely
    // But keep any demo jobs that are local-only
    const local = JSON.parse(localStorage.getItem('jobs') || '[]');
    const demos = local.filter(j => j.isDemo);

    // Merge: for each Supabase job, also pick up any local-only fields
    // (e.g. aiScore computed since last sync)
    const localMap = {};
    local.filter(j => !j.isDemo).forEach(j => { localMap[j.id] = j; });

    const merged = sbJobs.map(sj => {
      const lj = localMap[sj.id] || {};
      return {
        ...sj,
        // If supabase field is empty but local has it, keep local
        jd:              sj.jd || lj.jd || '',
        aiScore:         sj.aiScore != null ? sj.aiScore : lj.aiScore,
        aiLabel:         sj.aiLabel || lj.aiLabel || '',
        aiReason:        sj.aiReason || lj.aiReason || '',
        aiPriority:      sj.aiPriority || lj.aiPriority || '',
        resume_docx_b64: sj.resume_docx_b64 || lj.resume_docx_b64 || '',
        cover_docx_b64:  sj.cover_docx_b64 || lj.cover_docx_b64 || '',
        resume_variant:  sj.resume_variant || lj.resume_variant || '',
        resume_filename: sj.resume_filename || lj.resume_filename || '',
        cover_filename:  sj.cover_filename || lj.cover_filename || '',
      };
    });

    const final = [...demos, ...merged];
    localStorage.setItem('jobs', JSON.stringify(final));
    localStorage.setItem('jobs_initialized', 'true');
    return { count: merged.length, source: 'supabase' };
  } catch(e) {
    console.warn('Supabase load failed, using localStorage:', e.message);
    return { count: 0, source: 'error' };
  }
}

function updateDbStatusLine(loadResult) {
  const el = document.getElementById('dbStatusLine');
  if (!el) return;
  const real = getJobs().filter(j => !j.isDemo);
  const withJD = real.filter(j => j.jd && j.jd.length > 50).length;
  const withScore = real.filter(j => j.aiScore != null).length;
  const withDocs = real.filter(j => j.resume_docx_b64).length;

  if (loadResult.source === 'supabase') {
    el.innerHTML = `‚òÅÔ∏è <strong>${real.length}</strong> jobs synced ¬∑ ${withJD} with JD ¬∑ ${withScore} scored ¬∑ ${withDocs} with docs`;
    el.style.color = '#16a34a';
  } else if (loadResult.source === 'empty') {
    el.innerHTML = `‚òÅÔ∏è Cloud DB connected ‚Äî <strong>no jobs yet</strong>. Import from LinkedIn to get started.`;
    el.style.color = '#0369a1';
  } else if (loadResult.source === 'not_configured') {
    el.innerHTML = `‚ö†Ô∏è Supabase not configured ‚Äî data saved locally only`;
    el.style.color = '#b45309';
  } else {
    const localCount = getJobs().filter(j => !j.isDemo).length;
    el.innerHTML = localCount > 0
      ? `üíæ <strong>${localCount}</strong> jobs in local storage (Supabase offline)`
      : `üíæ No jobs yet ‚Äî import from LinkedIn`;
    el.style.color = '#6b7280';
  }
}

function initSampleJobs() {
  // Only show demo cards on very first visit, and only if Supabase is empty
  if (localStorage.getItem('jobs_initialized')) return;
  localStorage.setItem('jobs_initialized', 'true');
  // Don't insert demos ‚Äî user will import their own jobs
}

async function confirmClearAll() {
  const real = getJobs().filter(j => !j.isDemo);
  const msg = real.length > 0
    ? `‚ö†Ô∏è This will permanently delete ALL ${real.length} jobs from BOTH your browser AND the cloud database.\n\nThis cannot be undone. Are you sure?`
    : `Clear local storage and reset? (No cloud jobs found)`;
  if (!confirm(msg)) return;
  if (real.length > 0 && !confirm('Last chance ‚Äî delete everything and start fresh?')) return;

  // Clear cloud
  try {
    await fetch('/api/jobs/clear-all', { method: 'POST' });
  } catch(e) {}

  // Clear local
  localStorage.removeItem('jobs');
  localStorage.removeItem('jobs_initialized');

  renderKanban(); updateStats(); renderAnalytics();
  updateDbStatusLine({ source: 'empty' });
  toast('üóë All jobs cleared ‚Äî ready for a fresh import!', 'success');
}


// ========== LIST VIEW (replaces Kanban) ==========

// Stage background colours (light tints)
const COL_BG = {
  saved: "#f8fafc", applied: "#eff6ff", screen: "#fffbeb",
  interview: "#faf5ff", offer: "#f0fdf4", rejected: "#fff1f2"
};

function renderKanban() {
  const jobs = getJobs();
  const container = document.getElementById("jobListView");
  if (!container) return;
  container.innerHTML = "";

  // Group by status, sort each group by AI score descending
  const grouped = {};
  COLS.forEach(col => { grouped[col] = []; });
  jobs.forEach(j => {
    j.status = (j.status === 'wishlist') ? 'saved' : (j.status || 'saved');
    (grouped[j.status] || (grouped['saved'] = grouped['saved'] || [])).push(j);
  });
  // Sort each column by aiScore desc (unscored jobs go to bottom)
  COLS.forEach(col => {
    if (grouped[col]) {
      grouped[col].sort((a, b) => {
        const sa = a.aiScore != null ? a.aiScore : -1;
        const sb = b.aiScore != null ? b.aiScore : -1;
        return sb - sa;
      });
    }
  });

  let anyJobs = false;
  COLS.forEach(col => {
    const colJobs = grouped[col] || [];
    if (colJobs.length === 0) return;
    anyJobs = true;

    const group = document.createElement("div");
    group.className = "stage-group";
    group.id = "stage-" + col;

    const headerBg = COL_BG[col];
    const dotColor = COL_COLORS[col];

    group.innerHTML = `
      <div class="stage-group-header" style="background:${headerBg};border:1.5px solid ${dotColor}22;" onclick="toggleStage('${col}')">
        <div style="width:10px;height:10px;border-radius:50%;background:${dotColor};flex-shrink:0;"></div>
        <span class="stage-group-title" style="color:${dotColor};">${COL_LABELS[col]}</span>
        <span class="stage-group-count" style="background:${dotColor};color:white;">${colJobs.length}</span>
        <span class="stage-group-toggle" style="color:${dotColor};">‚ñº</span>
      </div>
      <div class="stage-rows" id="rows-${col}">
        <div class="job-list-header">
          <div>Company</div>
          <div>Role</div>
          <div>AI Score</div>
          <div>Salary</div>
          <div>Actions</div>
        </div>
        ${colJobs.map(j => renderRow(j)).join("")}
      </div>`;
    container.appendChild(group);
  });

  if (!anyJobs) {
    container.innerHTML = `<div style="text-align:center;padding:60px 20px;color:var(--gray-400);">
      <div style="font-size:48px;margin-bottom:12px;">üìã</div>
      <div style="font-size:15px;font-weight:600;">No jobs tracked yet</div>
      <div style="font-size:13px;margin-top:6px;">Click <strong>+ Add New Job</strong> or <strong>üì• Import from LinkedIn</strong> to get started</div>
    </div>`;
  }

  updateFollowups();
}

function toggleStage(col) {
  const group = document.getElementById("stage-" + col);
  if (group) group.classList.toggle("collapsed");
}

function renderRow(j) {
  j.roleType    = j.roleType    || '';
  j.source      = j.source      || 'LinkedIn';
  j.dateApplied = j.dateApplied || new Date().toISOString();
  const rowClass = j.isDemo ? "job-row demo-row" : "job-row";

  const moveButtons = `
    <select class="form-control" style="padding:3px 6px;font-size:11px;height:26px;min-width:90px;display:inline-block;width:auto;"
      onchange="moveJob('${j.id}', this.value); this.value='${j.status}';">
      ${COLS.map(c => `<option value="${c}" ${c === j.status ? 'selected' : ''}>${COL_LABELS[c].replace(/[^\w\s]/g,'').trim()}</option>`).join('')}
    </select>`;

  // AI score display
  const hasScore = j.aiScore != null;
  const scoreEmoji = hasScore
    ? (j.aiScore >= 8 ? 'üî•' : j.aiScore >= 6 ? '‚úÖ' : j.aiScore >= 4 ? 'üü°' : '‚ùå')
    : '';
  const scoreBg = hasScore
    ? (j.aiScore >= 8 ? '#fef3c7' : j.aiScore >= 6 ? '#f0fdf4' : j.aiScore >= 4 ? '#fffbeb' : '#fff1f2')
    : 'transparent';
  const scoreBorder = hasScore
    ? (j.aiScore >= 8 ? '#fde68a' : j.aiScore >= 6 ? '#bbf7d0' : j.aiScore >= 4 ? '#fed7aa' : '#fecdd3')
    : 'transparent';
  const reasonTip = j.aiReason ? j.aiReason.replace(/"/g,"'") : '';
  const scoreText = hasScore
    ? `<div title="${reasonTip}" style="cursor:help;">
        <span style="background:${scoreBg};border:1.5px solid ${scoreBorder};padding:2px 8px;border-radius:99px;font-size:12px;font-weight:700;">${scoreEmoji} ${j.aiScore}/10</span>
        ${j.aiPriority ? `<div style="font-size:10px;color:var(--gray-400);margin-top:2px;">${j.aiPriority}</div>` : ''}
       </div>`
    : `<span style="color:var(--gray-300);font-size:11px;">${j.jd ? '‚ñ∂ Run Rank' : 'No JD yet'}</span>`;

  // JD indicator
  const jdStatus = j.jd
    ? `<span style="font-size:10px;color:#15803d;">‚úÖ JD</span>`
    : (j.url ? `<span style="font-size:10px;color:#f59e0b;cursor:pointer;" onclick="fetchJDForJob('${j.id}')">‚ö° Fetch JD</span>` : `<span style="font-size:10px;color:var(--gray-300);">No JD</span>`);

  return `<div class="${rowClass}" data-id="${j.id}">
    <div>
      <div class="job-row-company">${j.isDemo ? '‚ö†Ô∏è ' : ''}${j.company}</div>
      ${j.roleType ? `<div style="font-size:10px;color:var(--blue);font-weight:600;">${j.roleType}</div>` : ''}
      <div style="margin-top:2px;">${jdStatus}</div>
    </div>
    <div>
      <div class="job-row-role">${j.role}</div>
      <div style="font-size:10px;color:var(--gray-400);margin-top:2px;">${sgDate(j.dateApplied)}</div>
    </div>
    <div>${scoreText}</div>
    <div style="font-size:12px;color:var(--blue);">${j.salary ? 'S$'+j.salary : '<span style="color:var(--gray-300);">‚Äî</span>'}</div>
    <div class="job-row-actions">
      ${j.url ? `<a href="${j.url}" target="_blank" class="btn btn-xs btn-primary" style="text-decoration:none;">üîó</a>` : ''}
      <button class="btn btn-xs btn-secondary" onclick="openJobDetail('${j.id}')" title="View details">üëÅ</button>
      <button class="btn btn-xs" style="background:#f5f3ff;color:#7c3aed;border:1px solid #ddd6fe;" onclick="openApplyKitForJob('${j.id}')" title="Generate resume & cover letter">‚ö° Kit</button>
      ${moveButtons}
      <button class="btn btn-xs btn-ghost" onclick="deleteJob('${j.id}')" title="Delete" style="color:var(--danger);">‚úï</button>
    </div>
  </div>`;
}

function moveJob(id, newCol) {
  const jobs = getJobs();
  const j = jobs.find(j => String(j.id) === String(id));
  if (j) { j.status = newCol; saveJobs(jobs); renderKanban(); updateStats(); toast(`Moved to ${COL_LABELS[newCol].replace(/[^\w\s]/g,"").trim()}`, "success"); }
}

// ‚îÄ‚îÄ‚îÄ FETCH JD FOR A SINGLE JOB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchJDForJob(id) {
  const jobs = getJobs();
  const j = jobs.find(j => String(j.id) === String(id));
  if (!j || !j.url) return;

  toast('Fetching JD...', '');
  try {
    const data = await callBackend('/api/fetch-jd', { url: j.url });
    if (data.jd && data.jd.length > 50) {
      j.jd = data.jd;
      if (data.title && (!j.role || j.role.length < 3)) j.role = data.title;
      if (data.company && (!j.company || j.company === 'Unknown')) j.company = data.company;
      saveJobs(jobs);
      renderKanban();
      toast('‚úÖ JD fetched!', 'success');
    } else {
      toast('‚ö†Ô∏è Could not auto-fetch ‚Äî LinkedIn requires login. Open the job link and paste the JD manually via View Details.', 'error');
    }
  } catch(e) {
    toast('Failed: ' + e.message, 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ BULK FETCH JDs FOR ALL JOBS MISSING THEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchMissingJDs() {
  const jobs = getJobs();
  const missing = jobs.filter(j => !j.jd && j.url && !j.isDemo);
  if (missing.length === 0) return;

  toast(`Fetching JDs for ${missing.length} jobs in background...`, '');
  let fetched = 0;
  for (const j of missing) {
    try {
      const data = await callBackend('/api/fetch-jd', { url: j.url });
      if (data.jd && data.jd.length > 50) {
        j.jd = data.jd;
        if (data.title && (!j.role || j.role.length < 3)) j.role = data.title;
        if (data.company && (!j.company || j.company === 'Unknown')) j.company = data.company;
        fetched++;
      }
    } catch(e) { /* silently skip */ }
    // Small delay to avoid rate limiting
    await new Promise(r => setTimeout(r, 800));
  }
  if (fetched > 0) {
    saveJobs(jobs);
    renderKanban();
    toast(`‚úÖ Fetched JDs for ${fetched} jobs. Run AI Ranking now!`, 'success');
  } else {
    toast('‚ö†Ô∏è LinkedIn requires login to fetch JDs ‚Äî paste them manually via üëÅ View Details.', '');
  }
}

// ‚îÄ‚îÄ‚îÄ TAILOR RESUME FOR A SPECIFIC JOB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tailorForJob(id) {
  const jobs = getJobs();
  const j = jobs.find(j => String(j.id) === String(id));
  if (!j) return;

  // Switch to Auto-Apply Centre tab (has Full Kit)
  const tab4btn = document.querySelector('.tab-btn:nth-child(4)');
  switchTab('tab4', tab4btn);

  // Pre-fill the Full Kit fields
  const kitCompany = document.getElementById('kitCompany');
  const kitRole = document.getElementById('kitRole');
  const kitJD = document.getElementById('kitJD');
  const kitRoleType = document.getElementById('kitRoleType');

  if (kitCompany) kitCompany.value = j.company || '';
  if (kitRole) kitRole.value = j.role || '';
  if (kitJD && j.jd) kitJD.value = j.jd;
  if (kitRoleType && j.roleType) {
    const opts = Array.from(kitRoleType.options).map(o => o.value);
    const match = opts.find(o => o.toLowerCase() === (j.roleType||'').toLowerCase());
    if (match) kitRoleType.value = match;
  }

  // Show toast with job context
  toast(`‚ú® Ready to tailor for: ${j.role} at ${j.company}`, 'success');

  // Scroll to top
  window.scrollTo(0, 0);
}

function deleteJob(id) {
  if (!confirm("Delete this job card?")) return;
  const jobs = getJobs().filter(j => j.id !== id);
  saveJobs(jobs);
  // Delete from Supabase too
  fetch('/api/jobs/delete', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id}) }).catch(()=>{});
  renderKanban(); updateStats();
  toast("Job removed");
}

// ========== JOB DETAIL MODAL ==========
function openJobDetail(id) {
  const jobs = getJobs();
  const j = jobs.find(j => String(j.id) === String(id));
  if (!j) return;

  document.getElementById("jdModalTitle").textContent = `üìã ${j.company} ‚Äî ${j.role}`;
  document.getElementById("jdModalCompany").textContent = j.company;
  document.getElementById("jdModalRole").textContent = `${j.role}${j.roleType ? " ¬∑ " + j.roleType : ""}`;

  // Badges
  const badgeColors = { High:"#fee2e2;color:#991b1b", Medium:"#fef3c7;color:#92400e", Low:"#f0fdf4;color:#166534" };
  const bc = badgeColors[j.priority] || "var(--gray-100);color:var(--gray-600)";
  const aiScoreBadge = j.aiScore != null
    ? `<span style="background:#fef3c7;color:#92400e;padding:2px 10px;border-radius:99px;font-size:11px;font-weight:700;">${j.aiScore >= 8 ? 'üî•' : j.aiScore >= 6 ? '‚úÖ' : j.aiScore >= 4 ? 'üü°' : '‚ùå'} ${j.aiScore}/10 fit</span>`
    : '';
  document.getElementById("jdModalBadges").innerHTML = `
    ${aiScoreBadge}
    ${j.status ? `<span style="background:var(--blue-pale);color:var(--blue);padding:2px 10px;border-radius:99px;font-size:11px;font-weight:700;">${j.status}</span>` : ""}
    ${j.salary ? `<span style="background:#f0fdf4;color:#166534;padding:2px 10px;border-radius:99px;font-size:11px;font-weight:700;">S$${j.salary}</span>` : ""}
    ${j.aiPriority ? `<span style="background:#f0f9ff;color:#0369a1;padding:2px 10px;border-radius:99px;font-size:11px;font-weight:600;">‚è∞ ${j.aiPriority}</span>` : ""}`;

  // Show AI reason if available
  const aiReasonEl = document.getElementById("jdModalAIReason");
  if (aiReasonEl) {
    if (j.aiReason) {
      aiReasonEl.textContent = j.aiReason;
      aiReasonEl.style.display = "block";
    } else {
      aiReasonEl.style.display = "none";
    }
  }

  // Apply URL
  if (j.url) {
    document.getElementById("jdModalApplyBtn").style.display = "inline-flex";
    document.getElementById("jdModalApplyBtn").href = j.url;
    document.getElementById("jdModalUrlRow").style.display = "block";
    document.getElementById("jdModalUrlText").value = j.url;
    document.getElementById("jdModalNoUrl").style.display = "none";
  } else {
    document.getElementById("jdModalApplyBtn").style.display = "none";
    document.getElementById("jdModalUrlRow").style.display = "none";
    document.getElementById("jdModalNoUrl").style.display = "block";
  }

  // JD
  const jdEl = document.getElementById("jdModalJD");
  if (j.jd && j.jd.trim()) {
    jdEl.textContent = j.jd;
    jdEl.style.color = "var(--gray-700)";
  } else {
    jdEl.textContent = "No job description captured. Use the LinkedIn bookmarklet to save jobs with their JD automatically.";
    jdEl.style.color = "var(--gray-400)";
  }

  // Kit button
  document.getElementById("jdModalKitBtn").onclick = () => { closeModal("jobDetailModal"); openApplyKitForJob(id); };

  openModal("jobDetailModal");
}

function copyJobUrl() {
  const url = document.getElementById("jdModalUrlText").value;
  if (!url) { toast("No URL to copy", "error"); return; }
  navigator.clipboard.writeText(url).then(() => toast("Apply link copied! üìã", "success"));
}

function copyJobJD() {
  const text = document.getElementById("jdModalJD").textContent;
  if (!text.trim()) { toast("No JD to copy", "error"); return; }
  navigator.clipboard.writeText(text).then(() => toast("JD copied! üìã", "success"));
}

function updateStats() {
  const jobs = getJobs();
  const total = jobs.filter(j => j.status !== "saved").length;
  const interviews = jobs.filter(j => j.status === "interview").length;
  const offers = jobs.filter(j => j.status === "offer").length;
  const applied = jobs.filter(j => ["applied","screen","interview","offer","rejected"].includes(j.status)).length;
  const rate = applied > 0 ? Math.round((interviews/applied)*100) : 0;
  document.getElementById("statTotal").textContent = total;
  document.getElementById("statInterviews").textContent = interviews;
  document.getElementById("statOffers").textContent = offers;
  document.getElementById("statRate").textContent = rate + "%";
}

function updateFollowups() {
  const jobs = getJobs().filter(j => j.status === "applied" && daysSince(j.dateApplied) >= 7);
  const el = document.getElementById("followupList");
  if (!jobs.length) { el.innerHTML = '<div style="color:var(--gray-400);font-size:12px;text-align:center;padding:20px;">No follow-ups needed üéâ</div>'; return; }
  el.innerHTML = jobs.map(j => `<div class="followup-item">
    <div class="followup-company">${j.company}</div>
    <div class="followup-role">${j.role}</div>
    <div class="followup-days">${daysSince(j.dateApplied)} days ¬∑ No response</div>
    <button class="btn btn-xs btn-secondary" style="margin-top:6px;" onclick="generateFollowUpForJob('${j.id}')">‚úâÔ∏è Write Follow-Up</button>
  </div>`).join("");
}

// ANALYTICS
function renderAnalytics() {
  const jobs = getJobs();
  // Funnel
  const stages = [
    { label: "Applied", col: ["applied","screen","interview","offer","rejected"], color: "#3b82f6" },
    { label: "Screened", col: ["screen","interview","offer"], color: "#f59e0b" },
    { label: "Interviewed", col: ["interview","offer"], color: "#8b5cf6" },
    { label: "Offered", col: ["offer"], color: "#10b981" }
  ];
  const total = jobs.length || 1;
  document.getElementById("funnelChart").innerHTML = stages.map(s => {
    const count = jobs.filter(j => s.col.includes(j.status)).length;
    const pct = Math.max(10, Math.round((count/total)*100));
    return `<div class="funnel-bar">
      <div class="funnel-label">${s.label} (${count})</div>
      <div class="funnel-track"><div class="funnel-fill" style="width:${pct}%;background:${s.color};">${count > 0 ? count : ""}</div></div>
    </div>`;
  }).join("");
  
  // Weekly (mock with stored data)
  const weeks = ["W1","W2","W3","W4","W5","W6"];
  const maxVal = Math.max(jobs.length, 5);
  const weekVals = weeks.map((_,i) => Math.max(0, Math.round(Math.random()*3)));
  weekVals[5] = jobs.filter(j => daysSince(j.dateApplied) < 7).length;
  document.getElementById("weeklyChart").innerHTML = weekVals.map((v,i) => {
    const h = Math.max(4, Math.round((v/maxVal)*80));
    return `<div class="chart-bar-wrap"><div class="chart-bar" style="height:${h}px;" title="${v} apps"></div><div class="chart-bar-label">${weeks[i]}</div></div>`;
  }).join("");
  
  // Source breakdown
  const sources = {};
  jobs.forEach(j => { sources[j.source||"Unknown"] = (sources[j.source||"Unknown"]||0)+1; });
  document.getElementById("sourceBreakdown").innerHTML = Object.entries(sources).map(([s,n]) => 
    `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:12px;">
      <div style="flex:1;">${s}</div>
      <div style="width:80px;height:6px;background:var(--gray-100);border-radius:99px;overflow:hidden;"><div style="width:${Math.round((n/total)*100)}%;height:100%;background:var(--blue);border-radius:99px;"></div></div>
      <div style="color:var(--gray-500);width:20px;text-align:right;">${n}</div>
    </div>`).join("") || '<div style="color:var(--gray-400);font-size:12px;">No data yet</div>';
}

// ========== JOB MODAL ==========
function openAddJobModal() {
  document.getElementById("mCompany").value="";document.getElementById("mRole").value="";
  document.getElementById("mUrl").value="";document.getElementById("mSalary").value="";
  document.getElementById("mNotes").value="";
  document.getElementById("addJobModal").style.display="flex";
}
function saveJob() {
  const company = document.getElementById("mCompany").value.trim();
  const role = document.getElementById("mRole").value.trim();
  if (!company||!role) { toast("Company and Role are required", "error"); return; }
  const jobs = getJobs();
  jobs.push({
    id: "j"+Date.now(),
    company, role,
    roleType: document.getElementById("mRoleType").value,
    status: document.getElementById("mStatus").value,
    url: document.getElementById("mUrl").value.trim(),
    salary: document.getElementById("mSalary").value.trim(),
    source: document.getElementById("mSource").value,
    priority: document.getElementById("mPriority").value,
    notes: document.getElementById("mNotes").value.trim(),
    dateApplied: new Date().toISOString(),
    checklist: {}
  });
  saveJobs(jobs);
  closeModal("addJobModal");
  renderKanban(); updateStats(); renderAnalytics();
  toast("Job added to tracker! üéâ", "success");
  incrementGoal();
}

// ========== CHECKLIST ==========
const CHECKLIST_ITEMS = [
  "Resume tailored for this JD",
  "Cover letter personalised",
  "LinkedIn profile updated to match",
  "Company researched on LinkedIn",
  "Hiring manager found on LinkedIn",
  "Application submitted",
  "Confirmation email received",
  "Follow-up reminder set (7 days)"
];
let currentChecklistJobId = null;

function openChecklist(jobId) {
  currentChecklistJobId = jobId;
  const jobs = getJobs();
  const j = jobs.find(j => String(j.id) === String(jobId));
  document.getElementById("checklistTitle").textContent = `‚úÖ Application Checklist ‚Äì ${j?.company||""}`;
  const checked = j?.checklist || {};
  document.getElementById("checklistItems").innerHTML = CHECKLIST_ITEMS.map((item, i) => 
    `<div class="checklist-item ${checked[i] ? 'done' : ''}">
      <input type="checkbox" id="cli${i}" ${checked[i]?'checked':''} onchange="toggleChecklist(${i})">
      <label for="cli${i}">${item}</label>
    </div>`).join("");
  document.getElementById("checklistModal").style.display="flex";
}
function toggleChecklist(idx) {
  const jobs = getJobs();
  const j = jobs.find(j => String(j.id) === String(currentChecklistJobId));
  if (!j) return;
  if (!j.checklist) j.checklist = {};
  j.checklist[idx] = document.getElementById("cli"+idx).checked;
  const item = document.getElementById("cli"+idx).closest(".checklist-item");
  if (j.checklist[idx]) item.classList.add("done"); else item.classList.remove("done");
  saveJobs(jobs);
}
function saveChecklist() { toast("Checklist saved!", "success"); closeModal("checklistModal"); }

// ========== APPLY KIT FOR JOB ==========
async function openApplyKitForJob(jobId) {
  const jobs = getJobs();
  const j = jobs.find(j => String(j.id) === String(jobId));
  if (!j) return;

  document.getElementById("applyKitTitle").textContent = `‚ö° Apply Kit ‚Äì ${j.company} ¬∑ ${j.role}`;
  document.getElementById("applyKitModal").style.display = "flex";

  // If docs already generated, show them immediately without re-generating
  if (j.resume_docx_b64 && j.cover_docx_b64) {
    showKitDocs(j, j.resume_docx_b64, j.cover_docx_b64, j.resume_variant || 'BA', j.resume_filename, j.cover_filename, j.resume_generated_at);
    return;
  }

  // Otherwise generate fresh
  await generateKitDocs(j);
}

function showKitDocs(j, resumeB64, coverB64, variant, resumeFile, coverFile, generatedAt) {
  const variantLabels = { DPM: 'Digital Product Manager', PO: 'Product Owner', BA: 'Business Analyst' };
  const variantLabel = variantLabels[variant] || variant;
  const generatedLabel = generatedAt ? `Generated ${new Date(generatedAt).toLocaleDateString('en-SG')}` : 'Previously generated';

  document.getElementById("applyKitContent").innerHTML = `
    <div style="grid-column:1/-1;">
      <div style="background:#f0fdf4;border:1.5px solid #bbf7d0;border-radius:10px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-weight:700;font-size:14px;">‚úÖ Documents ready</div>
          <div style="font-size:12px;color:var(--gray-500);">${variantLabel} template ¬∑ ${generatedLabel}</div>
        </div>
        <button class="btn btn-sm btn-ghost" onclick="generateKitDocs(getJobs().find(j=>j.id==='${j.id}'))" style="font-size:12px;">üîÑ Regenerate</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="border:1.5px solid var(--gray-200);border-radius:10px;padding:16px;text-align:center;">
          <div style="font-size:28px;margin-bottom:8px;">üìÑ</div>
          <div style="font-weight:600;margin-bottom:4px;">Tailored Resume</div>
          <div style="font-size:12px;color:var(--gray-400);margin-bottom:12px;">ATS-optimised ¬∑ ${variantLabel}</div>
          <button class="btn btn-primary" onclick="downloadB64('${resumeB64}','${resumeFile || 'Resume_' + j.company + '.docx'}')">‚¨á Download Resume.docx</button>
        </div>
        <div style="border:1.5px solid var(--gray-200);border-radius:10px;padding:16px;text-align:center;">
          <div style="font-size:28px;margin-bottom:8px;">‚úâÔ∏è</div>
          <div style="font-weight:600;margin-bottom:4px;">Cover Letter</div>
          <div style="font-size:12px;color:var(--gray-400);margin-bottom:12px;">1 page ¬∑ tailored to ${j.company}</div>
          <button class="btn btn-secondary" onclick="downloadB64('${coverB64}','${coverFile || 'CoverLetter_' + j.company + '.docx'}')">‚¨á Download Cover.docx</button>
        </div>
      </div>
      ${!j.jd ? '<div style="margin-top:12px;padding:10px;background:#fffbeb;border-radius:8px;font-size:12px;color:#92400e;">‚ö†Ô∏è No JD was captured ‚Äî documents use your profile only. Add a JD and regenerate for better tailoring.</div>' : ''}
      <div style="text-align:center;margin-top:16px;">
        <button class="btn btn-ghost btn-sm" onclick="closeModal(\'applyKitModal\')">Close</button>
      </div>
    </div>`;
}

function downloadB64(b64, filename) {
  const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  const blob = new Blob([bytes], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

async function generateKitDocs(j) {
  if (!j) return;
  document.getElementById("applyKitContent").innerHTML = `
    <div style="grid-column:1/-1;text-align:center;padding:40px;">
      <span class="spinner spinner-blue" style="width:32px;height:32px;border-width:3px;"></span>
      <div style="margin-top:12px;color:var(--gray-400);">Generating tailored resume & cover letter for ${j.company}...</div>
      <div style="margin-top:6px;font-size:12px;color:var(--gray-400);">Takes about 5 seconds</div>
    </div>`;

  const isAI = j.jd ? /(ai|machine learning|llm|generative|artificial intelligence|claude|gpt|openai)/i.test(j.jd) : false;

  try {
    const data = await callBackend('/api/generate-docs', {
      role: j.role, company: j.company, jd: j.jd || '', roleType: j.roleType || '', isAI
    });
    if (data.error) throw new Error(data.error);

    // Save to job in localStorage + Supabase
    const allJobs = getJobs();
    const jIdx = allJobs.findIndex(jb => String(jb.id) === String(j.id));
    if (jIdx > -1) {
      allJobs[jIdx].resume_docx_b64 = data.resume_b64;
      allJobs[jIdx].cover_docx_b64 = data.cover_b64;
      allJobs[jIdx].resume_variant = data.variant;
      allJobs[jIdx].resume_filename = data.resume_filename;
      allJobs[jIdx].cover_filename = data.cover_filename;
      allJobs[jIdx].resume_generated_at = new Date().toISOString();
      saveJobs(allJobs);
      j = allJobs[jIdx]; // update local ref
    }

    showKitDocs(j, data.resume_b64, data.cover_b64, data.variant, data.resume_filename, data.cover_filename, new Date().toISOString());
    toast("‚úÖ Documents ready!", "success");
  } catch(e) {
    document.getElementById("applyKitContent").innerHTML = `
      <div style="grid-column:1/-1;padding:20px;color:red;text-align:center;">
        <div style="font-size:24px;margin-bottom:8px;">‚ö†Ô∏è</div>
        <div>Error: ${e.message}</div>
        <button class="btn btn-ghost btn-sm" style="margin-top:12px;" onclick="closeModal('applyKitModal')">Close</button>
      </div>`;
  }
}

// ========== FOLLOW-UP GENERATOR ==========
async function generateFollowUpForJob(jobId) {
  const jobs = getJobs();
  const j = jobs.find(j => String(j.id) === String(jobId));
  if (!j) return;
  toast('Generating follow-up email...', '');
  try {
    const data = await callBackend("/api/follow-up", {
      company: j.company, role: j.role, days: daysSince(j.dateApplied)
    });
    // Show in a simple alert/copy prompt
    const text = data.result || "Could not generate follow-up.";
    const el = document.createElement('div');
    el.innerHTML = `<div class="modal-overlay" style="display:flex;z-index:9999;" onclick="if(event.target===this)this.remove()">
      <div class="modal" style="max-width:560px;">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
        <div class="modal-title">üìß Follow-Up Email ‚Äî ${j.company}</div>
        <pre style="white-space:pre-wrap;font-size:13px;line-height:1.7;background:var(--gray-50);border-radius:8px;padding:16px;max-height:400px;overflow-y:auto;">${text}</pre>
        <button class="btn btn-primary btn-sm" style="margin-top:12px;" onclick="navigator.clipboard.writeText(this.closest('.modal').querySelector('pre').textContent);toast('Copied!','success');">üìã Copy Email</button>
      </div>
    </div>`;
    document.body.appendChild(el.firstChild);
    toast("Follow-up email ready!", "success");
  } catch(e) {
    toast("Error generating follow-up: " + e.message, "error");
  }
}

async function generateFollowUp() {
  // Legacy function - generate from kit inputs
  const company = (document.getElementById("fuCompany")?.value || "").trim() || "the company";
  const role = (document.getElementById("fuRole")?.value || "").trim() || "the role";
  const days = (document.getElementById("fuDays")?.value) || "7";
  toast('Generating follow-up...', '');
  try {
    const data = await callBackend("/api/follow-up", { company, role, days });
    toast("Follow-up ready!", "success");
    // Show in modal
    const text = data.result || "Could not generate.";
    const el = document.createElement('div');
    el.innerHTML = `<div class="modal-overlay" style="display:flex;z-index:9999;" onclick="if(event.target===this)this.remove()">
      <div class="modal" style="max-width:560px;">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
        <div class="modal-title">üìß Follow-Up Email</div>
        <pre style="white-space:pre-wrap;font-size:13px;line-height:1.7;background:var(--gray-50);border-radius:8px;padding:16px;max-height:400px;overflow-y:auto;">${text}</pre>
        <button class="btn btn-primary btn-sm" style="margin-top:12px;" onclick="navigator.clipboard.writeText(this.closest('.modal').querySelector('pre').textContent);toast('Copied!','success');">üìã Copy Email</button>
      </div>
    </div>`;
    document.body.appendChild(el.firstChild);
  } catch(e) {
    toast("Error: " + e.message, "error");
  }
}

// ========== EXPORT CSV ==========
function exportCSV() {
  const jobs = getJobs();
  const headers = ["Company","Role","Role Type","Status","Priority","Salary","Source","Date Applied","Days Since","URL","Notes"];
  const rows = jobs.map(j => [j.company,j.role,j.roleType,j.status,j.priority,j.salary,j.source,sgDate(j.dateApplied),daysSince(j.dateApplied),j.url,j.notes].map(v => `"${(v||"").toString().replace(/"/g,'""')}"`));
  const csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "job_applications.csv"; a.click();
  toast("CSV exported!", "success");
}

// ========== PRODUCT FRAMING CONTEXT ==========
const PRODUCT_FRAMING = `
CRITICAL POSITIONING ‚Äî She is transitioning from CONSULTING/SERVICE delivery to IN-HOUSE PRODUCT roles:
- Reframe "KPMG consultant" ‚Üí "Product Owner for Loan IQ product squad"
- Reframe "client delivery" ‚Üí "shipped product features, owned backlog, drove sprint outcomes"
- Reframe "5% project profit" ‚Üí "drove ~5% business value through product scope decisions"
- Reframe "saved 30 man-days" ‚Üí "identified automation opportunity, drove product feature that eliminated 30 man-days of manual work"
- DO NOT use: consultant, client, engagement, billable, service delivery, account
- DO USE: product, squad, roadmap, discovery, iteration, user value, outcome, feature, backlog, sprint, release
`;

// ========== QUICK APPLY SPEED KIT ==========
const SPEED_KIT_QA = [
  { icon:"üë§", field:"About You", q:"Tell us about yourself / Walk me through your background",
    a:`I'm Amretha Karthikeyan, a SAFe 6.0 certified Product Owner and Lead Business Analyst with 5+ years owning product backlogs in fintech and banking. At KPMG Singapore, I was the de-facto Product Owner for Loan IQ ‚Äî a core banking platform ‚Äî leading cross-functional squads to ship features used by enterprise banks. Outside of work, I independently built and deployed a live AI-powered Trade Analysis platform using Claude Opus 4.6 ‚Äî it combines financial trade data and international trade flow analysis and is live at https://stock-monitor-8ak6.onrender.com. It reflects my genuine interest in building with AI, not just talking about it. I'm now looking for an in-house product role where I can own the roadmap end-to-end and drive measurable outcomes.`},
  { icon:"üîÑ", field:"Agile / SAFe Experience", q:"Describe your Agile or SAFe experience",
    a:`I hold a SAFe 6.0 Product Owner/Product Manager certification and practised it daily at KPMG on the Loan IQ product programme. I led all sprint ceremonies ‚Äî planning, reviews, retrospectives, PI Planning ‚Äî for a cross-functional squad. I wrote user stories with clear acceptance criteria, groomed and prioritised the product backlog using RICE and value-vs-risk frameworks, and managed cross-team dependencies across a multi-squad programme. I'm comfortable working in both SAFe and standard Scrum environments.`},
  { icon:"üèÜ", field:"Greatest Achievement", q:"What is your greatest professional achievement?",
    a:`At KPMG, I identified that a critical interest computation process was being handled manually, creating significant rework every sprint. I analysed the root cause, designed an automated product solution with the engineering team, and drove it to delivery ‚Äî saving 30 man-days of effort. Separately, I used impact analysis to build a business case for a set of change requests the client initially rejected, and secured sign-off ‚Äî generating approximately 5% additional business value. Both came from proactively finding problems before they became blockers.`},
  { icon:"üìã", field:"Prioritisation Approach", q:"How do you prioritise a product backlog?",
    a:`I use RICE scoring (Reach, Impact, Confidence, Effort) as a baseline and layer in strategic alignment, regulatory requirements, and user pain severity. I always involve the engineering lead in effort estimation to keep prioritisation grounded in reality. On Loan IQ, I also factored in hard compliance deadlines as non-negotiable constraints. I hold regular backlog refinement sessions to ensure the top of the backlog is always 2‚Äì3 sprints ahead in detail, and I use sprint reviews to re-calibrate priorities based on real user and stakeholder feedback.`},
  { icon:"ü§ù", field:"Influencing Without Authority", q:"Describe a time you influenced stakeholders without authority",
    a:`At KPMG, a set of product change requests were blocked by the client's steering committee who saw them as scope creep. Rather than escalating, I prepared a concise impact analysis mapping each change to a specific business risk or missed revenue opportunity ‚Äî in their language, not technical language. I presented it in a working session directly to their finance leads. Every change request was approved, contributing ~5% to the programme's business value. The key was reframing technical decisions as business outcomes the stakeholders already cared about.`},
  { icon:"üí∞", field:"Salary Expectations", q:"What are your salary expectations?",
    a:`Based on my 5+ years of experience, SAFe 6.0 certification, and the Singapore market for senior Product Owners and PMs in fintech, I'm targeting S$10,000‚Äì13,000/month. I'm happy to discuss the full package including equity, performance bonus, and learning budget.`},
  { icon:"üö™", field:"Why Leaving / Transition", q:"Why are you leaving consulting / why move in-house?",
    a:`I've had a strong run at KPMG and I'm proud of what I built on the Loan IQ programme. The reason I'm moving in-house is simple: I want to own a product roadmap for long enough to see whether my decisions were right. In consulting, you ship and move on. In-house, you live with your choices, learn from real users, and compound your product intuition over time. I want to build, not just deliver ‚Äî and I want to be accountable for the outcomes, not just the outputs.`},
  { icon:"‚ö°", field:"Strengths", q:"What are your key strengths as a Product person?",
    a:`Three things: First, I bridge business and engineering fluently ‚Äî I've sat in both worlds and I know how to translate user problems into engineering requirements without losing meaning. Second, I'm metrics-driven ‚Äî I measure everything I ship against the outcome it was supposed to drive. Third, I influence without authority ‚Äî the best example is getting blocked change requests approved at KPMG by reframing them in stakeholder language, which added ~5% business value to the programme.`}
];

async function openSpeedKit() {
  const company = document.getElementById("kitCompany").value.trim() || "the company";
  const role = document.getElementById("kitRole").value.trim() || "this role";
  document.getElementById("speedKitModal").style.display = "flex";
  document.getElementById("speedKitContent").innerHTML = `<div style="text-align:center;padding:30px;"><span class="spinner spinner-blue" style="width:28px;height:28px;border-width:3px;"></span><div style="margin-top:12px;color:var(--gray-400);">Personalising your answers for ${company}...</div></div>`;
  
  let motivationA = `I'm drawn to ${company} because of the scale and impact of what you're building. My background owning the Loan IQ product backlog at KPMG ‚Äî shipping core banking features used by enterprise banks ‚Äî maps closely to the complexity and domain here. More importantly, I want to transition from delivering for clients to building for users directly, and ${company} is exactly the in-house product environment where I can do that.`;
  try {
    const motData = await callBackend('/api/speed-kit', { company, role }); motivationA = motData.result; 
  } catch(e) {}
  
  const qaWithMotivation = [
    { icon:"üí°", field:"Why This Company", q:"Why do you want to work here?", a: motivationA },
    ...SPEED_KIT_QA
  ];
  
  document.getElementById("speedKitContent").innerHTML = qaWithMotivation.map((item, i) => `
    <div style="border:1.5px solid var(--gray-200);border-radius:10px;margin-bottom:12px;overflow:hidden;">
      <div style="background:var(--gray-50);padding:10px 14px;border-bottom:1px solid var(--gray-200);display:flex;align-items:center;gap:8px;">
        <span style="font-size:15px;">${item.icon}</span>
        <div style="flex:1;">
          <div style="font-weight:700;font-size:12px;color:var(--navy);">${item.field}</div>
          <div style="font-size:11px;color:var(--gray-400);font-style:italic;">"${item.q}"</div>
        </div>
        <button class="btn btn-xs btn-secondary" onclick="copySpeedAns('ska${i}')">üìã Copy</button>
      </div>
      <div id="ska${i}" style="padding:12px 14px;font-size:13px;line-height:1.65;color:var(--gray-700);">${item.a}</div>
    </div>`).join("");
  toast("Speed kit ready! Copy answers and apply in under 3 mins üöÄ", "success");
}
function copySpeedAns(id) {
  navigator.clipboard.writeText(document.getElementById(id).textContent).then(()=>toast("Copied to clipboard! üìã","success"));
}

// ========== AUTO-APPLY COMMAND CENTRE ==========
const TARGET_COMPANIES = [
  {name:"Grab",url:"https://grab.careers"},{name:"Sea Limited",url:"https://careers.sea.com"},{name:"Shopee",url:"https://careers.shopee.sg"},
  {name:"DBS Bank",url:"https://www.dbs.com/careers"},{name:"GovTech",url:"https://careers.govtech.gov.sg"},{name:"Stripe",url:"https://stripe.com/jobs"},
  {name:"Airwallex",url:"https://www.airwallex.com/careers"},{name:"Nium",url:"https://www.nium.com/company/careers"},{name:"PropertyGuru",url:"https://www.propertyguru.com.sg/careers"},
  {name:"Carousell",url:"https://careers.carousell.com"},{name:"Circles.Life",url:"https://www.circles.life/sg/careers"},{name:"OCBC",url:"https://www.ocbc.com/careers"},
  {name:"Singtel",url:"https://careers.singtel.com"},{name:"Funding Societies",url:"https://fundingsocieties.com/careers"},{name:"Aspire",url:"https://aspire.io/careers"}
];

function renderTargetCompanies() {
  const role = document.getElementById("searchRoleType")?.value || "Product Owner";
  const productCos = [
    {name:"Grab",tag:"Super App",url:"https://grab.careers"},
    {name:"Sea / Shopee",tag:"E-commerce",url:"https://careers.sea.com"},
    {name:"Airwallex",tag:"Fintech",url:"https://www.airwallex.com/careers"},
    {name:"Nium",tag:"Payments",url:"https://www.nium.com/company/careers"},
    {name:"Stripe",tag:"Payments",url:"https://stripe.com/jobs"},
    {name:"GovTech",tag:"Gov Product",url:"https://careers.govtech.gov.sg"},
    {name:"Carousell",tag:"Marketplace",url:"https://careers.carousell.com"},
    {name:"PropertyGuru",tag:"PropTech",url:"https://www.propertyguru.com.sg/careers"},
    {name:"Funding Societies",tag:"Fintech",url:"https://fundingsocieties.com/careers"},
    {name:"Aspire",tag:"B2B Fintech",url:"https://aspire.io/careers"},
    {name:"Circles.Life",tag:"Telecom",url:"https://www.circles.life/sg/careers"},
    {name:"DBS / digibank",tag:"Banking",url:"https://www.dbs.com/careers"},
    {name:"Lazada",tag:"E-commerce",url:"https://careers.lazada.sg"},
    {name:"TikTok SG",tag:"Tech",url:"https://careers.tiktok.com"},
    {name:"Singtel",tag:"Telco",url:"https://careers.singtel.com"}
  ];
  document.getElementById("targetCompanies").innerHTML = productCos.map(c => 
    `<a class="company-chip" href="https://www.linkedin.com/jobs/search/?keywords=${encodeURIComponent(role + " " + c.tag)}&location=Singapore" target="_blank" rel="noopener" title="Search ${role} at ${c.name}">
      üè¢ ${c.name} <span style="opacity:0.6;font-size:10px;">${c.tag}</span>
    </a>`).join("");
}

function launchJobSearch() {
  const role = document.getElementById("searchRoleType").value;
  const loc = document.getElementById("searchLocation").value || "Singapore";
  const exp = document.getElementById("searchExp").value;
  const salMin = document.getElementById("searchSalMin").value || "";
  const kw = document.getElementById("searchKeywords").value;
  const q = encodeURIComponent([role, kw, exp, "Singapore"].filter(Boolean).join(" "));
  
  const boards = [
    `https://www.linkedin.com/jobs/search/?keywords=${q}&location=${encodeURIComponent(loc)}&f_E=4`,
    `https://sg.indeed.com/jobs?q=${q}&l=${encodeURIComponent(loc)}`,
    `https://www.glassdoor.sg/Job/singapore-${encodeURIComponent(role.toLowerCase())}-jobs-SRCH_IL.0,9_IC3235921_KO10,${10+role.length}.htm`,
    `https://nodeflair.com/jobs?query=${q}`,
    `https://www.jobstreet.com.sg/${encodeURIComponent(role.toLowerCase().replace(/ /g,"-"))}-jobs`
  ];
  
  boards.forEach(url => window.open(url, "_blank"));
  toast("Opening all job boards!", "success");
}

function openBoard(board) {
  const role = document.getElementById("searchRoleType")?.value || "Business Analyst";
  const q = encodeURIComponent(role + " Singapore");
  const urls = {
    linkedin: `https://www.linkedin.com/jobs/search/?keywords=${q}&location=Singapore`,
    indeed: `https://sg.indeed.com/jobs?q=${q}&l=Singapore`,
    glassdoor: `https://www.glassdoor.sg/Job/singapore-jobs-SRCH_IL.0,9_IC3235921.htm`,
    nodeflair: `https://nodeflair.com/jobs?query=${q}`,
    jobstreet: `https://www.jobstreet.com.sg/jobs?q=${encodeURIComponent(role)}&l=Singapore`
  };
  if (urls[board]) window.open(urls[board], "_blank");
}

// Application Kit Generator
let kitData = { company:"", role:"", roleType:"", jd:"" };

async function generateFullKit() {
  const company = document.getElementById("kitCompany").value.trim();
  const role = document.getElementById("kitRole").value.trim();
  const roleType = document.getElementById("kitRoleType").value;
  const jd = document.getElementById("kitJD").value.trim();
  if (!company || !role) { toast("Please enter Company and Role", "error"); return; }
  kitData = { company, role, roleType, jd };
  const btn = document.getElementById("kitBtn");
  btn.innerHTML = '<span class="spinner"></span> Generating...';
  btn.disabled = true;
  document.getElementById("kitOutputSection").style.display = "block";
  ["kitResume","kitCover","kitPrep"].forEach(id => { document.getElementById(id).textContent = "Generating..."; });
  try {
    const data = await callBackend("/api/full-kit", { company, role, roleType, jd });
    document.getElementById("kitResume").textContent = data.resume;
    document.getElementById("kitCover").textContent = data.cover;
    document.getElementById("kitPrep").textContent = data.prep;
    const { score } = analyzeKeywords(jd || role, roleType);
    const scoreEl = document.getElementById("kitKwScore");
    scoreEl.textContent = `${score}/100`;
    scoreEl.className = `score-badge ${score>=70?"score-high":score>=40?"score-mid":"score-low"}`;
    toast("Full application kit ready! üéâ", "success");
  } catch(e) {
    document.getElementById("kitResume").textContent = "Error: " + e.message;
    toast("Error: " + e.message, "error");
  }
  btn.innerHTML = "‚ö° Generate Full Application Kit";
  btn.disabled = false;
}

function logApplicationFromKit() {
  const company = document.getElementById("kitCompany").value.trim();
  const role = document.getElementById("kitRole").value.trim();
  if (!company || !role) { toast("Generate a kit first", "error"); return; }
  const jobs = getJobs();
  jobs.push({ id:"j"+Date.now(), company, role, roleType: document.getElementById("kitRoleType").value, status:"applied", salary:"", source:"Direct", priority:"High", notes:"Added from Application Kit Generator", url:"", dateApplied: new Date().toISOString(), checklist:{} });
  saveJobs(jobs);
  toast(`${company} logged to tracker! ‚úÖ`, "success");
  incrementGoal();
}

function copyPanel(elId) {
  const el = document.getElementById(elId);
  navigator.clipboard.writeText(el.textContent || el.innerText).then(() => toast("Copied to clipboard! üìã", "success"));
}

// ========== JOB DISCOVERY ==========
let discoveredJobs = [];

async function discoverJobs() {
  const keywords = document.getElementById('discoverKeywords').value.trim();
  const location = document.getElementById('discoverLocation').value.trim();
  const maxDays = parseInt(document.getElementById('discoverMaxDays').value) || 30;
  const platforms = [];
  if (document.getElementById('discPlatIndeed').checked) platforms.push('indeed');
  if (document.getElementById('discPlatJobStreet').checked) platforms.push('jobstreet');
  if (document.getElementById('discPlatWorkable').checked) platforms.push('workable');

  if (!keywords) { toast('Enter job title/keywords', 'error'); return; }
  if (!platforms.length) { toast('Select at least one platform', 'error'); return; }

  const btn = document.getElementById('discoverBtn');
  btn.innerHTML = '<span class="spinner"></span> Searching...';
  btn.disabled = true;
  document.getElementById('discoveryProgress').style.display = 'block';
  document.getElementById('discoveryResults').style.display = 'none';
  document.getElementById('discoveryEmpty').style.display = 'none';
  const logEl = document.getElementById('discoveryLog');
  logEl.textContent = '';

  function log(msg) { logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; }

  log(`üîç Searching for "${keywords}" in ${location}...`);
  log(`Platforms: ${platforms.join(', ')} | Max age: ${maxDays} days`);

  try {
    const data = await callBackend('/api/discover-jobs', { keywords, location, maxDays, platforms });
    if (data.error) { log('‚ùå Error: ' + data.error); toast(data.error, 'error'); return; }

    discoveredJobs = data.jobs || [];
    log(`‚úÖ Found ${discoveredJobs.length} jobs total`);
    if (data.details) {
      Object.entries(data.details).forEach(([p, info]) => {
        log(`  ${p}: ${info.count || 0} jobs${info.error ? ' (‚ö† ' + info.error + ')' : ''}`);
      });
    }

    if (discoveredJobs.length === 0) {
      document.getElementById('discoveryEmpty').style.display = 'block';
      toast('No jobs found. Try different keywords.', 'warning');
      return;
    }

    // Sort by AI score descending
    discoveredJobs.sort((a, b) => (b.aiScore || 0) - (a.aiScore || 0));
    renderDiscoveryResults();
    toast(`Found ${discoveredJobs.length} jobs!`, 'success');
  } catch (e) {
    log('‚ùå Error: ' + e.message);
    toast('Search failed: ' + e.message, 'error');
  } finally {
    btn.innerHTML = 'üîç Search All Platforms';
    btn.disabled = false;
  }
}

function renderDiscoveryResults() {
  document.getElementById('discoveryResults').style.display = 'block';
  document.getElementById('discoveryEmpty').style.display = 'none';
  document.getElementById('discoveryCount').textContent = `(${discoveredJobs.length} results)`;
  const el = document.getElementById('discoveryList');
  el.innerHTML = discoveredJobs.map((j, i) => {
    const score = j.aiScore || 0;
    const scoreClass = score >= 7 ? 'score-high' : score >= 5 ? 'score-mid' : 'score-low';
    const scoreText = score ? `<span class="score-badge ${scoreClass}">${score}/10</span>` : '<span style="font-size:11px;color:var(--gray-400);">‚Äî</span>';
    const labels = { 'üî• Strong Match': '#dcfce7', '‚úÖ Good Fit': '#dbeafe', 'üü° Possible': '#fef3c7', '‚ùå Weak Fit': '#fee2e2' };
    const labelBg = labels[j.aiLabel] || '#f3f4f6';
    const daysAgo = j.postedDaysAgo != null ? `${j.postedDaysAgo}d ago` : '';
    return `<div class="card" style="margin-bottom:8px;padding:12px 16px;display:grid;grid-template-columns:30px 1fr auto auto auto auto;align-items:center;gap:12px;">
      <input type="checkbox" class="disc-check" data-idx="${i}" checked>
      <div>
        <div style="font-weight:700;font-size:13px;color:var(--navy);">${j.company || 'Unknown'}</div>
        <div style="font-size:12px;color:var(--gray-600);margin-top:2px;">${j.role || j.title || ''}</div>
        <div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;">
          <span style="font-size:10px;background:#f3f4f6;border-radius:99px;padding:1px 8px;color:var(--gray-500);">${j.platform || ''}</span>
          ${daysAgo ? `<span style="font-size:10px;color:var(--gray-400);">${daysAgo}</span>` : ''}
          ${j.location ? `<span style="font-size:10px;color:var(--gray-400);">üìç ${j.location}</span>` : ''}
        </div>
      </div>
      <div>${scoreText}</div>
      <div style="font-size:11px;"><span style="background:${labelBg};padding:2px 8px;border-radius:99px;">${j.aiLabel || ''}</span></div>
      <div style="font-size:11px;color:var(--gray-500);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(j.aiReason || '').replace(/"/g, '&quot;')}">${j.aiReason || ''}</div>
      <div style="display:flex;gap:4px;">
        ${j.url ? `<a href="${j.url}" target="_blank" class="btn btn-xs btn-primary" style="text-decoration:none;">üîó</a>` : ''}
      </div>
    </div>`;
  }).join('');
}

function importSelectedDiscoveries() {
  const checks = document.querySelectorAll('.disc-check:checked');
  if (!checks.length) { toast('No jobs selected', 'error'); return; }
  const jobs = getJobs();
  const existingUrls = new Set(jobs.map(j => (j.url || '').split('?')[0]).filter(Boolean));
  let added = 0;
  checks.forEach(cb => {
    const idx = parseInt(cb.dataset.idx);
    const dj = discoveredJobs[idx];
    if (!dj) return;
    const cleanUrl = (dj.url || '').split('?')[0];
    if (cleanUrl && existingUrls.has(cleanUrl)) return;
    jobs.push({
      id: Date.now() + added,
      company: dj.company || 'Unknown',
      role: dj.role || dj.title || 'Unknown',
      roleType: dj.roleType || 'Business Analyst',
      status: 'wishlist',
      url: dj.url || '',
      jd: dj.jd || dj.description || '',
      source: dj.platform || 'Discovery',
      dateApplied: new Date().toISOString(),
      salary: '',
      notes: `AI Score: ${dj.aiScore || '?'}/10 ‚Äî ${dj.aiLabel || ''}\n${dj.aiReason || ''}`,
      aiScore: dj.aiScore,
      aiLabel: dj.aiLabel,
      aiReason: dj.aiReason,
      aiPriority: dj.aiPriority,
      isDemo: false
    });
    if (cleanUrl) existingUrls.add(cleanUrl);
    added++;
  });
  saveJobs(jobs);
  renderKanban(); updateStats();
  toast(`Imported ${added} jobs to tracker!`, 'success');
}

function importAllDiscoveries() {
  document.querySelectorAll('.disc-check').forEach(cb => cb.checked = true);
  importSelectedDiscoveries();
}

// ========== BULK AUTO-APPLY ==========
async function bulkAutoApply() {
  const jobs = getJobs().filter(j => !j.isDemo);
  // Find jobs with JD and score >= 5 that don't have docs yet
  const eligible = jobs.filter(j =>
    j.jd && j.jd.length > 50 &&
    (j.aiScore === undefined || j.aiScore === null || j.aiScore >= 5) &&
    !j.resume_docx_b64
  );

  if (eligible.length === 0) {
    toast('No eligible jobs to generate docs for. Need JD + AI Score >= 5 + no existing docs.', 'warning');
    return;
  }

  // Show confirmation modal
  const html = `<div class="modal-overlay" id="bulkApplyModal" style="display:flex;z-index:9999;" onclick="if(event.target===this)this.remove()">
    <div class="modal" style="max-width:600px;">
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
      <div class="modal-title">‚ö° Bulk Auto-Apply</div>
      <p style="font-size:13px;color:var(--gray-600);margin-bottom:16px;">
        Generate tailored resume & cover letter for <strong>${eligible.length}</strong> eligible jobs.
        Each job will get a customised .docx resume and cover letter based on its JD.
      </p>
      <div style="max-height:300px;overflow-y:auto;margin-bottom:16px;">
        ${eligible.map((j, i) => `
          <label style="display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;cursor:pointer;${i%2===0?'background:var(--gray-50);':''}">
            <input type="checkbox" class="bulk-check" data-id="${j.id}" checked>
            <div>
              <div style="font-weight:600;font-size:12px;">${j.company}</div>
              <div style="font-size:11px;color:var(--gray-500);">${j.role} ${j.aiScore ? '¬∑ '+j.aiScore+'/10' : ''}</div>
            </div>
          </label>
        `).join('')}
      </div>
      <div id="bulkApplyProgress" style="display:none;background:#1e1b4b;border-radius:8px;padding:10px 12px;margin-bottom:12px;">
        <pre id="bulkApplyLog" style="color:#e0e7ff;font-size:11px;font-family:monospace;margin:0;white-space:pre-wrap;max-height:120px;overflow-y:auto;"></pre>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary" id="bulkApplyGoBtn" onclick="executeBulkApply()">‚ö° Generate Docs for Selected</button>
        <button class="btn btn-ghost" onclick="document.getElementById('bulkApplyModal').remove()">Cancel</button>
      </div>
    </div>
  </div>`;
  const el = document.createElement('div');
  el.innerHTML = html;
  document.body.appendChild(el.firstChild);
}

async function executeBulkApply() {
  const checks = document.querySelectorAll('.bulk-check:checked');
  if (!checks.length) { toast('No jobs selected', 'error'); return; }

  const selectedIds = Array.from(checks).map(c => c.dataset.id);
  const allJobs = getJobs();
  const selectedJobs = allJobs.filter(j => selectedIds.includes(String(j.id)));

  const btn = document.getElementById('bulkApplyGoBtn');
  btn.innerHTML = '<span class="spinner"></span> Generating...';
  btn.disabled = true;
  document.getElementById('bulkApplyProgress').style.display = 'block';
  const logEl = document.getElementById('bulkApplyLog');
  logEl.textContent = `‚ö° Generating docs for ${selectedJobs.length} jobs...\n`;

  try {
    const data = await callBackend('/api/bulk-apply', {
      jobIds: selectedIds,
      jobs: selectedJobs
    });

    if (data.error) { logEl.textContent += '‚ùå ' + data.error; return; }

    // Update localStorage with generated docs
    const jobs = getJobs();
    let updated = 0;
    (data.results || []).forEach(r => {
      if (r.status === 'generated') {
        const job = jobs.find(j => String(j.id) === String(r.id));
        if (job) {
          job.resume_docx_b64 = r.resume_docx_b64;
          job.cover_docx_b64 = r.cover_docx_b64;
          job.resume_variant = r.resume_variant;
          job.resume_filename = r.resume_filename;
          job.cover_filename = r.cover_filename;
          job.resume_generated_at = new Date().toISOString();
          updated++;
        }
        logEl.textContent += `‚úÖ ${r.resume_filename}\n`;
      } else if (r.status === 'skipped') {
        logEl.textContent += `‚è≠ Skipped (${r.reason})\n`;
      } else {
        logEl.textContent += `‚ùå Error: ${r.reason || 'Unknown'}\n`;
      }
    });

    saveJobs(jobs);
    logEl.textContent += `\nüéâ Done: ${data.generated} generated, ${data.skipped} skipped, ${data.errors} errors`;
    toast(`Bulk apply complete: ${data.generated} docs generated!`, 'success');
  } catch (e) {
    logEl.textContent += '‚ùå ' + e.message;
    toast('Bulk apply failed: ' + e.message, 'error');
  } finally {
    btn.innerHTML = '‚ö° Generate Docs for Selected';
    btn.disabled = false;
  }
}

// ========== UTILITIES ==========
function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }

function downloadOutput(elId, filename) {
  const text = document.getElementById(elId).textContent;
  if (!text.trim()) { toast("Nothing to download", "error"); return; }
  const blob = new Blob([text], {type:"text/plain"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  toast("Downloaded!", "success");
}

// Close modals on overlay click
document.querySelectorAll(".modal-overlay").forEach(overlay => {
  overlay.addEventListener("click", e => { if (e.target === overlay) overlay.style.display = "none"; });
});

// ========== INIT ==========
(async () => {
  // Load from Supabase first ‚Äî it's the source of truth
  const loadResult = await loadJobsFromSupabase();

  // If nothing in cloud and nothing local, skip demo jobs
  // (user will import fresh from LinkedIn)
  initSampleJobs();

  renderKanban();
  updateStats();
  renderAnalytics();
  renderTargetCompanies();
  updateDbStatusLine(loadResult);
  checkHashImport();

  // Show appropriate toast
  if (loadResult.source === 'supabase' && loadResult.count > 0) {
    toast(`‚òÅÔ∏è Loaded ${loadResult.count} jobs from cloud`, 'success');
  } else if (loadResult.source === 'empty') {
    toast('‚òÅÔ∏è Cloud DB connected ‚Äî import your LinkedIn jobs to get started!', 'success');
  }

  // Auto-rank jobs that have JDs but no score yet
  setTimeout(async () => {
    const unscored = getJobs().filter(j => !j.isDemo && j.jd && j.jd.length > 50 && j.aiScore == null);
    if (!unscored.length) return;
    try {
      const payload = unscored.map(j => ({ id: j.id, role: j.role, company: j.company, roleType: j.roleType || '', jd: j.jd }));
      const data = await callBackend('/api/rank-jobs', { jobs: payload });
      if (!data.rankings) return;
      const jobs = getJobs();
      data.rankings.forEach(r => {
        const job = jobs.find(j => String(j.id) === String(r.id));
        if (job) { job.aiScore = r.score; job.aiLabel = r.label; job.aiReason = r.reason; job.aiPriority = r.priority; }
      });
      saveJobs(jobs);
      renderKanban();
      updateDbStatusLine({ source: 'supabase' });
      toast(`üèÜ AI scored ${data.rankings.length} jobs`, 'success');
    } catch(e) { /* silent */ }
  }, 3000);
})();

// Set daily goal from storage
const savedGoal = localStorage.getItem("dailyGoalTarget");
if (savedGoal) document.getElementById("dailyGoalTarget").value = savedGoal;
document.getElementById("dailyGoalTarget").addEventListener("change", function() { localStorage.setItem("dailyGoalTarget", this.value); updateGoalDisplay(); });

// API handled server-side ‚Äî no client key needed

// ‚îÄ‚îÄ‚îÄ BOOKMARKLET SETUP v2 ‚Äî pure client-side, no server storage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// The bookmarklet encodes scraped jobs as base64 in the URL hash.
// The tracker reads the hash on load and saves directly to localStorage.
// This bypasses Render cold-start timeouts and ephemeral filesystem entirely.

function copyBookmarklet() {
  var appUrl = window.location.origin;

  // ‚îÄ‚îÄ Build the bookmarklet code string ‚îÄ‚îÄ
  // Uses template to inject appUrl at build time.
  // The bookmarklet runs on LinkedIn, encodes jobs as base64 in the URL hash,
  // then navigates (or opens) the tracker which reads the hash on load.

  var code = 'javascript:(function(){' +

    // ‚îÄ‚îÄ Prevent double-run ‚îÄ‚îÄ
    'if(window.__jtRunning){alert("Already running ‚Äî please wait.");return;}' +
    'window.__jtRunning=true;' +

    'var u=location.href;' +

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BULK MODE ‚Äî linkedin.com/my-items/saved-jobs/
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    'if(u.indexOf("my-items")>-1||u.indexOf("saved-jobs")>-1){' +

      // Overlay UI
      'var ov=document.createElement("div");' +
      'ov.id="jt-overlay";' +
      'ov.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:2147483647;display:flex;align-items:center;justify-content:center;font-family:-apple-system,BlinkMacSystemFont,sans-serif;";' +
      'ov.innerHTML=\'<div style="background:#fff;border-radius:16px;padding:28px 36px;max-width:400px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3);">\' +' +
        '\'<div style="font-size:36px;margin-bottom:10px;">üîç</div>\' +' +
        '\'<div style="font-weight:700;color:#0a66c2;font-size:17px;margin-bottom:8px;">LinkedIn Job Importer</div>\' +' +
        '\'<div id="jt-msg" style="font-size:13px;color:#444;margin-bottom:14px;min-height:18px;">Initialising...</div>\' +' +
        '\'<div style="background:#e8f0fe;border-radius:8px;height:10px;overflow:hidden;margin-bottom:10px;">\' +' +
          '\'<div id="jt-bar" style="background:linear-gradient(90deg,#0a66c2,#0d8fe6);height:100%;width:3%;transition:width 0.4s;border-radius:8px;"></div>\' +' +
        '\'</div>\' +' +
        '\'<div id="jt-count" style="font-size:12px;color:#888;">0 jobs found</div>\' +' +
        '\'<button id="jt-cancel" style="margin-top:14px;padding:6px 18px;border:1px solid #ccc;border-radius:6px;cursor:pointer;font-size:12px;background:#f5f5f5;">Cancel</button>\' +' +
      '\'</div>\';' +
      'document.body.appendChild(ov);' +
      'var msg=document.getElementById("jt-msg"),bar=document.getElementById("jt-bar"),cnt=document.getElementById("jt-count");' +
      'var cancelled=false;' +
      'document.getElementById("jt-cancel").onclick=function(){cancelled=true;ov.remove();window.__jtRunning=false;};' +

      // Helper: sleep
      'function sleep(ms){return new Promise(function(r){setTimeout(r,ms);});}' +

      // Helper: scrape visible job cards using multiple selector strategies
      'function scrapeCards(seen){' +
        'var jobs=[];' +
        // Strategy 1: data-chameleon-result-urn (older LinkedIn)
        'var cards=Array.from(document.querySelectorAll("[data-chameleon-result-urn]"));' +
        // Strategy 2: job card list items (newer LinkedIn 2024-2025)
        'if(!cards.length) cards=Array.from(document.querySelectorAll("li.scaffold-layout__list-item,li[class*=jobs-saved-jobs__list-item],li[class*=job-card-container],.job-card-container,.jobs-job-board-list__item"));' +
        // Strategy 3: any li with a jobs/view link
        'if(!cards.length){var allLi=document.querySelectorAll("li");cards=[];allLi.forEach(function(li){if(li.querySelector("a[href*=\'/jobs/view/\']"))cards.push(li);});}' +
        'cards.forEach(function(card){' +
          'var a=card.querySelector("a[href*=\'/jobs/view/\']");if(!a)return;' +
          'var href=a.href.split("?")[0].split("#")[0];' +
          'if(!href||seen[href])return;seen[href]=true;' +
          // Extract title ‚Äî try multiple selectors
          'var t="";' +
          'var tEls=card.querySelectorAll("[class*=job-card-list__title],[class*=job-card__title],strong,[class*=base-search-card__title],h3,h4");' +
          'for(var i=0;i<tEls.length;i++){var tx=(tEls[i].innerText||"").trim();if(tx.length>2&&tx.length<200){t=tx;break;}}' +
          'if(!t){var lines=card.innerText.trim().split("\\n").map(function(l){return l.trim();}).filter(function(l){return l.length>2&&l.length<150;});t=lines[0]||"";}' +
          // Extract company
          'var c="Unknown";' +
          'var cEls=card.querySelectorAll("[class*=job-card-container__primary-description],[class*=job-card-list__company-name],[class*=subtitle],[class*=company]");' +
          'for(var i=0;i<cEls.length;i++){var cx=(cEls[i].innerText||"").trim();if(cx.length>1&&cx.length<100&&cx!==t){c=cx;break;}}' +
          'if(c==="Unknown"){var lines2=card.innerText.trim().split("\\n").map(function(l){return l.trim();}).filter(function(l){return l.length>1&&l.length<100&&l!==t&&["Verified","Posted","applicant","ago","Save","Saved","Easy"].every(function(x){return l.indexOf(x)===-1;});});if(lines2[1])c=lines2[1];}' +
          'var liMatch=href.match(/\\/jobs\\/view\\/(\\d+)/);var liId=liMatch?"li_"+liMatch[1]:"";' +
          'if(t.length>1)jobs.push({role:t,company:c,url:href,linkedInId:liId,source:"LinkedIn",status:"saved",roleType:"Business Analyst",dateApplied:new Date().toISOString(),jd:""});' +
        '});' +
        'return jobs;' +
      '}' +

      // Helper: find next page button
      'function getNextBtn(){' +
        'var btns=Array.from(document.querySelectorAll("button[aria-label*=\'Next\'],button[aria-label*=\'next\'],li[class*=pagination] button:last-child,.artdeco-pagination__button--next"));' +
        'for(var i=0;i<btns.length;i++){if(!btns[i].disabled&&!btns[i].getAttribute("disabled"))return btns[i];}' +
        // fallback: any non-disabled button/link with text "Next"
        'var all=document.querySelectorAll("button,a[role=\'button\']");' +
        'for(var i=0;i<all.length;i++){var txt=(all[i].innerText||all[i].getAttribute("aria-label")||"").trim();if((txt.toLowerCase()==="next"||txt.toLowerCase()==="next page")&&!all[i].disabled)return all[i];}' +
        'return null;' +
      '}' +

      // Scroll + scrape loop
      'var allSeen={},allJobs=[],page=1;' +
      '(async function(){' +
        'while(!cancelled){' +
          'msg.textContent="Page "+page+": scrolling & scanning...";' +
          // Scroll down to trigger lazy loading
          'for(var s=0;s<8;s++){window.scrollBy(0,600);await sleep(350);}' +
          'window.scrollTo(0,0);await sleep(400);' +
          'var fresh=scrapeCards(allSeen);allJobs=allJobs.concat(fresh);' +
          'cnt.textContent=allJobs.length+" jobs found";' +
          'bar.style.width=Math.min(60,4+page*7)+"%";' +
          'var nb=getNextBtn();' +
          'if(!nb){msg.textContent="All pages scanned ("+allJobs.length+" jobs)";break;}' +
          'if(page>=30){msg.textContent="Limit reached (30 pages)";break;}' +
          'msg.textContent="Page "+page+" done ("+allJobs.length+" total) ‚Äî next page...";' +
          'nb.click();await sleep(2800);window.scrollTo(0,0);await sleep(800);' +
          'page++;' +
        '}' +
        'if(cancelled)return;' +
        'if(!allJobs.length){' +
          'ov.remove();window.__jtRunning=false;' +
          'alert("No saved jobs found!\\n\\nMake sure you are on:\\nhttps://www.linkedin.com/my-items/saved-jobs/\\n\\nAnd that the page is fully loaded.");' +
          'return;' +
        '}' +
        // Encode and open tracker
        'bar.style.width="90%";msg.textContent="Preparing "+allJobs.length+" jobs for import...";' +
        'await sleep(500);' +
        'try{' +
          'var enc=btoa(unescape(encodeURIComponent(JSON.stringify(allJobs))));' +
          'ov.remove();window.__jtRunning=false;' +
          'location.href="' + appUrl + '/#bm:"+enc;' +
        '}catch(encErr){' +
          'ov.remove();window.__jtRunning=false;' +
          'alert("Encoding error: "+encErr.message);' +
        '}' +
      '})();' +
      'return;' +
    '}' + // end bulk mode

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SINGLE JOB MODE ‚Äî linkedin.com/jobs/view/...
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    'var t="",c="",jd="";' +

    // Title from page title first
    'var pt=document.title.replace(/\\s*[|]\\s*LinkedIn.*/i,"").replace(/\\s*-\\s*LinkedIn.*/i,"").trim();' +
    'var ai=pt.lastIndexOf(" at ");' +
    'if(ai>-1){t=pt.substring(0,ai).trim();c=pt.substring(ai+4).trim();}else{t=pt.trim();}' +

    // Try DOM selectors for title (more reliable than page title)
    'var titleSels=["h1[class*=job-details-jobs-unified-top-card__job-title]","h1[class*=job-title]",".job-details-jobs-unified-top-card__job-title h1","h1.t-24","h1"];' +
    'for(var i=0;i<titleSels.length;i++){var el=document.querySelector(titleSels[i]);if(el&&(el.innerText||"").trim().length>2){t=(el.innerText||"").trim();break;}}' +

    // Try DOM selectors for company
    'var companySels=["[class*=job-details-jobs-unified-top-card__company-name] a","[class*=job-details-jobs-unified-top-card__company-name]","[class*=topcard__org-name-link]","[class*=jobs-unified-top-card__company-name]","a[class*=company]"];' +
    'for(var i=0;i<companySels.length;i++){var el=document.querySelector(companySels[i]);if(el&&(el.innerText||"").trim().length>1){c=(el.innerText||"").trim();break;}}' +

    // Try DOM selectors for job description
    'var jdSels=["#job-details","[class*=jobs-description__content]","[class*=description__content]","[class*=jobs-box__html-content]","[class*=description]"];' +
    'for(var i=0;i<jdSels.length;i++){var el=document.querySelector(jdSels[i]);if(el&&(el.innerText||"").trim().length>50){jd=(el.innerText||"").trim().substring(0,4000);break;}}' +

    'if(!t||t.length<2){alert("Could not detect job title.\\n\\nPlease make sure:\\n1. The job page is fully loaded\\n2. You are on a LinkedIn job details page (linkedin.com/jobs/view/...)");window.__jtRunning=false;return;}' +

    'if(!confirm("üìå Add to Job Tracker?\\n\\nRole: "+t+"\\nCompany: "+(c||"Unknown")+"\\n\\n"+(jd?"‚úÖ Job description captured ("+jd.length+" chars)":"‚ö†Ô∏è No job description found\\n   Tip: Click the job first to expand the full description"))){window.__jtRunning=false;return;}' +

    'try{' +
      'var cleanU=u.split("?")[0].split("#")[0];' +
      'var liM=cleanU.match(/\\/jobs\\/view\\/(\\d+)/);var liId=liM?"li_"+liM[1]:"";' +
      'var single=[{role:t,company:c||"Unknown",url:cleanU,linkedInId:liId,jd:jd,source:"LinkedIn",status:"saved",roleType:"Business Analyst",dateApplied:new Date().toISOString()}];' +
      'var enc=btoa(unescape(encodeURIComponent(JSON.stringify(single))));' +
      'location.href="' + appUrl + '/#bm:"+enc;' +
    '}catch(e){alert("Error: "+e.message);}' +
    'window.__jtRunning=false;' +

  '})();';  // Note: NOT async IIFE for compat ‚Äî async is used only inside bulk mode

  var box = document.getElementById('bookmarkletBox');
  if (box) { box.value = code; }

  // Also set the draggable link href
  var link = document.getElementById('bookmarkletLink');
  if (link) { link.href = code; link.setAttribute('title', 'Drag to bookmarks bar ‚Äî or right-click > Bookmark this link'); }

  // Also update the always-visible drag button in tab3 banner
  var dragBtn = document.getElementById('bookmarkletDragBtn');
  if (dragBtn) { dragBtn.href = code; dragBtn.setAttribute('title', 'Drag to bookmarks bar!'); }

  // Store the code for clipboard copy
  window.__bookmarkletCode = code;
}

function copyBookmarkletToClipboard() {
  var code = window.__bookmarkletCode;
  if (!code) { copyBookmarklet(); code = window.__bookmarkletCode; }
  if (!code) { alert('Bookmarklet not ready ‚Äî please refresh and try again.'); return; }

  var btn    = document.getElementById('copyBmBtn');
  var status = document.getElementById('copyBmStatus');

  function onSuccess() {
    if (btn)    { btn.textContent = '‚úÖ Copied!'; setTimeout(function(){ btn.textContent = 'üìã Copy Bookmarklet'; }, 3000); }
    if (status) { status.textContent = '‚úÖ Copied! Now right-click your bookmarks bar ‚Üí Add bookmark ‚Üí paste as the URL'; }
  }

  if (navigator.clipboard) {
    navigator.clipboard.writeText(code).then(onSuccess).catch(function() { fallbackCopy(code, onSuccess); });
  } else { fallbackCopy(code, onSuccess); }
}

function fallbackCopy(text, cb) {
  var box = document.getElementById('bookmarkletBox');
  if (box) { box.select(); try { document.execCommand('copy'); if(cb) cb(); } catch(e) { prompt('Copy all of this:', text); } }
  else { prompt('Copy all of this:', text); }
}

function extractLinkedInJobId(url) {
  // LinkedIn job URLs look like: https://www.linkedin.com/jobs/view/4085372910/
  // Extract the numeric job ID as the canonical unique identifier
  if (!url) return null;
  const m = url.match(/\/jobs\/view\/(\d+)/);
  return m ? 'li_' + m[1] : null;
}

function checkHashImport() {
  const hash = window.location.hash;
  if (!hash.startsWith('#bm:')) return;

  history.replaceState(null, '', '/');

  try {
    const encoded = hash.slice(4);
    const json = decodeURIComponent(escape(atob(encoded)));
    const incoming = JSON.parse(json);
    if (!Array.isArray(incoming) || incoming.length === 0) return;

    const tab3btn = document.querySelector('.tab-btn:nth-child(1)');
    if (tab3btn) switchTab('tab3', tab3btn);

    mergeBookmarkletJobs(incoming);
  } catch(e) {
    console.error('Hash import error:', e);
    toast('Import error ‚Äî try again', 'error');
  }
}

async function mergeBookmarkletJobs(incoming) {
  const existing = getJobs();

  // Build dedup sets using LinkedIn job ID as primary key, URL as fallback
  const existingLiIds = new Set();
  const existingUrls  = new Set();

  existing.forEach(j => {
    const liId = extractLinkedInJobId(j.url) || j.linkedInId;
    if (liId) existingLiIds.add(liId);
    const cleanUrl = (j.url || '').split('?')[0].replace(/\/$/, '');
    if (cleanUrl) existingUrls.add(cleanUrl);
  });

  let added = 0;
  const newJobs = [];

  incoming.forEach((j, idx) => {
    const cleanUrl  = (j.url || '').split('?')[0].replace(/\/$/, '');
    const liId      = extractLinkedInJobId(cleanUrl);

    // Primary dedup: LinkedIn numeric job ID
    if (liId && existingLiIds.has(liId)) return;
    // Secondary dedup: exact URL match
    if (cleanUrl && existingUrls.has(cleanUrl)) return;

    // Assign stable ID ‚Äî use LinkedIn job ID if available, else timestamp+index
    const stableId = liId || ('bm_' + Date.now() + '_' + idx + '_' + Math.random().toString(36).slice(2, 5));

    const enriched = {
      ...j,
      id:          stableId,
      linkedInId:  liId || '',
      url:         cleanUrl,
      roleType:    j.roleType    || 'Business Analyst',
      status:      (!j.status || j.status === 'wishlist') ? 'saved' : j.status,
      dateApplied: j.dateApplied || new Date().toISOString(),
      source:      j.source      || 'LinkedIn',
      notes:       j.notes       || '',
      salary:      j.salary      || '',
      checklist:   j.checklist   || {},
      isDemo:      false,
    };

    existing.push(enriched);
    newJobs.push(enriched);
    if (liId) existingLiIds.add(liId);
    if (cleanUrl) existingUrls.add(cleanUrl);
    added++;
  });

  if (added === 0) {
    toast(`‚úÖ All ${incoming.length} jobs already in tracker ‚Äî nothing new.`, 'success');
    return;
  }

  saveJobs(existing);
  renderKanban();
  updateStats();
  renderAnalytics();
  updateDbStatusLine({ source: 'supabase' });
  toast(`üéâ ${added} new job(s) imported! ${incoming.length - added > 0 ? `(${incoming.length - added} duplicates skipped)` : ''}`, 'success');

  // ü§ñ Auto-trigger agent for newly imported jobs
  setTimeout(() => triggerAgentAfterImport(newJobs), 1500);

  // Also rank locally any that already have JDs (faster than waiting for agent)
  setTimeout(() => {
    const toRank = newJobs.filter(j => j.jd && j.jd.length > 50);
    if (toRank.length > 0) {
      callBackend('/api/rank-jobs', { jobs: toRank.map(j => ({ id: j.id, role: j.role, company: j.company, roleType: j.roleType || '', jd: j.jd })) })
        .then(data => {
          if (!data.rankings) return;
          const jobs = getJobs();
          data.rankings.forEach(r => {
            const job = jobs.find(j => String(j.id) === String(r.id));
            if (job) { job.aiScore = r.score; job.aiLabel = r.label; job.aiReason = r.reason; job.aiPriority = r.priority; }
          });
          saveJobs(jobs);
          renderKanban();
          toast(`üèÜ AI scored ${data.rankings.length} new jobs`, 'success');
        }).catch(() => {});
    }
  }, 2000);
}

function checkPendingCount() {}
async function importPendingJobs() {}

// ‚îÄ‚îÄ‚îÄ AGENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function saveAgentConfig() {
  const liEmail    = document.getElementById('cfgLinkedInEmail').value.trim();
  const liPw       = document.getElementById('cfgLinkedInPassword').value.trim();
  const twilioSid  = document.getElementById('cfgTwilioSid').value.trim();
  const twilioTok  = document.getElementById('cfgTwilioToken').value.trim();
  const wPhone     = document.getElementById('cfgWhatsappPhone').value.trim();
  const statusEl   = document.getElementById('cfgSaveResult');

  if (!liEmail && !liPw && !twilioSid && !twilioTok && !wPhone) {
    statusEl.textContent = '‚ö†Ô∏è Nothing to save';
    statusEl.style.color = '#b45309';
    return;
  }

  statusEl.textContent = 'Saving...';
  statusEl.style.color = '#374151';

  const payload = { secret: 'jobhunt2025' };
  if (liEmail)   payload.LINKEDIN_EMAIL    = liEmail;
  if (liPw)      payload.LINKEDIN_PASSWORD = liPw;
  if (twilioSid) payload.TWILIO_ACCOUNT_SID  = twilioSid;
  if (twilioTok) payload.TWILIO_AUTH_TOKEN   = twilioTok;
  if (wPhone)    payload.NOTIFICATION_PHONE  = wPhone;

  try {
    const res = await fetch('/api/settings/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(r => r.json());

    if (res.status === 'ok') {
      statusEl.textContent = '‚úÖ Saved! Click Extract Latest Jobs to test.';
      statusEl.style.color = '#16a34a';
      document.getElementById('cfgLinkedInPassword').value = '';
      document.getElementById('cfgTwilioToken').value = '';
      document.getElementById('cfgLinkedInPassword').placeholder = '‚úÖ Saved';
      document.getElementById('cfgTwilioToken').placeholder = '‚úÖ Saved';
    } else {
      statusEl.textContent = '‚ùå ' + (res.error || 'Save failed');
      statusEl.style.color = '#dc2626';
    }
  } catch(e) {
    statusEl.textContent = '‚ùå Error: ' + e.message;
    statusEl.style.color = '#dc2626';
  }
}

async function loadAgentConfig() {
  try {
    const res = await fetch('/api/settings/load').then(r => r.json());
    if (res.error) return;
    if (res.LINKEDIN_EMAIL)
      document.getElementById('cfgLinkedInEmail').value = res.LINKEDIN_EMAIL;
    if (res.linkedin_pw_set)
      document.getElementById('cfgLinkedInPassword').placeholder = '‚úÖ Saved';
    if (res.TWILIO_ACCOUNT_SID)
      document.getElementById('cfgTwilioSid').value = res.TWILIO_ACCOUNT_SID;
    if (res.twilio_token_set)
      document.getElementById('cfgTwilioToken').placeholder = '‚úÖ Saved';
    if (res.NOTIFICATION_PHONE)
      document.getElementById('cfgWhatsappPhone').value = res.NOTIFICATION_PHONE;
  } catch(e) {}
}

async function extractLatestJobs() {
  const btn  = document.getElementById('extractJobsBtn');
  const wrap = document.getElementById('extractProgressWrap');
  const log  = document.getElementById('extractLog');

  // First check if credentials are saved
  let hasCreds = false;
  try {
    const cfg = await fetch('/api/settings/load').then(r => r.json());
    hasCreds = !!(cfg.LINKEDIN_EMAIL && cfg.linkedin_pw_set);
  } catch(e) {}

  if (!hasCreds) {
    // Open agent panel so user can enter credentials
    openAgentPanel();
    toast('‚ö†Ô∏è Enter your LinkedIn credentials first, then click Extract Latest Jobs again', 'error');
    return;
  }

  btn.disabled = true;
  btn.textContent = '‚è≥ Extracting...';
  wrap.style.display = 'block';
  log.textContent = '';

  const addLog = (msg) => {
    log.textContent += msg + '\n';
    log.scrollTop = log.scrollHeight;
  };

  addLog('‚ñ∂ Starting full pipeline...');
  addLog('üîê Logging into LinkedIn...');
  addLog('üìã Scraping your saved jobs (this takes 3‚Äì8 mins)...');
  addLog('');
  addLog('üí° You can keep using the app while this runs in the background.');
  addLog('üì± You will get a WhatsApp message at +6590256503 when done.');

  try {
    const data = await fetch('/api/agent/full-run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json());

    if (data.error) {
      addLog('‚ùå Error: ' + data.error);
      btn.disabled = false;
      btn.textContent = 'üöÄ Extract Latest Jobs';
      return;
    }

    addLog('');
    addLog('‚úÖ Pipeline started in background:');
    addLog('   Step 1 ‚Üí Scraping LinkedIn saved jobs...');
    addLog('   Step 2 ‚Üí AI scoring each job (1-10 fit score)...');
    addLog('   Step 3 ‚Üí Generating tailored resume + cover letter...');
    addLog('   Step 4 ‚Üí Emailing results to WhatsApp +6590256503');
    toast('üöÄ Extracting jobs ‚Äî email coming when done!', 'success');

    // Poll for new jobs appearing in the tracker
    let pollCount = 0;
    let lastTotal = 0;
    const poll = setInterval(async () => {
      pollCount++;
      try {
        const s = await fetch('/api/agent/status').then(r => r.json());
        const total = s.total || 0;
        const scored = s.scored || 0;
        const docs = s.with_docs || 0;

        if (total !== lastTotal) {
          lastTotal = total;
          addLog(`   üì• ${total} jobs in tracker, ${scored} scored, ${docs} docs ready`);
          const res = await loadJobsFromSupabase();
          if (res && res.count > 0) {
            renderKanban();
            updateStats();
            updateDbStatusLine({ source: 'supabase' });
          }
        }
      } catch(e) {}

      // Stop polling after 12 minutes
      if (pollCount >= 48) {
        clearInterval(poll);
        addLog('');
        addLog('‚è± Check your email for final results!');
        btn.disabled = false;
        btn.textContent = 'üöÄ Extract Latest Jobs';
      }
    }, 15000);

  } catch(e) {
    addLog('‚ùå Error: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'üöÄ Extract Latest Jobs';
  }
}

async function runLinkedInScrape() {
  const btn = document.getElementById('liScrapeBtn');
  const logWrap = document.getElementById('agentLogWrap');
  const logEl   = document.getElementById('agentLog');
  btn.disabled  = true;
  btn.textContent = '‚è≥ Scraping LinkedIn...';
  logWrap.style.display = 'block';
  logEl.textContent = '‚ñ∂ Logging into LinkedIn and scraping saved jobs...\n';

  const log = (msg) => { logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; };

  try {
    const data = await fetch('/api/linkedin/scrape', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ secret: 'jobhunt2025' })
    }).then(r => r.json());

    if (data.error) {
      log('‚ùå ' + data.error);
      toast('LinkedIn scrape error', 'error');
      btn.disabled = false; btn.textContent = 'üîó Scrape LinkedIn Now';
      return;
    }

    log('‚úÖ LinkedIn scrape started in background');
    log('üîê Logging in as configured user...');
    log('üìã Scraping saved jobs from linkedin.com/my-items/saved-jobs/');
    log('ü§ñ Will auto-run AI scoring once jobs are imported');
    log('üì± WhatsApp notification will be sent to +6590256503 when complete');
    log('‚è≥ This takes 3‚Äì10 minutes depending on how many saved jobs you have...');
    toast('üîó LinkedIn scrape running ‚Äî check WhatsApp when done', 'success');

    // Poll for new jobs appearing
    let pollCount = 0;
    const poll = setInterval(async () => {
      pollCount++;
      const s = await fetch('/api/agent/status').then(r => r.json()).catch(() => ({}));
      const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val ?? '‚Äî'; };
      set('agStat_total', s.total); set('agStat_jd', s.with_jd);
      set('agStat_scored', s.scored); set('agStat_docs', s.with_docs);
      if (pollCount % 3 === 0) log(`  üìä Tracker: ${s.total || 0} total jobs, ${s.scored || 0} scored`);
      const res = await loadJobsFromSupabase();
      if (res && res.count > 0) { renderKanban(); updateStats(); }
    }, 15000);

    setTimeout(() => {
      clearInterval(poll);
      log('‚è± Done polling ‚Äî check WhatsApp +6590256503 for results');
      btn.disabled = false; btn.textContent = 'üîó Scrape LinkedIn Now';
    }, 600000); // 10 min timeout
  } catch(e) {
    log('‚ùå Error: ' + e.message);
    toast('Scrape error', 'error');
    btn.disabled = false; btn.textContent = 'üîó Scrape LinkedIn Now';
  }
}

async function openAgentPanel() {
  document.getElementById('agentModal').style.display = 'flex';
  const cronEl = document.getElementById('cronUrlDisplay');
  if (cronEl) cronEl.textContent = `${window.location.origin}/api/agent/cron?secret=jobhunt2025`;
  await refreshAgentStatus();
  loadAgentConfig();
}

async function refreshAgentStatus() {
  try {
    const data = await fetch('/api/agent/status').then(r => r.json());
    const set  = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val ?? '‚Äî'; };
    set('agStat_total', data.total);
    set('agStat_jd',    data.with_jd);
    set('agStat_scored',data.scored);
    set('agStat_docs',  data.with_docs);
  } catch(e) {}
}

async function runAgent(forceAll = false) {
  const btn    = document.getElementById('agentRunBtn');
  const logWrap= document.getElementById('agentLogWrap');
  const logEl  = document.getElementById('agentLog');
  btn.disabled = true;
  btn.textContent = '‚è≥ Agent running‚Ä¶';
  logWrap.style.display = 'block';
  logEl.textContent = '‚ñ∂ Starting agent‚Ä¶\n';

  const log = (msg) => { logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; };

  try {
    const data = await fetch('/api/agent/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ force_all: forceAll })
    }).then(r => r.json());

    if (data.status === 'nothing_to_do') {
      log('‚úÖ All jobs already processed ‚Äî nothing to do!');
      toast('‚úÖ All jobs already up to date', 'success');
      btn.disabled = false; btn.textContent = 'ü§ñ Run Agent Now';
      return;
    }

    log(`‚úÖ Processing ${data.count} jobs in background`);
    log('üì± WhatsApp notification will be sent to +6590256503 when complete');
    log('‚è≥ Polling for progress‚Ä¶');
    toast(`ü§ñ Agent running ‚Äî ${data.count} jobs`, 'success');

    let prev = 0;
    const poll = setInterval(async () => {
      const s = await fetch('/api/agent/status').then(r => r.json()).catch(() => ({}));
      const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val ?? '‚Äî'; };
      set('agStat_total', s.total); set('agStat_jd', s.with_jd);
      set('agStat_scored', s.scored); set('agStat_docs', s.with_docs);
      if ((s.scored || 0) !== prev) {
        log(`  üìä ${s.scored}/${s.total} scored ¬∑ ${s.with_docs} docs ready`);
        prev = s.scored || 0;
        const res = await loadJobsFromSupabase();
        if (res.count > 0) { renderKanban(); updateStats(); updateDbStatusLine({ source: 'supabase' }); }
      }
    }, 10000);

    setTimeout(() => {
      clearInterval(poll);
      log('‚è± Done polling ‚Äî check WhatsApp +6590256503 for full results');
      btn.disabled = false; btn.textContent = 'ü§ñ Run Agent Now';
    }, 300000);
    return;

  } catch(e) {
    log(`‚ùå Error: ${e.message}`);
    toast('Agent error', 'error');
  }
  btn.disabled = false; btn.textContent = 'ü§ñ Run Agent Now';
}

async function testNotifications() {
  const el = document.getElementById('notifTestResult');
  el.textContent = 'Sending‚Ä¶';
  try {
    const d = await fetch('/api/test-notifications', { method: 'POST' }).then(r => r.json());
    el.textContent = `WhatsApp: ${d.whatsapp}`;
  } catch(e) { el.textContent = 'Error ‚Äî check Render logs'; }
}

async function triggerAgentAfterImport(newJobs) {
  if (!newJobs || !newJobs.length) return;
  try {
    await fetch('/api/agent/run-import', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jobs: newJobs })
    });
  } catch(e) {}
}

// Initialise bookmarklet after DOM is ready
(function initBookmarklet() {
  // Run immediately (script is at bottom of body, DOM is ready)
  copyBookmarklet();
  // Also run once more after a short delay to handle any late-rendering
  setTimeout(copyBookmarklet, 800);
})();
// ‚îÄ‚îÄ‚îÄ PROFILE MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _currentProfile = null;
let _profileIsDefault = true;

async function loadCurrentProfile() {
  try {
    const r = await fetch('/api/profile/load');
    const d = await r.json();
    _currentProfile = d.profile;
    _profileIsDefault = d.is_default;
    renderProfileStatus();
    renderProfilePreview();
    // auto-fill autonomous agent keywords from profile headline
    if (_currentProfile && _currentProfile.headline) {
      const kw = document.getElementById('autoAgentKw');
      if (kw && !kw.value) kw.value = _currentProfile.headline.split('|').map(s=>s.trim()).slice(0,2).join(', ');
    }
  } catch(e) {
    console.warn('Profile load error:', e);
  }
}

function renderProfileStatus() {
  const el = document.getElementById('profileStatus');
  if (!el) return;
  if (_profileIsDefault) {
    el.style.background = 'var(--blue-pale)';
    el.style.color = 'var(--blue)';
    el.innerHTML = 'üîµ Using <strong>default profile</strong> (Amretha Karthikeyan). Paste your resume below to set your own profile.';
  } else {
    el.style.background = 'var(--green-pale, #e8faf0)';
    el.style.color = 'var(--green, #059669)';
    el.innerHTML = `üü¢ Using <strong>custom profile</strong>: ${_currentProfile?.name || 'Custom User'}`;
  }
}

function renderProfilePreview() {
  const wrap = document.getElementById('profilePreview');
  const content = document.getElementById('profilePreviewContent');
  if (!wrap || !content || !_currentProfile) { if(wrap) wrap.style.display='none'; return; }
  wrap.style.display = 'block';
  const p = _currentProfile;
  let html = `<strong>${p.name || '‚Äî'}</strong><br>`;
  if (p.headline) html += `<em>${p.headline}</em><br>`;
  if (p.email) html += `üìß ${p.email}`;
  if (p.mobile) html += ` &nbsp;|&nbsp; üì± ${p.mobile}`;
  html += '<br>';
  if (p.linkedin) html += `üîó <a href="${p.linkedin}" target="_blank">LinkedIn</a><br>`;
  if (p.summary) html += `<br><strong>Summary:</strong> ${p.summary.substring(0,200)}...<br>`;
  if (p.skills && p.skills.length) html += `<br><strong>Skills:</strong> ${Array.isArray(p.skills)?p.skills.join(', '):p.skills}<br>`;
  if (p.experience && p.experience.length) html += `<br><strong>Experience:</strong> ${p.experience.length} role(s)<br>`;
  if (p.education && p.education.length) html += `<strong>Education:</strong> ${p.education.length} entry(ies)<br>`;
  content.innerHTML = html;
}

async function parseAndSaveProfile() {
  const txt = document.getElementById('profileResumeText').value.trim();
  if (!txt || txt.length < 50) { showToast('Please paste a meaningful resume (at least 50 characters)','warning'); return; }
  const btn = document.getElementById('profileParseBtn');
  btn.disabled = true; btn.textContent = 'ü§ñ Parsing with AI...';
  try {
    // Step 1: AI parse
    const r1 = await fetch('/api/profile/parse-resume', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ text: txt })
    });
    const d1 = await r1.json();
    if (!d1.success) throw new Error(d1.error || 'Parse failed');
    const profile = d1.profile;
    // Step 2: Save
    btn.textContent = 'üíæ Saving profile...';
    const r2 = await fetch('/api/profile/save', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(profile)
    });
    const d2 = await r2.json();
    if (!d2.success) throw new Error(d2.error || 'Save failed');
    _currentProfile = d2.profile;
    _profileIsDefault = false;
    renderProfileStatus();
    renderProfilePreview();
    showToast('‚úÖ Profile parsed and saved successfully!','success');
    document.getElementById('profileResumeText').value = '';
  } catch(e) {
    showToast('‚ùå ' + e.message,'error');
  } finally {
    btn.disabled = false; btn.textContent = 'ü§ñ AI Parse & Save Profile';
  }
}

async function resetProfile() {
  if (!confirm('Reset to default profile (Amretha)? Your custom profile will be removed.')) return;
  try {
    await fetch('/api/profile/reset', { method: 'POST' });
    await loadCurrentProfile();
    showToast('Profile reset to default','info');
    document.getElementById('profileEditForm').style.display = 'none';
  } catch(e) {
    showToast('Reset error: ' + e.message, 'error');
  }
}

function editProfileManually() {
  const f = document.getElementById('profileEditForm');
  f.style.display = f.style.display === 'none' ? 'block' : 'none';
  if (f.style.display === 'block' && _currentProfile) {
    document.getElementById('profName').value = _currentProfile.name || '';
    document.getElementById('profEmail').value = _currentProfile.email || '';
    document.getElementById('profMobile').value = _currentProfile.mobile || '';
    document.getElementById('profLinkedin').value = _currentProfile.linkedin || '';
    document.getElementById('profHeadline').value = _currentProfile.headline || '';
    document.getElementById('profSummary').value = _currentProfile.summary || '';
    document.getElementById('profSkills').value = Array.isArray(_currentProfile.skills) ? _currentProfile.skills.join(', ') : (_currentProfile.skills||'');
    document.getElementById('profCert').value = _currentProfile.certification || '';
  }
}

async function saveProfileManually() {
  const profile = Object.assign({}, _currentProfile || {}, {
    name: document.getElementById('profName').value.trim(),
    email: document.getElementById('profEmail').value.trim(),
    mobile: document.getElementById('profMobile').value.trim(),
    linkedin: document.getElementById('profLinkedin').value.trim(),
    headline: document.getElementById('profHeadline').value.trim(),
    summary: document.getElementById('profSummary').value.trim(),
    skills: document.getElementById('profSkills').value.split(',').map(s=>s.trim()).filter(Boolean),
    certification: document.getElementById('profCert').value.trim()
  });
  if (!profile.name) { showToast('Name is required','warning'); return; }
  try {
    const r = await fetch('/api/profile/save', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(profile)
    });
    const d = await r.json();
    if (!d.success) throw new Error(d.error || 'Save failed');
    _currentProfile = d.profile;
    _profileIsDefault = false;
    renderProfileStatus();
    renderProfilePreview();
    document.getElementById('profileEditForm').style.display = 'none';
    showToast('‚úÖ Profile saved!','success');
  } catch(e) {
    showToast('Save error: ' + e.message,'error');
  }
}

// ‚îÄ‚îÄ‚îÄ AUTONOMOUS AGENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runAutonomousAgent() {
  const btn = document.getElementById('autoAgentBtn');
  const logWrap = document.getElementById('autoAgentLog');
  const logContent = document.getElementById('autoAgentLogContent');
  btn.disabled = true;
  btn.textContent = '‚è≥ Starting autonomous pipeline...';
  logWrap.style.display = 'block';
  logContent.textContent = '> Initiating autonomous pipeline...\n';

  const platforms = [];
  if (document.getElementById('autoPlatIndeed')?.checked) platforms.push('indeed');
  if (document.getElementById('autoPlatJobStreet')?.checked) platforms.push('jobstreet');
  if (document.getElementById('autoPlatWorkable')?.checked) platforms.push('workable');
  if (document.getElementById('autoPlatLinkedIn')?.checked) platforms.push('linkedin');

  const config = {
    keywords: document.getElementById('autoAgentKw').value.trim() || undefined,
    location: document.getElementById('autoAgentLoc').value.trim() || 'Singapore',
    max_days: parseInt(document.getElementById('autoAgentDays').value) || 30,
    platforms: platforms
  };

  try {
    const r = await fetch('/api/agent/autonomous', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(config)
    });
    const d = await r.json();
    if (d.status === 'started') {
      logContent.textContent += '> Pipeline started in background!\n> Task ID: ' + (d.task_id||'bg') + '\n';
      logContent.textContent += '> Polling for status...\n';
      // Poll agent status
      pollAutonomousStatus(logContent);
    } else {
      logContent.textContent += '> Error: ' + (d.error || JSON.stringify(d)) + '\n';
    }
  } catch(e) {
    logContent.textContent += '> Network error: ' + e.message + '\n';
  } finally {
    btn.disabled = false;
    btn.textContent = 'üöÄ Run Full Autonomous Pipeline';
  }
}

function pollAutonomousStatus(logEl) {
  let polls = 0;
  const maxPolls = 120; // 10 min max
  const interval = setInterval(async () => {
    polls++;
    try {
      const r = await fetch('/api/agent/status');
      const d = await r.json();
      const running = d.running;
      const processed = d.processed || 0;
      const total = d.total || 0;
      logEl.textContent += `> [Poll ${polls}] Running: ${running}, Progress: ${processed}/${total}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      if (!running || polls >= maxPolls) {
        clearInterval(interval);
        logEl.textContent += running ? '> Polling timeout. Agent may still be running.\n' : '> ‚úÖ Pipeline complete!\n';
        // Refresh the jobs table
        if (typeof loadJobs === 'function') loadJobs();
      }
    } catch(e) {
      logEl.textContent += `> Poll error: ${e.message}\n`;
    }
  }, 5000);
}

// Load profile on startup
loadCurrentProfile();

console.log("üöÄ Job Hunt Command Centre loaded!");
</script>
</body>
</html>
